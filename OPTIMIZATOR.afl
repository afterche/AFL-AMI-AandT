//                                                 EMMA...
//                                   ///////////////////////////////
//                               ///////////////////////////////////////
//                            /////////////////////////////////////////////
//                       //////////////////////////////////////////////////////
//                   /////////////////////////////////////////////////////////////
i=EndValue(BarIndex());///номер поcледнего бара
tm=TimeNum();/// масив времени баров
dm=Day(); /// массив дата
///процедура запись в лог файл для тестирования
	FileNameLog="C:/ami/test/logtest.txt";
	procedure save_log(p_string_log)
	{
	Lf = fopen(FileNameLog, "a");
	fputs(Name()+";"+i+";"+dm[i]+";"+tm[i]+";"+p_string_log+"\n",Lf);
	fclose(Lf);
	}

	
////*********************************ОПТИМИЗИРУЕМ СИСТЕМА
////ОПИСАНИЕ: - Входим контртренд добавляемся по тренду плюс профит разный выход
////////////////////////Погнали, это начало оптимизационных циклов
nomber=0; // это номер по порядку для сортировки строк с одинаковыми параметрами
///ЦИКЛЫ
for( i_stop=1; i_stop <16; i_stop =i_stop +1)
{ 
for( ema_exit=150; ema_exit <270; ema_exit=ema_exit+10)
{
for( profit_no_exit=300; profit_no_exit <450; profit_no_exit=profit_no_exit+10)
{
//for( profit_no_exit=300; profit_no_exit <450; profit_no_exit=profit_no_exit+10)
//{
//for( profit_no_exit=300; profit_no_exit <450; profit_no_exit=profit_no_exit+10)
//{
nomber=nomber+1;// это номер позиции по порядку для оптимизации


/////* * * * * * * * * * * * * * * * * * * * *****************************
/////* * * * * * * * * * * * * * * * * * * * 	********************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************	
/////* * * * * * * * * * * * *********************************************************** 
/////* * * * * * * * * * * * * * * * * * * * *********************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*********************************


/////* * * * * * * * * * * * * * * * * * * * *****************************
/////* * * * * * * * * * * * * * * * * * * * 	********************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************	
/////* * * * * * * * * * * * *********************************************************** 
/////* * * * * * * * * * * * * * * * * * * * *********************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*********************************


/////* * * * * * * * * * * * * * * * * * * * *****************************
/////* * * * * * * * * * * * * * * * * * * * 	********************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************	
/////* * * * * * * * * * * * *********************************************************** 
/////* * * * * * * * * * * * * * * * * * * * *********************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*********************************



/////**************                                      СИСТЕМА ...
/////***************************************************************************** 
/////**************************************************************************
/////********************************************************************
/////**************************************************************
/////*******************************************************	
///Дальше идет сама система т.е. то, что реально будем торговать
///////ОПИСАНИЕ:
system_diskription="222-01 ";

///////////////////////////////////////////////////////// ПАРАМЕТРЫ И УСТАНОВКИ СИСТЕМЫ///////////////
/*
Установки для автоматизированной торговли и ручной
автоторговля система сама, в зависимости от состояний рынка будет определять какую систему использовать 
при ручной торговли, что использовать определяется оператором
Выбираем нужное остальное закоментировать
*/
//switchSystem = 31;//АВТОРЕЖИМ(как СУПЕР)
switchSystem = 0;//КОНТРЕНД
///switchSystem = 100000;//ТРЕНД
ExitALL=False; // true=одинаковый выход добавки т.е. пока основная поза открыта поза плюс держиться, false=соответственно разный выход
Enter_plus=True; // МОЖНО ЛИ ДОБАВЛЯТЬСЯ.

///////////////////////////////////////////////////+Инициализация переменных
Seccode = "SRZ2";// Какой контракт

poz=0;//установили позицию в начале расчета
poz_plus=0;//Добавка
k=k_plus=0;//бар на котором открыта позиция
Position_price=0;//цена по которой открылись
Position_price_plus=0;//цена по которой добавились
profit_max=0;//Максимальная прибыль за время существования позиции
Open_Short=1;//Флаг на вход после пересечения скользящих средних Short
Open_Long=1;//Флаг на вход после пересечения скользящих средних Long
stop_short=0;//счетчики стопов
stop_long=0;//счетчики стопов
Exit_Short=True;
Exit_Long=True;
Enter_Short_plus=0;//запретили вход добавочки
Enter_Long_plus=0;//запретили вход добавочки
prosadka=0;//Самый большой зафиксированный минус по системе
cover_flag=0;
sell_flag=0;
id=0;
sl=tp=sl_plus=tp_plus=0;


												
														
													
																	
//This variables do not change												
profit=0;// результат по текущей позиции, предварительная установка
profit_plus=0;
rez=0;// Результат всего по данной системе
rez_tek=0;//Результат по текущей сделки
//profit_no_exit=400;//Прибыль после достижения которой выход до пересения средних запрещен
//ema_exit=243;//Средняя для пересечения на выход
profit_optimize= 10;//Прибыль после достижения которой разрешен второй вход
em=33;//Скользяшая средняя после которой добавляемся
ema_switch_fast_val=55;
ema_switch_slow_val=123;
the_number_of_possible_additions=2; //сколько раз можно входить после выхода добавки только для разных выходов, для одинакового выхода нге имеет смысла
//i_stop=10;
rezult=0; // результат в данной сделке после её закрытия (вспомогательная информация)
main_pozition=1;//amount of the basic position
plus_pozition=1;// amount of the plus position
////////////////////////////////////////////////-Инициализация переменных

///////////////////////////////////////////////////Установки системы
bars=7;// колво баров за которые ищется пик
fast=6;// быстрая скользящая средняя
NOTfast=9;// медленная скользящая средняя
adper=55;//для контренда, период ЕМА(О,adper) ниже(выше) которого можно открывать позицию в контренд
ATRopt=50;//период ATR(ATRopt) для определения тренд или контртренд
ATRopt2=SwitchSystem;//значение ATR(ATRopt) для определения тренд или контртренд
ts=150;//отклонение от максимального максимума по прибыли, для отработки скользящий стоп
profit_ogr=50000;//прибыль по достижению которой начинаем отслеживать скользящий стоп 
//(если не используешь скользящий стоп установить первое значение большое (такой прибыли быть не может)

//////////////////////////////////////////////////Индикаторы, линии, массивы

ema_switch_fast=EMA(O,ema_switch_fast_val);
ema_switch_slow=EMA(O,ema_switch_slow_val);

EMAO243=EMA(O,em);
ema_exit_mass=EMA(O,ema_exit);
///Линия пиков
HLine=Ref(HHV(H,bars),-1);
LLine=Ref(LLV(L,bars),-1);
///Среднии по верхам
MA_h_fast=MA(H,fast);
MA_h_NOTfast=MA(H,NOTfast);
///Среднии по низам
MA_l_fast=MA(L,fast);
MA_l_NOTfast=MA(L,NOTfast);
///Адаптивные среднии по верхам
EMA_h_fast=EMA(H,fast);
EMA_h_NOTfast=EMA(H,NOTfast);
///Адаптивные Среднии по низам
EMA_l_fast=EMA(L,fast);
EMA_l_NOTfast=EMA(L,NOTfast);
EMA_Close=EMA(C,fast);
EMAO=EMA(O,adper);
ATR_12=ATR(12);///определяем стопы;
ATRopti=ATR(ATRopt);///переключение системы
n=EndValue(BarIndex());///номер поcледнего бара
tm=TimeNum();/// масив времени баров
dm=Day(); /// массив дата
///////////////////////////////////////Procedure 

											


////////////////////////////////////////////////////КОНЕЦ ПАРАМЕТРЫ  И УСТАНОВКИ СИСТЕМЫ/////////////////////////

//НАЧАЛО ЦИКЛА ТЕСТИРОВАНИЯ
for( n = 0; n < BarCount; n++ )
{
if(n==0)
{
Lf = fopen(FileNameLog, "w");
	fputs(Name()+"Begin-------------------------------------------------------"+"\n",Lf);
	fclose(Lf);
}


//////////////////////////////////////////////////СТАРТ СИСТЕМЫ///////////////////////////////////////////
i=n;

Buy[i]=False;
Sell[i]=False;
Cover[i]=False;
Short[i]=False;	


//ПЕРЕКЛЮЧАТЕЛИ-ФЛАЖОЧКИ
Exit_short=True;//разрешили выход шорт
Exit_Long=True;//разрешили выход лонг
if (poz==-1) profit=Position_price-O[i];
if (poz_plus==-1) profit_plus=Position_price_plus-O[i];
//profit=profit+profit_plus;
if (poz==-1 AND profit>=profit_no_exit AND O[i] <=ema_exit_mass[i]) Exit_short=False;//Запретили выход если сильный тренд


if (poz==1) profit=O[i]-Position_price;
if (poz_plus==1) profit_plus=O[i]-Position_price_plus;
//profit=profit+profit_plus;
if (poz==1 AND profit>=profit_no_exit AND O[i] >=ema_exit_mass[i]) Exit_Long=False;//Запретили выход если сильный тренд

//переключатель 
if ((i>1 AND ema_switch_fast[i-1]>ema_switch_slow[i-1] AND  ema_switch_fast[i]<ema_switch_slow[i]) OR (i>1 AND ema_switch_fast[i-1]<ema_switch_slow[i-1] AND  ema_switch_fast[i]>ema_switch_slow[i]))
	{
	//open_short=1;
	//open_long=1;
	//stop_short=0;
	//stop_long=-0;
	}


///////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////ПРАВИЛА СИСТЕМЫ/////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////Выходим Основная 
/////////////////////////////////////////////////////STOPs/////////////////////////////////
//switchSystem = 0;
//if(prosadka<=1500) switchSystem = 100000;

//--------------------------------------------- SHORT - stoploss
	if (poz==-1 AND High[i]+0>=Position_price+sl AND i>k) 
{
	Cover[i]=True;
	CoverPrice[i]=Position_price+sl;
	poz=0;
	k=i;
	//если открытие выше стопа, закрываемся по открытию
	if(Open[i]>Position_price+sl)
	CoverPrice[i]=Open[i];
	CoverPrice[i]=round(CoverPrice[i]);
	//Считаем и пишем все в файл
	stoploss[i]=True;//для рисования
	rez_tek=(Position_price-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
														
	save_log("SLShort;"+CoverPrice[i]+";"+rez_tek+";"+rez);
//Переключаем запреты	
	stop_long=0;
	open_long=1;
	stop_short=stop_short+1;
			
			if(stop_short>=i_stop AND poz_plus==0) 
			{
			//switchSystem = 100000;
			ATRopt2=SwitchSystem;
			open_short=0;
				//купим 
				Buy[i]=True;
				poz=1;
				//сохраним номер бара на котором открыли позицию
				k=i;
				BuyPrice[i]=CoverPrice[i];
				Position_price=BuyPrice[i];
										
				//Считаем и пишем все в файл
				save_log("BuySwitch;"+BuyPrice[i]);
				//Считаем и пишем все в файл											
			}	

//--------------------------------------------END SHORT - stoploss
}

//--------------------------------------------LONG - stoploss
	if (poz==1 AND Low[i]+0<=Position_price-sl AND i>k) 
{
	Sell[i]=True;
	SellPrice[i]=Position_price-sl;
	poz=0;
	k=i;
//если открытие ниже стопа, выходим на открытии бара
	if(Open[i]<Position_price-sl)
	SellPrice[i]=Open[i];
	SellPrice[i]=round(SellPrice[i]);
	//Считаем и пишем все в файл
	stoploss[i]=True;//для рисования
	rez_tek=(SellPrice[i]-Position_price)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
	if(rez<=prosadka) prosadka=rez;
	//k=i+1;
														
save_log("SLBuy;"+SellPrice[i]+";"+rez_tek+";"+rez);
//переключаем флажочки
	stop_short=0;
	open_short=1;	
	stop_long=stop_long+1;
		if (stop_long>=i_stop AND poz==0) 
	{
		//switchSystem = 100000;
		ATRopt2=SwitchSystem;
		open_long=0;
		//продадим
		Short[i]=True;
		poz=-1;
		//сохраним номер бара на котором открыли позицию
		k=i;
		ShortPrice[i]=SellPrice[i];
		Position_price=ShortPrice[i];
							
			
		//Считаем и пишем все в файл
		save_log("ShortSwitch;"+ShortPrice[i]);
		//Считаем и пишем все в файл
	}
	

//--------------------------------------------------END LONG - stoploss	


}

//--------------------------------------------------LONG - take profit
	if (Exit_long==True AND poz==1 AND (High[i]+0)>=Position_price+tp AND i>k) 
{
	Sell[i]=True;
	SellPrice[i]=Position_price+tp;
	k=i;
// если открытие выше тэйка, выходим сразу на открытии
	if(Open[i]>Position_price+tp)
	SellPrice[i]=Open[i];
	SellPrice[i]=round(SellPrice[i]);
//обнулим позицию в файле 
	poz=0;
//Установили бар следующего открытия позиции
k=i;

//Считаем и пишем все в файл
	takeprofit[i]=True;//для рисования
	rez_tek=(SellPrice[i]-Position_price)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
												
	
	save_log("TPBuy;"+SellPrice[i]+";"+rez_tek+";"+rez);//Считаем и пишем все в файл

}
//-------------------------------------------------- END LONG - take profit


//---------------------------------------------------SHORT - take profit

    if (Exit_Short==True AND poz==-1 AND (Low[i]+0)<=Position_price-tp AND i>k) 
{
	Cover[i]=True;
	CoverPrice[i]=Position_price-tp;
// если открытие ниже тэйка, выходим сразу на открытии
	if (Open[i]<Position_price-tp)
	CoverPrice[i]=Open[i];
	CoverPrice[i]=round(CoverPrice[i]);
//обнулим позицию в файле 
	poz=0;
//Установили бар следующего открытия позиции
k=i;
	takeprofit[i]=True;//для рисования
	rez_tek=(Position_price-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
												
save_log("TPShort;"+CoverPrice[i]+";"+rez_tek+";"+rez);//Считаем и пишем все в файл

}
//---------------------------------------------------END SHORT - take profit

////////////////////////////////////////////////////Скользящий стоп 

//Определяем прибыль на текущем баре
if (poz==-1) profit=Position_price-Low[i];
if (poz==1) profit=High[i]-Position_price;
//Максимальная прибыль за время существования позиции
if (profit>=profit_max) profit_max=profit;

if (poz==-1 AND Position_price-High[i]<profit_max-ts AND profit_max>profit_ogr )
	{
			 	Cover[i]=True;
				poz=0;
				k=i;
				profit_max=0;
				CoverPrice[i]=High[i];
	}


if (poz==1 AND Position_price-Low[i]<profit_max-ts AND profit_max>profit_ogr)
	{
			 	Sell[i]=True;
				poz=0;
				k=i;
				profit_max=0;
				SellPrice[i]=Low[i];
	}

//////////////////////////////////////////////////Конец Скользящий стоп

/////////////////////////////////////////////////ВЫХОД ДОБАВОЧКА СТОПЫ
if(poz_plus!=0)
{
//--------------------------------------------- SHORT+ - stoploss

	if ((poz_plus==-1 AND Cover[i]==True AND ExitAll==True AND stoploss[i]==True) OR 
	(poz_plus==-1 AND High[i]+0>=Position_price_plus+sl_plus AND ExitAll==False)) 
{
	Cover_plus[i]=True;
	if(ExitALL==True) CoverPrice_plus[i]=CoverPrice[i];//одинаковый выход
	if(ExitALL==False) CoverPrice_plus[i]=Position_price_plus+sl_plus;//разный выход
	poz_plus=0;
//если открытие выше стопа, закрываемся по открытию
	if(Open[i]>Position_price_plus+sl_plus AND ExitAll==False) CoverPrice_plus[i]=Open[i]; //разный выход
	CoverPrice_plus[i]=round(CoverPrice_plus[i]);
	
//Установили бар следующего открытия позиции
k_plus=i;
//
//Open_Short=0;
//Считаем и пишем все в файл
	stoploss_plus[i]=True;//для рисования
	rez_tek=(Position_price_plus-CoverPrice_plus[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
	if(rez<=prosadka) prosadka=rez;
								
	
	save_log("SLShort+;"+CoverPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
}
//--------------------------------------------END SHORT+ - stoploss


//--------------------------------------------LONG+ - stoploss
	if ((poz_plus==1 AND Sell[i]==True AND ExitAll==True AND stoploss[i]==True) OR
	(poz_plus==1 AND Low[i]+0<=Position_price_plus-sl_plus AND ExitAll==False)) 
{
	Sell_plus[i]=True;
	if(ExitALL==True) SellPrice_plus[i]=SellPrice[i];//одинаковый выход
	if(ExitALL==False) SellPrice_plus[i]=Position_price_plus-sl_plus;//разный выход
	poz_plus=0;
//если открытие ниже стопа, выходим на открытии бара
	if(Open[i]<Position_price_plus-sl_plus AND ExitAll==False) SellPrice_plus[i]=Open[i]; //разный выход
	SellPrice_plus[i]=round(SellPrice_plus[i]);
//Установили бар следующего открытия позиции
k_plus=i;
//
//Open_Long=0;

//Считаем и пишем все в файл
	stoploss_plus[i]=True;//для рисования
	rez_tek=(SellPrice_plus[i]-Position_price_plus)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
												

	save_log("SLBuy+;"+SellPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
}
//--------------------------------------------------END LONG+ - stoploss	

//--------------------------------------------------LONG+ - take profit
	if ((poz_plus==1 AND Sell[i]==True AND ExitAll==True AND takeprofit[i]==True)  OR
	(poz_plus==1 AND High[i]>=Position_price_plus+tp_plus AND ExitAll==False)) 
{
	Sell_plus[i]=True;
	if(ExitALL==True) SellPrice_plus[i]=SellPrice[i];//одинаковый выход
	if(ExitALL==False) SellPrice_plus[i]=Position_price_plus+tp_plus;//разный выход
// если открытие выше тэйка, выходим сразу на открытии
	if(Open[i]>Position_price_plus+tp_plus AND ExitAll==False) SellPrice_plus[i]=Open[i];//разный выход
	SellPrice_plus[i]=round(SellPrice_plus[i]);
	poz_plus=0;
//Установили бар следующего открытия позиции
k_plus=i;
//Считаем и пишем все в файл
	takeprofit_plus[i]=True;//для рисования
	rez_tek=(SellPrice_plus[i]-Position_price_plus)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
									
	save_log("TPBuy+;"+SellPrice[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
}
//-------------------------------------------------- END LONG+ - take profit


//---------------------------------------------------SHORT+ - take profit
    if ((poz_plus==-1 AND Cover[i]==True AND ExitAll==True AND takeprofit[i]==True) OR
	(poz_plus==-1 AND Low[i]<=Position_price_plus-tp_plus AND ExitAll==False) ) 
{
	Cover_plus[i]=True;
	if (ExitAll==True) CoverPrice_plus[i]=CoverPrice[i];//одинаковый выход
	if (ExitAll==False) CoverPrice_plus[i]=Position_price_plus-tp_plus;//разный выход
// если открытие ниже тэйка, выходим сразу на открытии
	if (Open[i]<Position_price_plus-tp_plus AND ExitAll==False) CoverPrice_plus[i]=Open[i];
	CoverPrice_plus[i]=round(CoverPrice_plus[i]);
//обнулим позицию в файле 
	poz_plus=0;
//Установили бар следующего открытия позиции
k_plus=i;
//Считаем и пишем все в файл
	takeprofit_plus[i]=True;//для рисования
	rez_tek=(Position_price_plus-CoverPrice_plus[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
													
	save_log("TPShort+;"+CoverPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
}
//---------------------------------------------------END SHORT+ - take profit

////////////////////////////////////////////////////Скользящий стоп +
//Определяем прибыль на текущем баре
if (poz_plus==-1) profit_plus=Position_price_plus-Low[i];
if (poz_plus==1) profit_plus=High[i]-Position_price_plus;
//Максимальная прибыль за время существования позиции
if (profit>=profit_max) profit_max=profit;

if (poz==-1 AND Position_price-High[i]<profit_max-ts AND profit_max>profit_ogr )
	{
			 	Cover[i]=True;
				poz=0;
				k=i;
				profit_max=0;
				CoverPrice[i]=High[i];
	}


if (poz==1 AND Position_price-Low[i]<profit_max-ts AND profit_max>profit_ogr)
	{
			 	Sell[i]=True;
				poz=0;
				k=i;
				profit_max=0;
				SellPrice[i]=Low[i];
	}
//////////////////////////////////////////////////Конец Скользящий стоп +
}
////////////////////////////////////////////////////КОНЕЦ ВЫХОД ДОБАВОЧКА СТОПЫ




//Принимаем решение на вход выход по закрытию бара, поэтому
i=n-1;
if(i<0) i=0;

//---------------------------------------------------Выходим по правилам системы
//---------------------------------------------------SELL 
	if (Exit_long==True AND poz==1 AND High [i]+0>Lline[i]+0 AND Low[i]+0<Lline[i]+0 AND
	EMA_l_fast[i]+0<=EMA_l_NOTfast[i]+0 AND i>k AND EMA_l_fast[i]>0 AND EMA_close[i]<=Lline[i]) 
{
//
	Sell[i]=True;
	SellPrice[i]=Close[i];
	SellPrice[i]=round(SellPrice[i]);
	Sell_flag=i+1;
//
	poz=0;
	k=i;
											
//Считаем и пишем все в файл
	rez_tek=(SellPrice[i]-Position_price)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
save_log("Sell;"+SellPrice[i]+";"+rez_tek+";"+rez);//Считаем и пишем все в файл


//--------------------------------------------------END SELL
}
//--------------------------------------------------COVER
	if (Exit_Short==True AND poz==-1 AND Low[i]<Hline[i] AND High[i]>Hline[i] AND
	EMA_h_fast[i]>=EMA_h_NOTfast[i] AND i>k AND EMA_h_fast[i]>0 AND EMA_close[i]>=Hline[i]) 
{
   Cover[i]=True;
	CoverPrice[i]=Close[i];
	Cover_flag=i+1;		
	poz=0;
	k=i;
		
		CoverPrice[i]=round(CoverPrice[i]);
//Установили бар следующего открытия позиции
											
	
//Считаем и пишем все в файл
	rez_tek=(Position_price-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Cover;"+CoverPrice[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
//---------------------------------------------------END COVER


}

/////////////////////////////////////////////////////ВЫХОД ДОБАВОЧКА ПРАВИЛА СИСТЕМЫ
//---------------------------------------------------Выходим по правилам системы

//---------------------------------------------------SELL+
	if ((ExitAll==True AND Exit_long==True AND poz_plus==1 AND Sell[i]==True) OR
		(poz_plus==1 AND High [i]+0>Lline[i]+0 AND Low[i]+0<Lline[i]+0 AND 
	EMA_l_fast[i]+0<=EMA_l_NOTfast[i]+0  AND EMA_l_fast[i]>0 AND EMA_close[i]<=Lline[i] AND ExitAll==False)) 
{
//
	Sell_plus[i]=True;
	SellPrice_plus[i]=Close[i];
	SellPrice_plus[i]=round(SellPrice_plus[i]);
//
	poz_plus=0;
											
	
//Считаем и пишем все в файл
	rez_tek=(SellPrice_plus[i]-Position_price_plus)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Sell+;"+SellPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
//--------------------------------------------------END SELL+

}
//--------------------------------------------------COVER+
	if ((ExitAll==True AND Exit_short==True AND poz_plus==-1 AND Cover[i]==True ) OR
	(poz_plus==-1 AND Low[i]<Hline[i] AND High[i]>Hline[i] AND
	EMA_h_fast[i]>=EMA_h_NOTfast[i]  AND EMA_h_fast[i]>0 AND EMA_close[i]>=Hline[i] AND ExitAll==False)) 
{
    Cover_plus[i]=True;
	CoverPrice_plus[i]=Close[i];
	poz_plus=0;
	CoverPrice_plus[i]=round(CoverPrice_plus[i]);
//Установили бар следующего открытия позиции
												
//Считаем и пишем все в файл
	rez_tek=(Position_price_plus-CoverPrice_plus[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Cover+;"+CoverPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
//---------------------------------------------------END COVER+
}

///////////////////////////////////КОНЕЦ ВЫХОД ДОБАВОЧКА ПРАВИЛА СИСТЕМЫ////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////// Входим
//----------------------------------------------------------------------LONG
	if (poz_plus==0 AND Open_Long==1 AND Low[i]<Hline[i] AND High[i]>Hline[i]  AND
	poz==0 AND EMA_h_fast[i]>=EMA_h_NOTfast[i] AND i>=sell_flag AND i>=k AND EMAO[i]>=Hline[i] AND ATRopti[i]>=ATRopt2 OR
	Low[i]<Hline[i] AND High[i]>Hline[i]  AND poz==0 AND EMA_h_fast[i]>=EMA_h_NOTfast[i] AND
	i>=sell_flag AND i>=k AND	ATRopti[i]<ATRopt2)
{ 
	Buy[i]=True;
	poz=1;
//сохраним номер бара на котором открыли позицию
	k=i;
	BuyPrice[i]=Close[i];
	BuyPrice[i]=round(BuyPrice[i]);
//обнулил счетчик стопов
stop_short=0;//счетчики стопов
switchSystem = 0;
ATRopt2=SwitchSystem;
Open_Short=1;
//разрешили вход добавки
enter_long_plus=0;
//сохраним цену открытия позиции	
Position_price=BuyPrice[i];
//Посчитали стопы
tp=ATR_12[i]*37;
sl=ATR_12[i]*10;
if(sl>150)sl=150;
								

//Считаем и пишем все в файл
	save_log("Buy;"+BuyPrice[i]+" tp="+tp);
//Считаем и пишем все в файл
//----------------------------------------------------------------------END LONG
} 




//----------------------------------------------------------------------SHORT
	if( poz_plus==0 AND Open_Short==1 AND (High[i]>Lline[i] AND Lline[i]>Low[i] AND
	poz==0 AND EMA_l_fast[i]<=EMA_l_NOTfast[i] AND i>=cover_flag AND i>=k AND EMAO[i]<=Lline[i] AND ATRopti[i]>=ATRopt2  ) OR 
	(High[i]>Lline[i] AND Lline[i]>Low[i] AND poz==0 AND EMA_l_fast[i]<=EMA_l_NOTfast[i] AND
	i>=cover_flag AND i>=k AND ATRopti[i]<ATRopt2))
{ 
	Short[i]=True;
	poz=-1;
//сохраним номер бара на котором открыли позицию
	k=i;
	ShortPrice[i]=Close[i];
	ShortPrice[i]=round(ShortPrice[i]);
//обнулил счетчик стопов
stop_long=0;//счетчики стопов
Open_Long=1;
switchSystem = 0;
ATRopt2=SwitchSystem;
//разрешили вход добавки
enter_short_plus=0;
//сохраним цену открытия позиции
	Position_price=ShortPrice[i];
//Посчитали стопы
	tp=ATR_12[i]*37;
	sl=ATR_12[i]*10;
	if(sl>150)sl=150;
								

//Считаем и пишем все в файл
	save_log("Short;"+ShortPrice[i]+" tp="+tp);
//Считаем и пишем все в файл
//----------------------------------------------------------------------END SHORT
}




if(enter_plus==True) //authorized additive or not
{
//----------------------------------------------------------------------Добавляемся
if (poz==-1) profit=Position_price-Low[i];
if (poz==1) profit=High[i]-Position_price;

//----------------------------------------------------------------------SHORT+
if(i>=k_plus AND enter_short_plus<the_number_of_possible_additions AND profit>=profit_optimize AND
 poz_plus==0 AND High[i]>Lline[i] AND Lline[i]>Low[i] AND poz==-1 AND EMA_l_fast[i]<=EMA_l_NOTfast[i] AND
 i>=cover_flag AND EMAO243[i]>Hline[i]) 
{
	Short_plus[i]=True;
	poz_plus=-1;
//Save number for the bar which is open position
	k_plus=i;
	ShortPrice_plus[i]=Close[i];
	ShortPrice_plus[i]=round(ShortPrice_plus[i]);
//запретили вход добавки
enter_short_plus=enter_short_plus+1;
//сохраним цену открытия позиции
	Position_price_plus=ShortPrice_plus[i];
//Посчитали стопы
	tp_plus=ATR_12[i]*37; if(tp_plus<=390); tp_plus=tp_plus*ATR_12[i];
	sl_plus=sl;
//Считаем и пишем все в файл
	save_log("Short+;"+ShortPrice_plus[i]+" tp_plus="+tp_plus);
//Считаем и пишем все в файл
//----------------------------------------------------------------------END SHORT+

}
//----------------------------------------------------------------------LONG+	
if(i>=k_plus AND enter_Long_plus<the_number_of_possible_additions AND profit>=profit_optimize AND
 poz_plus==0 AND Low[i]<Hline[i] AND High[i]>Hline[i]  AND poz==1 AND EMA_h_fast[i]>=EMA_h_NOTfast[i] AND
 i>=sell_flag  AND EMAO243[i]<Hline[i])
{ 
	Buy_plus[i]=True;
	poz_plus=1;
//сохраним номер бара на котором открыли позицию
	k_plus=i;
	BuyPrice_plus[i]=Close[i];
	BuyPrice_plus[i]=round(BuyPrice_plus[i]);
//сохраним цену открытия позиции	
Position_price_plus=BuyPrice_plus[i];
//запретили вход добавки
enter_long_plus=enter_long_plus+1;
//Посчитали стопы
	tp_plus=ATR_12[i]*37; if(tp_plus<=390); tp_plus=tp_plus*ATR_12[i];
	sl_plus=sl;


	
	
//Считаем и пишем все в файл
	save_log("Buy+;"+BuyPrice_plus[i]+" tp_plus="+tp_plus);
//Считаем и пишем все в файл
}
//----------------------------------------------------------------------END LONG+

///////////////////////////До этого вставляем в АТС
}
//---END authorized additive or not



														

}

////////////////////////////////////////////ЭТО КОНЕЦ ЦИКЛА//////////////////////////
/////***************************************************************************** СИСТЕМА ...
/////**************************************************************************
/////********************************************************************
/////**************************************************************
/////*******************************************************






i=i+1;//Прибавили то, что отняли

//ЕСЛИ ОСТАЛАСЬ ПОЗИЦИЯ ОТКРЫТА ПОСЧИТАЕМ ТЕКУЩИЙ РЕЗУЛЬТАТ
if (poz==-1)
{
	//Считаем и пишем все в файл
	CoverPrice[i]=Close[i];
	rez_tek=(Position_price-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Cover;"+CoverPrice[i]+";"+rez_tek+";"+rez);
	//Считаем и пишем все в файл

//Добавочка
if(poz_plus!=0)
{
CoverPrice[i]=Close[i];
	rez_tek=(Position_price_plus-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Cover+;"+CoverPrice[i]+";"+rez_tek+";"+rez);
}
//Добавочка


}

if (poz==1)
{
//Считаем и пишем все в файл
	SellPrice[i]=Close[i];
	rez_tek=(SellPrice[i]-Position_price)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Sell;"+SellPrice[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
//Добавочка
if(poz_plus!=0)
{
SellPrice_plus[i]=Close[i];
	rez_tek=(SellPrice_plus[i]-Position_price_plus)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Sell+;"+SellPrice_plus[i]+";"+rez_tek+";"+rez);
}
//Добавочка
}

//ИТОГО
	save_log("*********************TOTAL=;"+rez);
	//-До сюда кидаем на график
	
//Теперь выведим толь результат по символу
rez_simvol= fopen("C:/ami/test/testrez1.txt", "a");
	//fputs(Name()+";"+rez+";"+Oema+";"+bars+";"+fast+";"+NOTfast+";"+nomber+"\n",rez_simvol);
	fputs(Name()+";"+rez+";"+prosadka+";"+ema_exit+";"+profit_no_exit+";"+nomber+"\n",rez_simvol);
	fclose(Lf);
//Дальше концы оптимизационных циклов

}
}
}
//}
//}


////*********************************ОПТИМИЗИРУЕМ СИСТЕМА
////ОПИСАНИЕ: - Входим контртренд добавляемся по тренду плюс профит разный выход
////////////////////////Погнали, это начало оптимизационных циклов
nomber=0; // это номер по порядку для сортировки строк с одинаковыми параметрами
///ЦИКЛЫ
for( i_stop=1; i_stop <16; i_stop =i_stop +1)
{ 
for( ema_exit=150; ema_exit <270; ema_exit=ema_exit+10)
{
for( profit_no_exit=300; profit_no_exit <450; profit_no_exit=profit_no_exit+10)
{
//for( profit_no_exit=300; profit_no_exit <450; profit_no_exit=profit_no_exit+10)
//{
//for( profit_no_exit=300; profit_no_exit <450; profit_no_exit=profit_no_exit+10)
//{
nomber=nomber+1;// это номер позиции по порядку для оптимизации


/////* * * * * * * * * * * * * * * * * * * * *****************************
/////* * * * * * * * * * * * * * * * * * * * 	********************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************	
/////* * * * * * * * * * * * *********************************************************** 
/////* * * * * * * * * * * * * * * * * * * * *********************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*********************************


/////* * * * * * * * * * * * * * * * * * * * *****************************
/////* * * * * * * * * * * * * * * * * * * * 	********************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************	
/////* * * * * * * * * * * * *********************************************************** 
/////* * * * * * * * * * * * * * * * * * * * *********************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*********************************


/////* * * * * * * * * * * * * * * * * * * * *****************************
/////* * * * * * * * * * * * * * * * * * * * 	********************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************	
/////* * * * * * * * * * * * *********************************************************** 
/////* * * * * * * * * * * * * * * * * * * * *********************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*********************************



/////**************                                      СИСТЕМА ...
/////***************************************************************************** 
/////**************************************************************************
/////********************************************************************
/////**************************************************************
/////*******************************************************	
///Дальше идет сама система т.е. то, что реально будем торговать
///////ОПИСАНИЕ:
system_diskription="222-01 ";

///////////////////////////////////////////////////////// ПАРАМЕТРЫ И УСТАНОВКИ СИСТЕМЫ///////////////
/*
Установки для автоматизированной торговли и ручной
автоторговля система сама, в зависимости от состояний рынка будет определять какую систему использовать 
при ручной торговли, что использовать определяется оператором
Выбираем нужное остальное закоментировать
*/
//switchSystem = 31;//АВТОРЕЖИМ(как СУПЕР)
switchSystem = 0;//КОНТРЕНД
///switchSystem = 100000;//ТРЕНД
ExitALL=False; // true=одинаковый выход добавки т.е. пока основная поза открыта поза плюс держиться, false=соответственно разный выход
Enter_plus=True; // МОЖНО ЛИ ДОБАВЛЯТЬСЯ.

///////////////////////////////////////////////////+Инициализация переменных
Seccode = "SRZ2";// Какой контракт

poz=0;//установили позицию в начале расчета
poz_plus=0;//Добавка
k=k_plus=0;//бар на котором открыта позиция
Position_price=0;//цена по которой открылись
Position_price_plus=0;//цена по которой добавились
profit_max=0;//Максимальная прибыль за время существования позиции
Open_Short=1;//Флаг на вход после пересечения скользящих средних Short
Open_Long=1;//Флаг на вход после пересечения скользящих средних Long
stop_short=0;//счетчики стопов
stop_long=0;//счетчики стопов
Exit_Short=True;
Exit_Long=True;
Enter_Short_plus=0;//запретили вход добавочки
Enter_Long_plus=0;//запретили вход добавочки
prosadka=0;//Самый большой зафиксированный минус по системе
cover_flag=0;
sell_flag=0;
id=0;
sl=tp=sl_plus=tp_plus=0;


												
													
													
																	
//This variables do not change												
profit=0;// результат по текущей позиции, предварительная установка
profit_plus=0;
rez=0;// Результат всего по данной системе
rez_tek=0;//Результат по текущей сделки
//profit_no_exit=400;//Прибыль после достижения которой выход до пересения средних запрещен
//ema_exit=243;//Средняя для пересечения на выход
profit_optimize= 10;//Прибыль после достижения которой разрешен второй вход
em=33;//Скользяшая средняя после которой добавляемся
ema_switch_fast_val=55;
ema_switch_slow_val=123;
the_number_of_possible_additions=2; //сколько раз можно входить после выхода добавки только для разных выходов, для одинакового выхода нге имеет смысла
//i_stop=10;
rezult=0; // результат в данной сделке после её закрытия (вспомогательная информация)
main_pozition=1;//amount of the basic position
plus_pozition=1;// amount of the plus position
////////////////////////////////////////////////-Инициализация переменных

///////////////////////////////////////////////////Установки системы
bars=7;// колво баров за которые ищется пик
fast=6;// быстрая скользящая средняя
NOTfast=9;// медленная скользящая средняя
adper=55;//для контренда, период ЕМА(О,adper) ниже(выше) которого можно открывать позицию в контренд
ATRopt=50;//период ATR(ATRopt) для определения тренд или контртренд
ATRopt2=SwitchSystem;//значение ATR(ATRopt) для определения тренд или контртренд
ts=150;//отклонение от максимального максимума по прибыли, для отработки скользящий стоп
profit_ogr=50000;//прибыль по достижению которой начинаем отслеживать скользящий стоп 
//(если не используешь скользящий стоп установить первое значение большое (такой прибыли быть не может)

//////////////////////////////////////////////////Индикаторы, линии, массивы

ema_switch_fast=EMA(O,ema_switch_fast_val);
ema_switch_slow=EMA(O,ema_switch_slow_val);

EMAO243=EMA(O,em);
ema_exit_mass=EMA(O,ema_exit);
///Линия пиков
HLine=Ref(HHV(H,bars),-1);
LLine=Ref(LLV(L,bars),-1);
///Среднии по верхам
MA_h_fast=MA(H,fast);
MA_h_NOTfast=MA(H,NOTfast);
///Среднии по низам
MA_l_fast=MA(L,fast);
MA_l_NOTfast=MA(L,NOTfast);
///Адаптивные среднии по верхам
EMA_h_fast=EMA(H,fast);
EMA_h_NOTfast=EMA(H,NOTfast);
///Адаптивные Среднии по низам
EMA_l_fast=EMA(L,fast);
EMA_l_NOTfast=EMA(L,NOTfast);
EMA_Close=EMA(C,fast);
EMAO=EMA(O,adper);
ATR_12=ATR(12);///определяем стопы;
ATRopti=ATR(ATRopt);///переключение системы
n=EndValue(BarIndex());///номер поcледнего бара
tm=TimeNum();/// масив времени баров
dm=Day(); /// массив дата
///////////////////////////////////////Procedure 

											


////////////////////////////////////////////////////КОНЕЦ ПАРАМЕТРЫ  И УСТАНОВКИ СИСТЕМЫ/////////////////////////

//НАЧАЛО ЦИКЛА ТЕСТИРОВАНИЯ
for( n = 0; n < BarCount; n++ )
{
if(n==0)
{
Lf = fopen(FileNameLog, "w");
	fputs(Name()+"Begin-------------------------------------------------------"+"\n",Lf);
	fclose(Lf);
}


//////////////////////////////////////////////////СТАРТ СИСТЕМЫ///////////////////////////////////////////
i=n;

Buy[i]=False;
Sell[i]=False;
Cover[i]=False;
Short[i]=False;	


//ПЕРЕКЛЮЧАТЕЛИ-ФЛАЖОЧКИ
Exit_short=True;//разрешили выход шорт
Exit_Long=True;//разрешили выход лонг
if (poz==-1) profit=Position_price-O[i];
if (poz_plus==-1) profit_plus=Position_price_plus-O[i];
//profit=profit+profit_plus;
if (poz==-1 AND profit>=profit_no_exit AND O[i] <=ema_exit_mass[i]) Exit_short=False;//Запретили выход если сильный тренд


if (poz==1) profit=O[i]-Position_price;
if (poz_plus==1) profit_plus=O[i]-Position_price_plus;
//profit=profit+profit_plus;
if (poz==1 AND profit>=profit_no_exit AND O[i] >=ema_exit_mass[i]) Exit_Long=False;//Запретили выход если сильный тренд

//переключатель 
if ((i>1 AND ema_switch_fast[i-1]>ema_switch_slow[i-1] AND  ema_switch_fast[i]<ema_switch_slow[i]) OR (i>1 AND ema_switch_fast[i-1]<ema_switch_slow[i-1] AND  ema_switch_fast[i]>ema_switch_slow[i]))
	{
	//open_short=1;
	//open_long=1;
	//stop_short=0;
	//stop_long=-0;
	}


///////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////ПРАВИЛА СИСТЕМЫ/////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////Выходим Основная 
/////////////////////////////////////////////////////STOPs/////////////////////////////////
//switchSystem = 0;
//if(prosadka<=1500) switchSystem = 100000;

//--------------------------------------------- SHORT - stoploss
	if (poz==-1 AND High[i]+0>=Position_price+sl AND i>k) 
{
	Cover[i]=True;
	CoverPrice[i]=Position_price+sl;
	poz=0;
	k=i;
	//если открытие выше стопа, закрываемся по открытию
	if(Open[i]>Position_price+sl)
	CoverPrice[i]=Open[i];
	CoverPrice[i]=round(CoverPrice[i]);
	//Считаем и пишем все в файл
	stoploss[i]=True;//для рисования
	rez_tek=(Position_price-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
														
	save_log("SLShort;"+CoverPrice[i]+";"+rez_tek+";"+rez);
//Переключаем запреты	
	stop_long=0;
	open_long=1;
	stop_short=stop_short+1;
			
			if(stop_short>=i_stop AND poz_plus==0) 
			{
			//switchSystem = 100000;
			ATRopt2=SwitchSystem;
			open_short=0;
				//купим 
				Buy[i]=True;
				poz=1;
				//сохраним номер бара на котором открыли позицию
				k=i;
				BuyPrice[i]=CoverPrice[i];
				Position_price=BuyPrice[i];
										
				//Считаем и пишем все в файл
				save_log("BuySwitch;"+BuyPrice[i]);
				//Считаем и пишем все в файл											
			}	

//--------------------------------------------END SHORT - stoploss
}

//--------------------------------------------LONG - stoploss
	if (poz==1 AND Low[i]+0<=Position_price-sl AND i>k) 
{
	Sell[i]=True;
	SellPrice[i]=Position_price-sl;
	poz=0;
	k=i;
//если открытие ниже стопа, выходим на открытии бара
	if(Open[i]<Position_price-sl)
	SellPrice[i]=Open[i];
	SellPrice[i]=round(SellPrice[i]);
	//Считаем и пишем все в файл
	stoploss[i]=True;//для рисования
	rez_tek=(SellPrice[i]-Position_price)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
	if(rez<=prosadka) prosadka=rez;
	//k=i+1;
														
save_log("SLBuy;"+SellPrice[i]+";"+rez_tek+";"+rez);
//переключаем флажочки
	stop_short=0;
	open_short=1;	
	stop_long=stop_long+1;
		if (stop_long>=i_stop AND poz==0) 
	{
		//switchSystem = 100000;
		ATRopt2=SwitchSystem;
		open_long=0;
		//продадим
		Short[i]=True;
		poz=-1;
		//сохраним номер бара на котором открыли позицию
		k=i;
		ShortPrice[i]=SellPrice[i];
		Position_price=ShortPrice[i];
							
			
		//Считаем и пишем все в файл
		save_log("ShortSwitch;"+ShortPrice[i]);
		//Считаем и пишем все в файл
	}
	

//--------------------------------------------------END LONG - stoploss	


}

//--------------------------------------------------LONG - take profit
	if (Exit_long==True AND poz==1 AND (High[i]+0)>=Position_price+tp AND i>k) 
{
	Sell[i]=True;
	SellPrice[i]=Position_price+tp;
	k=i;
// если открытие выше тэйка, выходим сразу на открытии
	if(Open[i]>Position_price+tp)
	SellPrice[i]=Open[i];
	SellPrice[i]=round(SellPrice[i]);
//обнулим позицию в файле 
	poz=0;
//Установили бар следующего открытия позиции
k=i;

//Считаем и пишем все в файл
	takeprofit[i]=True;//для рисования
	rez_tek=(SellPrice[i]-Position_price)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
												
	
	save_log("TPBuy;"+SellPrice[i]+";"+rez_tek+";"+rez);//Считаем и пишем все в файл

}
//-------------------------------------------------- END LONG - take profit


//---------------------------------------------------SHORT - take profit

    if (Exit_Short==True AND poz==-1 AND (Low[i]+0)<=Position_price-tp AND i>k) 
{
	Cover[i]=True;
	CoverPrice[i]=Position_price-tp;
// если открытие ниже тэйка, выходим сразу на открытии
	if (Open[i]<Position_price-tp)
	CoverPrice[i]=Open[i];
	CoverPrice[i]=round(CoverPrice[i]);
//обнулим позицию в файле 
	poz=0;
//Установили бар следующего открытия позиции
k=i;
	takeprofit[i]=True;//для рисования
	rez_tek=(Position_price-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
												
save_log("TPShort;"+CoverPrice[i]+";"+rez_tek+";"+rez);//Считаем и пишем все в файл

}
//---------------------------------------------------END SHORT - take profit

////////////////////////////////////////////////////Скользящий стоп 

//Определяем прибыль на текущем баре
if (poz==-1) profit=Position_price-Low[i];
if (poz==1) profit=High[i]-Position_price;
//Максимальная прибыль за время существования позиции
if (profit>=profit_max) profit_max=profit;

if (poz==-1 AND Position_price-High[i]<profit_max-ts AND profit_max>profit_ogr )
	{
			 	Cover[i]=True;
				poz=0;
				k=i;
				profit_max=0;
				CoverPrice[i]=High[i];
	}


if (poz==1 AND Position_price-Low[i]<profit_max-ts AND profit_max>profit_ogr)
	{
			 	Sell[i]=True;
				poz=0;
				k=i;
				profit_max=0;
				SellPrice[i]=Low[i];
	}

//////////////////////////////////////////////////Конец Скользящий стоп

/////////////////////////////////////////////////ВЫХОД ДОБАВОЧКА СТОПЫ
if(poz_plus!=0)
{
//--------------------------------------------- SHORT+ - stoploss

	if ((poz_plus==-1 AND Cover[i]==True AND ExitAll==True AND stoploss[i]==True) OR 
	(poz_plus==-1 AND High[i]+0>=Position_price_plus+sl_plus AND ExitAll==False)) 
{
	Cover_plus[i]=True;
	if(ExitALL==True) CoverPrice_plus[i]=CoverPrice[i];//одинаковый выход
	if(ExitALL==False) CoverPrice_plus[i]=Position_price_plus+sl_plus;//разный выход
	poz_plus=0;
//если открытие выше стопа, закрываемся по открытию
	if(Open[i]>Position_price_plus+sl_plus AND ExitAll==False) CoverPrice_plus[i]=Open[i]; //разный выход
	CoverPrice_plus[i]=round(CoverPrice_plus[i]);
	
//Установили бар следующего открытия позиции
k_plus=i;
//
//Open_Short=0;
//Считаем и пишем все в файл
	stoploss_plus[i]=True;//для рисования
	rez_tek=(Position_price_plus-CoverPrice_plus[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
	if(rez<=prosadka) prosadka=rez;
								
	
	save_log("SLShort+;"+CoverPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
}
//--------------------------------------------END SHORT+ - stoploss


//--------------------------------------------LONG+ - stoploss
	if ((poz_plus==1 AND Sell[i]==True AND ExitAll==True AND stoploss[i]==True) OR
	(poz_plus==1 AND Low[i]+0<=Position_price_plus-sl_plus AND ExitAll==False)) 
{
	Sell_plus[i]=True;
	if(ExitALL==True) SellPrice_plus[i]=SellPrice[i];//одинаковый выход
	if(ExitALL==False) SellPrice_plus[i]=Position_price_plus-sl_plus;//разный выход
	poz_plus=0;
//если открытие ниже стопа, выходим на открытии бара
	if(Open[i]<Position_price_plus-sl_plus AND ExitAll==False) SellPrice_plus[i]=Open[i]; //разный выход
	SellPrice_plus[i]=round(SellPrice_plus[i]);
//Установили бар следующего открытия позиции
k_plus=i;
//
//Open_Long=0;

//Считаем и пишем все в файл
	stoploss_plus[i]=True;//для рисования
	rez_tek=(SellPrice_plus[i]-Position_price_plus)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
												

	save_log("SLBuy+;"+SellPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
}
//--------------------------------------------------END LONG+ - stoploss	

//--------------------------------------------------LONG+ - take profit
	if ((poz_plus==1 AND Sell[i]==True AND ExitAll==True AND takeprofit[i]==True)  OR
	(poz_plus==1 AND High[i]>=Position_price_plus+tp_plus AND ExitAll==False)) 
{
	Sell_plus[i]=True;
	if(ExitALL==True) SellPrice_plus[i]=SellPrice[i];//одинаковый выход
	if(ExitALL==False) SellPrice_plus[i]=Position_price_plus+tp_plus;//разный выход
// если открытие выше тэйка, выходим сразу на открытии
	if(Open[i]>Position_price_plus+tp_plus AND ExitAll==False) SellPrice_plus[i]=Open[i];//разный выход
	SellPrice_plus[i]=round(SellPrice_plus[i]);
	poz_plus=0;
//Установили бар следующего открытия позиции
k_plus=i;
//Считаем и пишем все в файл
	takeprofit_plus[i]=True;//для рисования
	rez_tek=(SellPrice_plus[i]-Position_price_plus)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
									
	save_log("TPBuy+;"+SellPrice[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
}
//-------------------------------------------------- END LONG+ - take profit


//---------------------------------------------------SHORT+ - take profit
    if ((poz_plus==-1 AND Cover[i]==True AND ExitAll==True AND takeprofit[i]==True) OR
	(poz_plus==-1 AND Low[i]<=Position_price_plus-tp_plus AND ExitAll==False) ) 
{
	Cover_plus[i]=True;
	if (ExitAll==True) CoverPrice_plus[i]=CoverPrice[i];//одинаковый выход
	if (ExitAll==False) CoverPrice_plus[i]=Position_price_plus-tp_plus;//разный выход
// если открытие ниже тэйка, выходим сразу на открытии
	if (Open[i]<Position_price_plus-tp_plus AND ExitAll==False) CoverPrice_plus[i]=Open[i];
	CoverPrice_plus[i]=round(CoverPrice_plus[i]);
//обнулим позицию в файле 
	poz_plus=0;
//Установили бар следующего открытия позиции
k_plus=i;
//Считаем и пишем все в файл
	takeprofit_plus[i]=True;//для рисования
	rez_tek=(Position_price_plus-CoverPrice_plus[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
													
	save_log("TPShort+;"+CoverPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
}
//---------------------------------------------------END SHORT+ - take profit

////////////////////////////////////////////////////Скользящий стоп +
//Определяем прибыль на текущем баре
if (poz_plus==-1) profit_plus=Position_price_plus-Low[i];
if (poz_plus==1) profit_plus=High[i]-Position_price_plus;
//Максимальная прибыль за время существования позиции
if (profit>=profit_max) profit_max=profit;

if (poz==-1 AND Position_price-High[i]<profit_max-ts AND profit_max>profit_ogr )
	{
			 	Cover[i]=True;
				poz=0;
				k=i;
				profit_max=0;
				CoverPrice[i]=High[i];
	}


if (poz==1 AND Position_price-Low[i]<profit_max-ts AND profit_max>profit_ogr)
	{
			 	Sell[i]=True;
				poz=0;
				k=i;
				profit_max=0;
				SellPrice[i]=Low[i];
	}
//////////////////////////////////////////////////Конец Скользящий стоп +
}
////////////////////////////////////////////////////КОНЕЦ ВЫХОД ДОБАВОЧКА СТОПЫ




//Принимаем решение на вход выход по закрытию бара, поэтому
i=n-1;
if(i<0) i=0;

//---------------------------------------------------Выходим по правилам системы
//---------------------------------------------------SELL 
	if (Exit_long==True AND poz==1 AND High [i]+0>Lline[i]+0 AND Low[i]+0<Lline[i]+0 AND
	EMA_l_fast[i]+0<=EMA_l_NOTfast[i]+0 AND i>k AND EMA_l_fast[i]>0 AND EMA_close[i]<=Lline[i]) 
{
//
	Sell[i]=True;
	SellPrice[i]=Close[i];
	SellPrice[i]=round(SellPrice[i]);
	Sell_flag=i+1;
//
	poz=0;
	k=i;
											
//Считаем и пишем все в файл
	rez_tek=(SellPrice[i]-Position_price)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
save_log("Sell;"+SellPrice[i]+";"+rez_tek+";"+rez);//Считаем и пишем все в файл


//--------------------------------------------------END SELL
}
//--------------------------------------------------COVER
	if (Exit_Short==True AND poz==-1 AND Low[i]<Hline[i] AND High[i]>Hline[i] AND
	EMA_h_fast[i]>=EMA_h_NOTfast[i] AND i>k AND EMA_h_fast[i]>0 AND EMA_close[i]>=Hline[i]) 
{
   Cover[i]=True;
	CoverPrice[i]=Close[i];
	Cover_flag=i+1;		
	poz=0;
	k=i;
		
		CoverPrice[i]=round(CoverPrice[i]);
//Установили бар следующего открытия позиции
											
	
//Считаем и пишем все в файл
	rez_tek=(Position_price-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Cover;"+CoverPrice[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
//---------------------------------------------------END COVER


}

/////////////////////////////////////////////////////ВЫХОД ДОБАВОЧКА ПРАВИЛА СИСТЕМЫ
//---------------------------------------------------Выходим по правилам системы

//---------------------------------------------------SELL+
	if ((ExitAll==True AND Exit_long==True AND poz_plus==1 AND Sell[i]==True) OR
		(poz_plus==1 AND High [i]+0>Lline[i]+0 AND Low[i]+0<Lline[i]+0 AND 
	EMA_l_fast[i]+0<=EMA_l_NOTfast[i]+0  AND EMA_l_fast[i]>0 AND EMA_close[i]<=Lline[i] AND ExitAll==False)) 
{
//
	Sell_plus[i]=True;
	SellPrice_plus[i]=Close[i];
	SellPrice_plus[i]=round(SellPrice_plus[i]);
//
	poz_plus=0;
											
	
//Считаем и пишем все в файл
	rez_tek=(SellPrice_plus[i]-Position_price_plus)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Sell+;"+SellPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
//--------------------------------------------------END SELL+

}
//--------------------------------------------------COVER+
	if ((ExitAll==True AND Exit_short==True AND poz_plus==-1 AND Cover[i]==True ) OR
	(poz_plus==-1 AND Low[i]<Hline[i] AND High[i]>Hline[i] AND
	EMA_h_fast[i]>=EMA_h_NOTfast[i]  AND EMA_h_fast[i]>0 AND EMA_close[i]>=Hline[i] AND ExitAll==False)) 
{
    Cover_plus[i]=True;
	CoverPrice_plus[i]=Close[i];
	poz_plus=0;
	CoverPrice_plus[i]=round(CoverPrice_plus[i]);
//Установили бар следующего открытия позиции
												
//Считаем и пишем все в файл
	rez_tek=(Position_price_plus-CoverPrice_plus[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Cover+;"+CoverPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
//---------------------------------------------------END COVER+
}

///////////////////////////////////КОНЕЦ ВЫХОД ДОБАВОЧКА ПРАВИЛА СИСТЕМЫ////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////// Входим
//----------------------------------------------------------------------LONG
	if (poz_plus==0 AND Open_Long==1 AND Low[i]<Hline[i] AND High[i]>Hline[i]  AND
	poz==0 AND EMA_h_fast[i]>=EMA_h_NOTfast[i] AND i>=sell_flag AND i>=k AND EMAO[i]>=Hline[i] AND ATRopti[i]>=ATRopt2 OR
	Low[i]<Hline[i] AND High[i]>Hline[i]  AND poz==0 AND EMA_h_fast[i]>=EMA_h_NOTfast[i] AND
	i>=sell_flag AND i>=k AND	ATRopti[i]<ATRopt2)
{ 
	Buy[i]=True;
	poz=1;
//сохраним номер бара на котором открыли позицию
	k=i;
	BuyPrice[i]=Close[i];
	BuyPrice[i]=round(BuyPrice[i]);
//обнулил счетчик стопов
stop_short=0;//счетчики стопов
switchSystem = 0;
ATRopt2=SwitchSystem;
Open_Short=1;
//разрешили вход добавки
enter_long_plus=0;
//сохраним цену открытия позиции	
Position_price=BuyPrice[i];
//Посчитали стопы
tp=ATR_12[i]*37;
sl=ATR_12[i]*10;
if(sl>150)sl=150;
								

//Считаем и пишем все в файл
	save_log("Buy;"+BuyPrice[i]+" tp="+tp);
//Считаем и пишем все в файл
//----------------------------------------------------------------------END LONG
} 




//----------------------------------------------------------------------SHORT
	if( poz_plus==0 AND Open_Short==1 AND (High[i]>Lline[i] AND Lline[i]>Low[i] AND
	poz==0 AND EMA_l_fast[i]<=EMA_l_NOTfast[i] AND i>=cover_flag AND i>=k AND EMAO[i]<=Lline[i] AND ATRopti[i]>=ATRopt2  ) OR 
	(High[i]>Lline[i] AND Lline[i]>Low[i] AND poz==0 AND EMA_l_fast[i]<=EMA_l_NOTfast[i] AND
	i>=cover_flag AND i>=k AND ATRopti[i]<ATRopt2))
{ 
	Short[i]=True;
	poz=-1;
//сохраним номер бара на котором открыли позицию
	k=i;
	ShortPrice[i]=Close[i];
	ShortPrice[i]=round(ShortPrice[i]);
//обнулил счетчик стопов
stop_long=0;//счетчики стопов
Open_Long=1;
switchSystem = 0;
ATRopt2=SwitchSystem;
//разрешили вход добавки
enter_short_plus=0;
//сохраним цену открытия позиции
	Position_price=ShortPrice[i];
//Посчитали стопы
	tp=ATR_12[i]*37;
	sl=ATR_12[i]*10;
	if(sl>150)sl=150;
								

//Считаем и пишем все в файл
	save_log("Short;"+ShortPrice[i]+" tp="+tp);
//Считаем и пишем все в файл
//----------------------------------------------------------------------END SHORT
}




if(enter_plus==True) //authorized additive or not
{
//----------------------------------------------------------------------Добавляемся
//if (poz==-1) profit=Position_price-Low[i];
//if (poz==1) profit=High[i]-Position_price;

//----------------------------------------------------------------------SHORT+
if(i>=k_plus AND enter_short_plus<the_number_of_possible_additions AND profit>=profit_optimize AND
 poz_plus==0 AND High[i]>Lline[i] AND Lline[i]>Low[i] AND poz==-1 AND EMA_l_fast[i]<=EMA_l_NOTfast[i] AND
 i>=cover_flag AND EMAO243[i]>Hline[i]) 
{
	Short_plus[i]=True;
	poz_plus=-1;
//Save number for the bar which is open position
	k_plus=i;
	ShortPrice_plus[i]=Close[i];
	ShortPrice_plus[i]=round(ShortPrice_plus[i]);
//запретили вход добавки
enter_short_plus=enter_short_plus+1;
//сохраним цену открытия позиции
	Position_price_plus=ShortPrice_plus[i];
//Посчитали стопы
	tp_plus=ATR_12[i]*37; if(tp_plus<=390); tp_plus=tp_plus*ATR_12[i];
	sl_plus=sl;
//Считаем и пишем все в файл
	save_log("Short+;"+ShortPrice_plus[i]+" tp_plus="+tp_plus);
//Считаем и пишем все в файл
//----------------------------------------------------------------------END SHORT+

}
//----------------------------------------------------------------------LONG+	
if(i>=k_plus AND enter_Long_plus<the_number_of_possible_additions AND profit>=profit_optimize AND
 poz_plus==0 AND Low[i]<Hline[i] AND High[i]>Hline[i]  AND poz==1 AND EMA_h_fast[i]>=EMA_h_NOTfast[i] AND
 i>=sell_flag  AND EMAO243[i]<Hline[i])
{ 
	Buy_plus[i]=True;
	poz_plus=1;
//сохраним номер бара на котором открыли позицию
	k_plus=i;
	BuyPrice_plus[i]=Close[i];
	BuyPrice_plus[i]=round(BuyPrice_plus[i]);
//сохраним цену открытия позиции	
Position_price_plus=BuyPrice_plus[i];
//запретили вход добавки
enter_long_plus=enter_long_plus+1;
//Посчитали стопы
	tp_plus=ATR_12[i]*37; if(tp_plus<=390); tp_plus=tp_plus*ATR_12[i];
	sl_plus=sl;


	
	
//Считаем и пишем все в файл
	save_log("Buy+;"+BuyPrice_plus[i]+" tp_plus="+tp_plus);
//Считаем и пишем все в файл
}
//----------------------------------------------------------------------END LONG+

///////////////////////////До этого вставляем в АТС
}
//---END authorized additive or not



														

}

////////////////////////////////////////////ЭТО КОНЕЦ ЦИКЛА//////////////////////////
/////***************************************************************************** СИСТЕМА ...
/////**************************************************************************
/////********************************************************************
/////**************************************************************
/////*******************************************************






i=i+1;//Прибавили то, что отняли

//ЕСЛИ ОСТАЛАСЬ ПОЗИЦИЯ ОТКРЫТА ПОСЧИТАЕМ ТЕКУЩИЙ РЕЗУЛЬТАТ
if (poz==-1)
{
	//Считаем и пишем все в файл
	CoverPrice[i]=Close[i];
	rez_tek=(Position_price-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Cover;"+CoverPrice[i]+";"+rez_tek+";"+rez);
	//Считаем и пишем все в файл

//Добавочка
if(poz_plus!=0)
{
CoverPrice[i]=Close[i];
	rez_tek=(Position_price_plus-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Cover+;"+CoverPrice[i]+";"+rez_tek+";"+rez);
}
//Добавочка


}

if (poz==1)
{
//Считаем и пишем все в файл
	SellPrice[i]=Close[i];
	rez_tek=(SellPrice[i]-Position_price)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Sell;"+SellPrice[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
//Добавочка
if(poz_plus!=0)
{
SellPrice_plus[i]=Close[i];
	rez_tek=(SellPrice_plus[i]-Position_price_plus)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Sell+;"+SellPrice_plus[i]+";"+rez_tek+";"+rez);
}
//Добавочка
}

//ИТОГО
	save_log("*********************TOTAL=;"+rez);
	//-До сюда кидаем на график
	
//Теперь выведим толь результат по символу
rez_simvol= fopen("C:/ami/test/testrez2.txt", "a");
	//fputs(Name()+";"+rez+";"+Oema+";"+bars+";"+fast+";"+NOTfast+";"+nomber+"\n",rez_simvol);
	fputs(Name()+";"+rez+";"+prosadka+";"+ema_exit+";"+profit_no_exit+";"+nomber+"\n",rez_simvol);
	fclose(Lf);
//Дальше концы оптимизационных циклов

}
}
}
//}
//}


////*********************************ОПТИМИЗИРУЕМ СИСТЕМА
////ОПИСАНИЕ: - Входим контртренд добавляемся по тренду плюс профит разный выход
////////////////////////Погнали, это начало оптимизационных циклов
nomber=0; // это номер по порядку для сортировки строк с одинаковыми параметрами
///ЦИКЛЫ
for( i_stop=1; i_stop <16; i_stop =i_stop +1)
{ 
for( ema_exit=150; ema_exit <270; ema_exit=ema_exit+10)
{
for( profit_no_exit=300; profit_no_exit <450; profit_no_exit=profit_no_exit+10)
{
//for( profit_no_exit=300; profit_no_exit <450; profit_no_exit=profit_no_exit+10)
//{
//for( profit_no_exit=300; profit_no_exit <450; profit_no_exit=profit_no_exit+10)
//{
nomber=nomber+1;// это номер позиции по порядку для оптимизации


/////* * * * * * * * * * * * * * * * * * * * *****************************
/////* * * * * * * * * * * * * * * * * * * * 	********************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************	
/////* * * * * * * * * * * * *********************************************************** 
/////* * * * * * * * * * * * * * * * * * * * *********************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*********************************


/////* * * * * * * * * * * * * * * * * * * * *****************************
/////* * * * * * * * * * * * * * * * * * * * 	********************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************	
/////* * * * * * * * * * * * *********************************************************** 
/////* * * * * * * * * * * * * * * * * * * * *********************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*********************************


/////* * * * * * * * * * * * * * * * * * * * *****************************
/////* * * * * * * * * * * * * * * * * * * * 	********************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************	
/////* * * * * * * * * * * * *********************************************************** 
/////* * * * * * * * * * * * * * * * * * * * *********************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*********************************



/////**************                                      СИСТЕМА ...
/////***************************************************************************** 
/////**************************************************************************
/////********************************************************************
/////**************************************************************
/////*******************************************************	
///Дальше идет сама система т.е. то, что реально будем торговать
///////ОПИСАНИЕ:
system_diskription="222-01 ";

///////////////////////////////////////////////////////// ПАРАМЕТРЫ И УСТАНОВКИ СИСТЕМЫ///////////////
/*
Установки для автоматизированной торговли и ручной
автоторговля система сама, в зависимости от состояний рынка будет определять какую систему использовать 
при ручной торговли, что использовать определяется оператором
Выбираем нужное остальное закоментировать
*/
//switchSystem = 31;//АВТОРЕЖИМ(как СУПЕР)
switchSystem = 0;//КОНТРЕНД
///switchSystem = 100000;//ТРЕНД
ExitALL=True; // true=одинаковый выход добавки т.е. пока основная поза открыта поза плюс держиться, false=соответственно разный выход
Enter_plus=True; // МОЖНО ЛИ ДОБАВЛЯТЬСЯ.

///////////////////////////////////////////////////+Инициализация переменных
Seccode = "SRZ2";// Какой контракт

poz=0;//установили позицию в начале расчета
poz_plus=0;//Добавка
k=k_plus=0;//бар на котором открыта позиция
Position_price=0;//цена по которой открылись
Position_price_plus=0;//цена по которой добавились
profit_max=0;//Максимальная прибыль за время существования позиции
Open_Short=1;//Флаг на вход после пересечения скользящих средних Short
Open_Long=1;//Флаг на вход после пересечения скользящих средних Long
stop_short=0;//счетчики стопов
stop_long=0;//счетчики стопов
Exit_Short=True;
Exit_Long=True;
Enter_Short_plus=0;//запретили вход добавочки
Enter_Long_plus=0;//запретили вход добавочки
prosadka=0;//Самый большой зафиксированный минус по системе
cover_flag=0;
sell_flag=0;
id=0;
sl=tp=sl_plus=tp_plus=0;


												
												 
													
																	
//This variables do not change												
profit=0;// результат по текущей позиции, предварительная установка
profit_plus=0;
rez=0;// Результат всего по данной системе
rez_tek=0;//Результат по текущей сделки
//profit_no_exit=400;//Прибыль после достижения которой выход до пересения средних запрещен
//ema_exit=243;//Средняя для пересечения на выход
profit_optimize= 10;//Прибыль после достижения которой разрешен второй вход
em=33;//Скользяшая средняя после которой добавляемся
ema_switch_fast_val=55;
ema_switch_slow_val=123;
the_number_of_possible_additions=2; //сколько раз можно входить после выхода добавки только для разных выходов, для одинакового выхода нге имеет смысла
//i_stop=10;
rezult=0; // результат в данной сделке после её закрытия (вспомогательная информация)
main_pozition=1;//amount of the basic position
plus_pozition=1;// amount of the plus position
////////////////////////////////////////////////-Инициализация переменных

///////////////////////////////////////////////////Установки системы
bars=7;// колво баров за которые ищется пик
fast=6;// быстрая скользящая средняя
NOTfast=9;// медленная скользящая средняя
adper=55;//для контренда, период ЕМА(О,adper) ниже(выше) которого можно открывать позицию в контренд
ATRopt=50;//период ATR(ATRopt) для определения тренд или контртренд
ATRopt2=SwitchSystem;//значение ATR(ATRopt) для определения тренд или контртренд
ts=150;//отклонение от максимального максимума по прибыли, для отработки скользящий стоп
profit_ogr=50000;//прибыль по достижению которой начинаем отслеживать скользящий стоп 
//(если не используешь скользящий стоп установить первое значение большое (такой прибыли быть не может)

//////////////////////////////////////////////////Индикаторы, линии, массивы

ema_switch_fast=EMA(O,ema_switch_fast_val);
ema_switch_slow=EMA(O,ema_switch_slow_val);

EMAO243=EMA(O,em);
ema_exit_mass=EMA(O,ema_exit);
///Линия пиков
HLine=Ref(HHV(H,bars),-1);
LLine=Ref(LLV(L,bars),-1);
///Среднии по верхам
MA_h_fast=MA(H,fast);
MA_h_NOTfast=MA(H,NOTfast);
///Среднии по низам
MA_l_fast=MA(L,fast);
MA_l_NOTfast=MA(L,NOTfast);
///Адаптивные среднии по верхам
EMA_h_fast=EMA(H,fast);
EMA_h_NOTfast=EMA(H,NOTfast);
///Адаптивные Среднии по низам
EMA_l_fast=EMA(L,fast);
EMA_l_NOTfast=EMA(L,NOTfast);
EMA_Close=EMA(C,fast);
EMAO=EMA(O,adper);
ATR_12=ATR(12);///определяем стопы;
ATRopti=ATR(ATRopt);///переключение системы
n=EndValue(BarIndex());///номер поcледнего бара
tm=TimeNum();/// масив времени баров
dm=Day(); /// массив дата
///////////////////////////////////////Procedure 

											


////////////////////////////////////////////////////КОНЕЦ ПАРАМЕТРЫ  И УСТАНОВКИ СИСТЕМЫ/////////////////////////

//НАЧАЛО ЦИКЛА ТЕСТИРОВАНИЯ
for( n = 0; n < BarCount; n++ )
{
if(n==0)
{
Lf = fopen(FileNameLog, "w");
	fputs(Name()+"Begin-------------------------------------------------------"+"\n",Lf);
	fclose(Lf);
}


//////////////////////////////////////////////////СТАРТ СИСТЕМЫ///////////////////////////////////////////
i=n;

Buy[i]=False;
Sell[i]=False;
Cover[i]=False;
Short[i]=False;	


//ПЕРЕКЛЮЧАТЕЛИ-ФЛАЖОЧКИ
Exit_short=True;//разрешили выход шорт
Exit_Long=True;//разрешили выход лонг
if (poz==-1) profit=Position_price-O[i];
if (poz_plus==-1) profit_plus=Position_price_plus-O[i];
//profit=profit+profit_plus;
if (poz==-1 AND profit>=profit_no_exit AND O[i] <=ema_exit_mass[i]) Exit_short=False;//Запретили выход если сильный тренд


if (poz==1) profit=O[i]-Position_price;
if (poz_plus==1) profit_plus=O[i]-Position_price_plus;
//profit=profit+profit_plus;
if (poz==1 AND profit>=profit_no_exit AND O[i] >=ema_exit_mass[i]) Exit_Long=False;//Запретили выход если сильный тренд

//переключатель 
if ((i>1 AND ema_switch_fast[i-1]>ema_switch_slow[i-1] AND  ema_switch_fast[i]<ema_switch_slow[i]) OR (i>1 AND ema_switch_fast[i-1]<ema_switch_slow[i-1] AND  ema_switch_fast[i]>ema_switch_slow[i]))
	{
	//open_short=1;
	//open_long=1;
	//stop_short=0;
	//stop_long=-0;
	}


///////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////ПРАВИЛА СИСТЕМЫ/////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////Выходим Основная 
/////////////////////////////////////////////////////STOPs/////////////////////////////////
//switchSystem = 0;
//if(prosadka<=1500) switchSystem = 100000;

//--------------------------------------------- SHORT - stoploss
	if (poz==-1 AND High[i]+0>=Position_price+sl AND i>k) 
{
	Cover[i]=True;
	CoverPrice[i]=Position_price+sl;
	poz=0;
	k=i;
	//если открытие выше стопа, закрываемся по открытию
	if(Open[i]>Position_price+sl)
	CoverPrice[i]=Open[i];
	CoverPrice[i]=round(CoverPrice[i]);
	//Считаем и пишем все в файл
	stoploss[i]=True;//для рисования
	rez_tek=(Position_price-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
														
	save_log("SLShort;"+CoverPrice[i]+";"+rez_tek+";"+rez);
//Переключаем запреты	
	stop_long=0;
	open_long=1;
	stop_short=stop_short+1;
			
			if(stop_short>=i_stop AND poz_plus==0) 
			{
			//switchSystem = 100000;
			ATRopt2=SwitchSystem;
			open_short=0;
				//купим 
				Buy[i]=True;
				poz=1;
				//сохраним номер бара на котором открыли позицию
				k=i;
				BuyPrice[i]=CoverPrice[i];
				Position_price=BuyPrice[i];
										
				//Считаем и пишем все в файл
				save_log("BuySwitch;"+BuyPrice[i]);
				//Считаем и пишем все в файл											
			}	

//--------------------------------------------END SHORT - stoploss
}

//--------------------------------------------LONG - stoploss
	if (poz==1 AND Low[i]+0<=Position_price-sl AND i>k) 
{
	Sell[i]=True;
	SellPrice[i]=Position_price-sl;
	poz=0;
	k=i;
//если открытие ниже стопа, выходим на открытии бара
	if(Open[i]<Position_price-sl)
	SellPrice[i]=Open[i];
	SellPrice[i]=round(SellPrice[i]);
	//Считаем и пишем все в файл
	stoploss[i]=True;//для рисования
	rez_tek=(SellPrice[i]-Position_price)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
	if(rez<=prosadka) prosadka=rez;
	//k=i+1;
														
save_log("SLBuy;"+SellPrice[i]+";"+rez_tek+";"+rez);
//переключаем флажочки
	stop_short=0;
	open_short=1;	
	stop_long=stop_long+1;
		if (stop_long>=i_stop AND poz==0) 
	{
		//switchSystem = 100000;
		ATRopt2=SwitchSystem;
		open_long=0;
		//продадим
		Short[i]=True;
		poz=-1;
		//сохраним номер бара на котором открыли позицию
		k=i;
		ShortPrice[i]=SellPrice[i];
		Position_price=ShortPrice[i];
							
			
		//Считаем и пишем все в файл
		save_log("ShortSwitch;"+ShortPrice[i]);
		//Считаем и пишем все в файл
	}
	

//--------------------------------------------------END LONG - stoploss	


}

//--------------------------------------------------LONG - take profit
	if (Exit_long==True AND poz==1 AND (High[i]+0)>=Position_price+tp AND i>k) 
{
	Sell[i]=True;
	SellPrice[i]=Position_price+tp;
	k=i;
// если открытие выше тэйка, выходим сразу на открытии
	if(Open[i]>Position_price+tp)
	SellPrice[i]=Open[i];
	SellPrice[i]=round(SellPrice[i]);
//обнулим позицию в файле 
	poz=0;
//Установили бар следующего открытия позиции
k=i;

//Считаем и пишем все в файл
	takeprofit[i]=True;//для рисования
	rez_tek=(SellPrice[i]-Position_price)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
												
	
	save_log("TPBuy;"+SellPrice[i]+";"+rez_tek+";"+rez);//Считаем и пишем все в файл

}
//-------------------------------------------------- END LONG - take profit


//---------------------------------------------------SHORT - take profit

    if (Exit_Short==True AND poz==-1 AND (Low[i]+0)<=Position_price-tp AND i>k) 
{
	Cover[i]=True;
	CoverPrice[i]=Position_price-tp;
// если открытие ниже тэйка, выходим сразу на открытии
	if (Open[i]<Position_price-tp)
	CoverPrice[i]=Open[i];
	CoverPrice[i]=round(CoverPrice[i]);
//обнулим позицию в файле 
	poz=0;
//Установили бар следующего открытия позиции
k=i;
	takeprofit[i]=True;//для рисования
	rez_tek=(Position_price-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
												
save_log("TPShort;"+CoverPrice[i]+";"+rez_tek+";"+rez);//Считаем и пишем все в файл

}
//---------------------------------------------------END SHORT - take profit

////////////////////////////////////////////////////Скользящий стоп 

//Определяем прибыль на текущем баре
if (poz==-1) profit=Position_price-Low[i];
if (poz==1) profit=High[i]-Position_price;
//Максимальная прибыль за время существования позиции
if (profit>=profit_max) profit_max=profit;

if (poz==-1 AND Position_price-High[i]<profit_max-ts AND profit_max>profit_ogr )
	{
			 	Cover[i]=True;
				poz=0;
				k=i;
				profit_max=0;
				CoverPrice[i]=High[i];
	}


if (poz==1 AND Position_price-Low[i]<profit_max-ts AND profit_max>profit_ogr)
	{
			 	Sell[i]=True;
				poz=0;
				k=i;
				profit_max=0;
				SellPrice[i]=Low[i];
	}

//////////////////////////////////////////////////Конец Скользящий стоп

/////////////////////////////////////////////////ВЫХОД ДОБАВОЧКА СТОПЫ
if(poz_plus!=0)
{
//--------------------------------------------- SHORT+ - stoploss

	if ((poz_plus==-1 AND Cover[i]==True AND ExitAll==True AND stoploss[i]==True) OR 
	(poz_plus==-1 AND High[i]+0>=Position_price_plus+sl_plus AND ExitAll==False)) 
{
	Cover_plus[i]=True;
	if(ExitALL==True) CoverPrice_plus[i]=CoverPrice[i];//одинаковый выход
	if(ExitALL==False) CoverPrice_plus[i]=Position_price_plus+sl_plus;//разный выход
	poz_plus=0;
//если открытие выше стопа, закрываемся по открытию
	if(Open[i]>Position_price_plus+sl_plus AND ExitAll==False) CoverPrice_plus[i]=Open[i]; //разный выход
	CoverPrice_plus[i]=round(CoverPrice_plus[i]);
	
//Установили бар следующего открытия позиции
k_plus=i;
//
//Open_Short=0;
//Считаем и пишем все в файл
	stoploss_plus[i]=True;//для рисования
	rez_tek=(Position_price_plus-CoverPrice_plus[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
	if(rez<=prosadka) prosadka=rez;
								
	
	save_log("SLShort+;"+CoverPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
}
//--------------------------------------------END SHORT+ - stoploss


//--------------------------------------------LONG+ - stoploss
	if ((poz_plus==1 AND Sell[i]==True AND ExitAll==True AND stoploss[i]==True) OR
	(poz_plus==1 AND Low[i]+0<=Position_price_plus-sl_plus AND ExitAll==False)) 
{
	Sell_plus[i]=True;
	if(ExitALL==True) SellPrice_plus[i]=SellPrice[i];//одинаковый выход
	if(ExitALL==False) SellPrice_plus[i]=Position_price_plus-sl_plus;//разный выход
	poz_plus=0;
//если открытие ниже стопа, выходим на открытии бара
	if(Open[i]<Position_price_plus-sl_plus AND ExitAll==False) SellPrice_plus[i]=Open[i]; //разный выход
	SellPrice_plus[i]=round(SellPrice_plus[i]);
//Установили бар следующего открытия позиции
k_plus=i;
//
//Open_Long=0;

//Считаем и пишем все в файл
	stoploss_plus[i]=True;//для рисования
	rez_tek=(SellPrice_plus[i]-Position_price_plus)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
												

	save_log("SLBuy+;"+SellPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
}
//--------------------------------------------------END LONG+ - stoploss	

//--------------------------------------------------LONG+ - take profit
	if ((poz_plus==1 AND Sell[i]==True AND ExitAll==True AND takeprofit[i]==True)  OR
	(poz_plus==1 AND High[i]>=Position_price_plus+tp_plus AND ExitAll==False)) 
{
	Sell_plus[i]=True;
	if(ExitALL==True) SellPrice_plus[i]=SellPrice[i];//одинаковый выход
	if(ExitALL==False) SellPrice_plus[i]=Position_price_plus+tp_plus;//разный выход
// если открытие выше тэйка, выходим сразу на открытии
	if(Open[i]>Position_price_plus+tp_plus AND ExitAll==False) SellPrice_plus[i]=Open[i];//разный выход
	SellPrice_plus[i]=round(SellPrice_plus[i]);
	poz_plus=0;
//Установили бар следующего открытия позиции
k_plus=i;
//Считаем и пишем все в файл
	takeprofit_plus[i]=True;//для рисования
	rez_tek=(SellPrice_plus[i]-Position_price_plus)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
									
	save_log("TPBuy+;"+SellPrice[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
}
//-------------------------------------------------- END LONG+ - take profit


//---------------------------------------------------SHORT+ - take profit
    if ((poz_plus==-1 AND Cover[i]==True AND ExitAll==True AND takeprofit[i]==True) OR
	(poz_plus==-1 AND Low[i]<=Position_price_plus-tp_plus AND ExitAll==False) ) 
{
	Cover_plus[i]=True;
	if (ExitAll==True) CoverPrice_plus[i]=CoverPrice[i];//одинаковый выход
	if (ExitAll==False) CoverPrice_plus[i]=Position_price_plus-tp_plus;//разный выход
// если открытие ниже тэйка, выходим сразу на открытии
	if (Open[i]<Position_price_plus-tp_plus AND ExitAll==False) CoverPrice_plus[i]=Open[i];
	CoverPrice_plus[i]=round(CoverPrice_plus[i]);
//обнулим позицию в файле 
	poz_plus=0;
//Установили бар следующего открытия позиции
k_plus=i;
//Считаем и пишем все в файл
	takeprofit_plus[i]=True;//для рисования
	rez_tek=(Position_price_plus-CoverPrice_plus[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
													
	save_log("TPShort+;"+CoverPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
}
//---------------------------------------------------END SHORT+ - take profit

////////////////////////////////////////////////////Скользящий стоп +
//Определяем прибыль на текущем баре
if (poz_plus==-1) profit_plus=Position_price_plus-Low[i];
if (poz_plus==1) profit_plus=High[i]-Position_price_plus;
//Максимальная прибыль за время существования позиции
if (profit>=profit_max) profit_max=profit;

if (poz==-1 AND Position_price-High[i]<profit_max-ts AND profit_max>profit_ogr )
	{
			 	Cover[i]=True;
				poz=0;
				k=i;
				profit_max=0;
				CoverPrice[i]=High[i];
	}


if (poz==1 AND Position_price-Low[i]<profit_max-ts AND profit_max>profit_ogr)
	{
			 	Sell[i]=True;
				poz=0;
				k=i;
				profit_max=0;
				SellPrice[i]=Low[i];
	}
//////////////////////////////////////////////////Конец Скользящий стоп +
}
////////////////////////////////////////////////////КОНЕЦ ВЫХОД ДОБАВОЧКА СТОПЫ




//Принимаем решение на вход выход по закрытию бара, поэтому
i=n-1;
if(i<0) i=0;

//---------------------------------------------------Выходим по правилам системы
//---------------------------------------------------SELL 
	if (Exit_long==True AND poz==1 AND High [i]+0>Lline[i]+0 AND Low[i]+0<Lline[i]+0 AND
	EMA_l_fast[i]+0<=EMA_l_NOTfast[i]+0 AND i>k AND EMA_l_fast[i]>0 AND EMA_close[i]<=Lline[i]) 
{
//
	Sell[i]=True;
	SellPrice[i]=Close[i];
	SellPrice[i]=round(SellPrice[i]);
	Sell_flag=i+1;
//
	poz=0;
	k=i;
											
//Считаем и пишем все в файл
	rez_tek=(SellPrice[i]-Position_price)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
save_log("Sell;"+SellPrice[i]+";"+rez_tek+";"+rez);//Считаем и пишем все в файл


//--------------------------------------------------END SELL
}
//--------------------------------------------------COVER
	if (Exit_Short==True AND poz==-1 AND Low[i]<Hline[i] AND High[i]>Hline[i] AND
	EMA_h_fast[i]>=EMA_h_NOTfast[i] AND i>k AND EMA_h_fast[i]>0 AND EMA_close[i]>=Hline[i]) 
{
   Cover[i]=True;
	CoverPrice[i]=Close[i];
	Cover_flag=i+1;		
	poz=0;
	k=i;
		
		CoverPrice[i]=round(CoverPrice[i]);
//Установили бар следующего открытия позиции
											
	
//Считаем и пишем все в файл
	rez_tek=(Position_price-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Cover;"+CoverPrice[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
//---------------------------------------------------END COVER


}

/////////////////////////////////////////////////////ВЫХОД ДОБАВОЧКА ПРАВИЛА СИСТЕМЫ
//---------------------------------------------------Выходим по правилам системы

//---------------------------------------------------SELL+
	if ((ExitAll==True AND Exit_long==True AND poz_plus==1 AND Sell[i]==True) OR
		(poz_plus==1 AND High [i]+0>Lline[i]+0 AND Low[i]+0<Lline[i]+0 AND 
	EMA_l_fast[i]+0<=EMA_l_NOTfast[i]+0  AND EMA_l_fast[i]>0 AND EMA_close[i]<=Lline[i] AND ExitAll==False)) 
{
//
	Sell_plus[i]=True;
	SellPrice_plus[i]=Close[i];
	SellPrice_plus[i]=round(SellPrice_plus[i]);
//
	poz_plus=0;
											
	
//Считаем и пишем все в файл
	rez_tek=(SellPrice_plus[i]-Position_price_plus)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Sell+;"+SellPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
//--------------------------------------------------END SELL+

}
//--------------------------------------------------COVER+
	if ((ExitAll==True AND Exit_short==True AND poz_plus==-1 AND Cover[i]==True ) OR
	(poz_plus==-1 AND Low[i]<Hline[i] AND High[i]>Hline[i] AND
	EMA_h_fast[i]>=EMA_h_NOTfast[i]  AND EMA_h_fast[i]>0 AND EMA_close[i]>=Hline[i] AND ExitAll==False)) 
{
    Cover_plus[i]=True;
	CoverPrice_plus[i]=Close[i];
	poz_plus=0;
	CoverPrice_plus[i]=round(CoverPrice_plus[i]);
//Установили бар следующего открытия позиции
												
//Считаем и пишем все в файл
	rez_tek=(Position_price_plus-CoverPrice_plus[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Cover+;"+CoverPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
//---------------------------------------------------END COVER+
}

///////////////////////////////////КОНЕЦ ВЫХОД ДОБАВОЧКА ПРАВИЛА СИСТЕМЫ////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////// Входим
//----------------------------------------------------------------------LONG
	if (poz_plus==0 AND Open_Long==1 AND Low[i]<Hline[i] AND High[i]>Hline[i]  AND
	poz==0 AND EMA_h_fast[i]>=EMA_h_NOTfast[i] AND i>=sell_flag AND i>=k AND EMAO[i]>=Hline[i] AND ATRopti[i]>=ATRopt2 OR
	Low[i]<Hline[i] AND High[i]>Hline[i]  AND poz==0 AND EMA_h_fast[i]>=EMA_h_NOTfast[i] AND
	i>=sell_flag AND i>=k AND	ATRopti[i]<ATRopt2)
{ 
	Buy[i]=True;
	poz=1;
//сохраним номер бара на котором открыли позицию
	k=i;
	BuyPrice[i]=Close[i];
	BuyPrice[i]=round(BuyPrice[i]);
//обнулил счетчик стопов
stop_short=0;//счетчики стопов
switchSystem = 0;
ATRopt2=SwitchSystem;
Open_Short=1;
//разрешили вход добавки
enter_long_plus=0;
//сохраним цену открытия позиции	
Position_price=BuyPrice[i];
//Посчитали стопы
tp=ATR_12[i]*37;
sl=ATR_12[i]*10;
if(sl>150)sl=150;
								

//Считаем и пишем все в файл
	save_log("Buy;"+BuyPrice[i]+" tp="+tp);
//Считаем и пишем все в файл
//----------------------------------------------------------------------END LONG
} 




//----------------------------------------------------------------------SHORT
	if( poz_plus==0 AND Open_Short==1 AND (High[i]>Lline[i] AND Lline[i]>Low[i] AND
	poz==0 AND EMA_l_fast[i]<=EMA_l_NOTfast[i] AND i>=cover_flag AND i>=k AND EMAO[i]<=Lline[i] AND ATRopti[i]>=ATRopt2  ) OR 
	(High[i]>Lline[i] AND Lline[i]>Low[i] AND poz==0 AND EMA_l_fast[i]<=EMA_l_NOTfast[i] AND
	i>=cover_flag AND i>=k AND ATRopti[i]<ATRopt2))
{ 
	Short[i]=True;
	poz=-1;
//сохраним номер бара на котором открыли позицию
	k=i;
	ShortPrice[i]=Close[i];
	ShortPrice[i]=round(ShortPrice[i]);
//обнулил счетчик стопов
stop_long=0;//счетчики стопов
Open_Long=1;
switchSystem = 0;
ATRopt2=SwitchSystem;
//разрешили вход добавки
enter_short_plus=0;
//сохраним цену открытия позиции
	Position_price=ShortPrice[i];
//Посчитали стопы
	tp=ATR_12[i]*37;
	sl=ATR_12[i]*10;
	if(sl>150)sl=150;
								

//Считаем и пишем все в файл
	save_log("Short;"+ShortPrice[i]+" tp="+tp);
//Считаем и пишем все в файл
//----------------------------------------------------------------------END SHORT
}




if(enter_plus==True) //authorized additive or not
{
//----------------------------------------------------------------------Добавляемся
if (poz==-1) profit=Position_price-Low[i];
if (poz==1) profit=High[i]-Position_price;

//----------------------------------------------------------------------SHORT+
if(i>=k_plus AND enter_short_plus<the_number_of_possible_additions AND profit>=profit_optimize AND
 poz_plus==0 AND High[i]>Lline[i] AND Lline[i]>Low[i] AND poz==-1 AND EMA_l_fast[i]<=EMA_l_NOTfast[i] AND
 i>=cover_flag AND EMAO243[i]>Hline[i]) 
{
	Short_plus[i]=True;
	poz_plus=-1;
//Save number for the bar which is open position
	k_plus=i;
	ShortPrice_plus[i]=Close[i];
	ShortPrice_plus[i]=round(ShortPrice_plus[i]);
//запретили вход добавки
enter_short_plus=enter_short_plus+1;
//сохраним цену открытия позиции
	Position_price_plus=ShortPrice_plus[i];
//Посчитали стопы
	tp_plus=ATR_12[i]*37; if(tp_plus<=390); tp_plus=tp_plus*ATR_12[i];
	sl_plus=sl;
//Считаем и пишем все в файл
	save_log("Short+;"+ShortPrice_plus[i]+" tp_plus="+tp_plus);
//Считаем и пишем все в файл
//----------------------------------------------------------------------END SHORT+

}
//----------------------------------------------------------------------LONG+	
if(i>=k_plus AND enter_Long_plus<the_number_of_possible_additions AND profit>=profit_optimize AND
 poz_plus==0 AND Low[i]<Hline[i] AND High[i]>Hline[i]  AND poz==1 AND EMA_h_fast[i]>=EMA_h_NOTfast[i] AND
 i>=sell_flag  AND EMAO243[i]<Hline[i])
{ 
	Buy_plus[i]=True;
	poz_plus=1;
//сохраним номер бара на котором открыли позицию
	k_plus=i;
	BuyPrice_plus[i]=Close[i];
	BuyPrice_plus[i]=round(BuyPrice_plus[i]);
//сохраним цену открытия позиции	
Position_price_plus=BuyPrice_plus[i];
//запретили вход добавки
enter_long_plus=enter_long_plus+1;
//Посчитали стопы
	tp_plus=ATR_12[i]*37; if(tp_plus<=390); tp_plus=tp_plus*ATR_12[i];
	sl_plus=sl;


	
	
//Считаем и пишем все в файл
	save_log("Buy+;"+BuyPrice_plus[i]+" tp_plus="+tp_plus);
//Считаем и пишем все в файл
}
//----------------------------------------------------------------------END LONG+

///////////////////////////До этого вставляем в АТС
}
//---END authorized additive or not



														

}

////////////////////////////////////////////ЭТО КОНЕЦ ЦИКЛА//////////////////////////
/////***************************************************************************** СИСТЕМА ...
/////**************************************************************************
/////********************************************************************
/////**************************************************************
/////*******************************************************






i=i+1;//Прибавили то, что отняли

//ЕСЛИ ОСТАЛАСЬ ПОЗИЦИЯ ОТКРЫТА ПОСЧИТАЕМ ТЕКУЩИЙ РЕЗУЛЬТАТ
if (poz==-1)
{
	//Считаем и пишем все в файл
	CoverPrice[i]=Close[i];
	rez_tek=(Position_price-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Cover;"+CoverPrice[i]+";"+rez_tek+";"+rez);
	//Считаем и пишем все в файл

//Добавочка
if(poz_plus!=0)
{
CoverPrice[i]=Close[i];
	rez_tek=(Position_price_plus-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Cover+;"+CoverPrice[i]+";"+rez_tek+";"+rez);
}
//Добавочка


}

if (poz==1)
{
//Считаем и пишем все в файл
	SellPrice[i]=Close[i];
	rez_tek=(SellPrice[i]-Position_price)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Sell;"+SellPrice[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
//Добавочка
if(poz_plus!=0)
{
SellPrice_plus[i]=Close[i];
	rez_tek=(SellPrice_plus[i]-Position_price_plus)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Sell+;"+SellPrice_plus[i]+";"+rez_tek+";"+rez);
}
//Добавочка
}

//ИТОГО
	save_log("*********************TOTAL=;"+rez);
	//-До сюда кидаем на график
	
//Теперь выведим толь результат по символу
rez_simvol= fopen("C:/ami/test/testrez3.txt", "a");
	//fputs(Name()+";"+rez+";"+Oema+";"+bars+";"+fast+";"+NOTfast+";"+nomber+"\n",rez_simvol);
	fputs(Name()+";"+rez+";"+prosadka+";"+ema_exit+";"+profit_no_exit+";"+nomber+"\n",rez_simvol);
	fclose(Lf);
//Дальше концы оптимизационных циклов

}
}
}
//}
//}


////*********************************ОПТИМИЗИРУЕМ СИСТЕМА
////ОПИСАНИЕ: - Входим контртренд добавляемся по тренду плюс профит разный выход
////////////////////////Погнали, это начало оптимизационных циклов
nomber=0; // это номер по порядку для сортировки строк с одинаковыми параметрами
///ЦИКЛЫ
for( i_stop=1; i_stop <16; i_stop =i_stop +1)
{ 
for( ema_exit=150; ema_exit <270; ema_exit=ema_exit+10)
{
for( profit_no_exit=300; profit_no_exit <450; profit_no_exit=profit_no_exit+10)
{
//for( profit_no_exit=300; profit_no_exit <450; profit_no_exit=profit_no_exit+10)
//{
//for( profit_no_exit=300; profit_no_exit <450; profit_no_exit=profit_no_exit+10)
//{
nomber=nomber+1;// это номер позиции по порядку для оптимизации


/////* * * * * * * * * * * * * * * * * * * * *****************************
/////* * * * * * * * * * * * * * * * * * * * 	********************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************	
/////* * * * * * * * * * * * *********************************************************** 
/////* * * * * * * * * * * * * * * * * * * * *********************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*********************************


/////* * * * * * * * * * * * * * * * * * * * *****************************
/////* * * * * * * * * * * * * * * * * * * * 	********************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************	
/////* * * * * * * * * * * * *********************************************************** 
/////* * * * * * * * * * * * * * * * * * * * *********************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*********************************


/////* * * * * * * * * * * * * * * * * * * * *****************************
/////* * * * * * * * * * * * * * * * * * * * 	********************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************	
/////* * * * * * * * * * * * *********************************************************** 
/////* * * * * * * * * * * * * * * * * * * * *********************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*********************************



/////**************                                      СИСТЕМА ...
/////***************************************************************************** 
/////**************************************************************************
/////********************************************************************
/////**************************************************************
/////*******************************************************	
///Дальше идет сама система т.е. то, что реально будем торговать
///////ОПИСАНИЕ:
system_diskription="222-01 ";

///////////////////////////////////////////////////////// ПАРАМЕТРЫ И УСТАНОВКИ СИСТЕМЫ///////////////
/*
Установки для автоматизированной торговли и ручной
автоторговля система сама, в зависимости от состояний рынка будет определять какую систему использовать 
при ручной торговли, что использовать определяется оператором
Выбираем нужное остальное закоментировать
*/
//switchSystem = 31;//АВТОРЕЖИМ(как СУПЕР)
switchSystem = 0;//КОНТРЕНД
///switchSystem = 100000;//ТРЕНД
ExitALL=True; // true=одинаковый выход добавки т.е. пока основная поза открыта поза плюс держиться, false=соответственно разный выход
Enter_plus=True; // МОЖНО ЛИ ДОБАВЛЯТЬСЯ.

///////////////////////////////////////////////////+Инициализация переменных
Seccode = "SRZ2";// Какой контракт

poz=0;//установили позицию в начале расчета
poz_plus=0;//Добавка
k=k_plus=0;//бар на котором открыта позиция
Position_price=0;//цена по которой открылись
Position_price_plus=0;//цена по которой добавились
profit_max=0;//Максимальная прибыль за время существования позиции
Open_Short=1;//Флаг на вход после пересечения скользящих средних Short
Open_Long=1;//Флаг на вход после пересечения скользящих средних Long
stop_short=0;//счетчики стопов
stop_long=0;//счетчики стопов
Exit_Short=True;
Exit_Long=True;
Enter_Short_plus=0;//запретили вход добавочки
Enter_Long_plus=0;//запретили вход добавочки
prosadka=0;//Самый большой зафиксированный минус по системе
cover_flag=0;
sell_flag=0;
id=0;
sl=tp=sl_plus=tp_plus=0;


												
														
																	
//This variables do not change												
profit=0;// результат по текущей позиции, предварительная установка
profit_plus=0;
rez=0;// Результат всего по данной системе
rez_tek=0;//Результат по текущей сделки
//profit_no_exit=400;//Прибыль после достижения которой выход до пересения средних запрещен
//ema_exit=243;//Средняя для пересечения на выход
profit_optimize= 10;//Прибыль после достижения которой разрешен второй вход
em=33;//Скользяшая средняя после которой добавляемся
ema_switch_fast_val=55;
ema_switch_slow_val=123;
the_number_of_possible_additions=2; //сколько раз можно входить после выхода добавки только для разных выходов, для одинакового выхода нге имеет смысла
//i_stop=10;
rezult=0; // результат в данной сделке после её закрытия (вспомогательная информация)
main_pozition=1;//amount of the basic position
plus_pozition=1;// amount of the plus position
////////////////////////////////////////////////-Инициализация переменных

///////////////////////////////////////////////////Установки системы
bars=7;// колво баров за которые ищется пик
fast=6;// быстрая скользящая средняя
NOTfast=9;// медленная скользящая средняя
adper=55;//для контренда, период ЕМА(О,adper) ниже(выше) которого можно открывать позицию в контренд
ATRopt=50;//период ATR(ATRopt) для определения тренд или контртренд
ATRopt2=SwitchSystem;//значение ATR(ATRopt) для определения тренд или контртренд
ts=150;//отклонение от максимального максимума по прибыли, для отработки скользящий стоп
profit_ogr=50000;//прибыль по достижению которой начинаем отслеживать скользящий стоп 
//(если не используешь скользящий стоп установить первое значение большое (такой прибыли быть не может)

//////////////////////////////////////////////////Индикаторы, линии, массивы

ema_switch_fast=EMA(O,ema_switch_fast_val);
ema_switch_slow=EMA(O,ema_switch_slow_val);

EMAO243=EMA(O,em);
ema_exit_mass=EMA(O,ema_exit);
///Линия пиков
HLine=Ref(HHV(H,bars),-1);
LLine=Ref(LLV(L,bars),-1);
///Среднии по верхам
MA_h_fast=MA(H,fast);
MA_h_NOTfast=MA(H,NOTfast);
///Среднии по низам
MA_l_fast=MA(L,fast);
MA_l_NOTfast=MA(L,NOTfast);
///Адаптивные среднии по верхам
EMA_h_fast=EMA(H,fast);
EMA_h_NOTfast=EMA(H,NOTfast);
///Адаптивные Среднии по низам
EMA_l_fast=EMA(L,fast);
EMA_l_NOTfast=EMA(L,NOTfast);
EMA_Close=EMA(C,fast);
EMAO=EMA(O,adper);
ATR_12=ATR(12);///определяем стопы;
ATRopti=ATR(ATRopt);///переключение системы
n=EndValue(BarIndex());///номер поcледнего бара
tm=TimeNum();/// масив времени баров
dm=Day(); /// массив дата
///////////////////////////////////////Procedure 

											


////////////////////////////////////////////////////КОНЕЦ ПАРАМЕТРЫ  И УСТАНОВКИ СИСТЕМЫ/////////////////////////

//НАЧАЛО ЦИКЛА ТЕСТИРОВАНИЯ
for( n = 0; n < BarCount; n++ )
{
if(n==0)
{
Lf = fopen(FileNameLog, "w");
	fputs(Name()+"Begin-------------------------------------------------------"+"\n",Lf);
	fclose(Lf);
}


//////////////////////////////////////////////////СТАРТ СИСТЕМЫ///////////////////////////////////////////
i=n;

Buy[i]=False;
Sell[i]=False;
Cover[i]=False;
Short[i]=False;	


//ПЕРЕКЛЮЧАТЕЛИ-ФЛАЖОЧКИ
Exit_short=True;//разрешили выход шорт
Exit_Long=True;//разрешили выход лонг
if (poz==-1) profit=Position_price-O[i];
if (poz_plus==-1) profit_plus=Position_price_plus-O[i];
//profit=profit+profit_plus;
if (poz==-1 AND profit>=profit_no_exit AND O[i] <=ema_exit_mass[i]) Exit_short=False;//Запретили выход если сильный тренд


if (poz==1) profit=O[i]-Position_price;
if (poz_plus==1) profit_plus=O[i]-Position_price_plus;
//profit=profit+profit_plus;
if (poz==1 AND profit>=profit_no_exit AND O[i] >=ema_exit_mass[i]) Exit_Long=False;//Запретили выход если сильный тренд

//переключатель 
if ((i>1 AND ema_switch_fast[i-1]>ema_switch_slow[i-1] AND  ema_switch_fast[i]<ema_switch_slow[i]) OR (i>1 AND ema_switch_fast[i-1]<ema_switch_slow[i-1] AND  ema_switch_fast[i]>ema_switch_slow[i]))
	{
	//open_short=1;
	//open_long=1;
	//stop_short=0;
	//stop_long=-0;
	}


///////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////ПРАВИЛА СИСТЕМЫ/////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////Выходим Основная 
/////////////////////////////////////////////////////STOPs/////////////////////////////////
//switchSystem = 0;
//if(prosadka<=1500) switchSystem = 100000;

//--------------------------------------------- SHORT - stoploss
	if (poz==-1 AND High[i]+0>=Position_price+sl AND i>k) 
{
	Cover[i]=True;
	CoverPrice[i]=Position_price+sl;
	poz=0;
	k=i;
	//если открытие выше стопа, закрываемся по открытию
	if(Open[i]>Position_price+sl)
	CoverPrice[i]=Open[i];
	CoverPrice[i]=round(CoverPrice[i]);
	//Считаем и пишем все в файл
	stoploss[i]=True;//для рисования
	rez_tek=(Position_price-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
														
	save_log("SLShort;"+CoverPrice[i]+";"+rez_tek+";"+rez);
//Переключаем запреты	
	stop_long=0;
	open_long=1;
	stop_short=stop_short+1;
			
			if(stop_short>=i_stop AND poz_plus==0) 
			{
			//switchSystem = 100000;
			ATRopt2=SwitchSystem;
			open_short=0;
				//купим 
				Buy[i]=True;
				poz=1;
				//сохраним номер бара на котором открыли позицию
				k=i;
				BuyPrice[i]=CoverPrice[i];
				Position_price=BuyPrice[i];
										
				//Считаем и пишем все в файл
				save_log("BuySwitch;"+BuyPrice[i]);
				//Считаем и пишем все в файл											
			}	

//--------------------------------------------END SHORT - stoploss
}

//--------------------------------------------LONG - stoploss
	if (poz==1 AND Low[i]+0<=Position_price-sl AND i>k) 
{
	Sell[i]=True;
	SellPrice[i]=Position_price-sl;
	poz=0;
	k=i;
//если открытие ниже стопа, выходим на открытии бара
	if(Open[i]<Position_price-sl)
	SellPrice[i]=Open[i];
	SellPrice[i]=round(SellPrice[i]);
	//Считаем и пишем все в файл
	stoploss[i]=True;//для рисования
	rez_tek=(SellPrice[i]-Position_price)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
	if(rez<=prosadka) prosadka=rez;
	//k=i+1;
														
save_log("SLBuy;"+SellPrice[i]+";"+rez_tek+";"+rez);
//переключаем флажочки
	stop_short=0;
	open_short=1;	
	stop_long=stop_long+1;
		if (stop_long>=i_stop AND poz==0) 
	{
		//switchSystem = 100000;
		ATRopt2=SwitchSystem;
		open_long=0;
		//продадим
		Short[i]=True;
		poz=-1;
		//сохраним номер бара на котором открыли позицию
		k=i;
		ShortPrice[i]=SellPrice[i];
		Position_price=ShortPrice[i];
							
			
		//Считаем и пишем все в файл
		save_log("ShortSwitch;"+ShortPrice[i]);
		//Считаем и пишем все в файл
	}
	

//--------------------------------------------------END LONG - stoploss	


}

//--------------------------------------------------LONG - take profit
	if (Exit_long==True AND poz==1 AND (High[i]+0)>=Position_price+tp AND i>k) 
{
	Sell[i]=True;
	SellPrice[i]=Position_price+tp;
	k=i;
// если открытие выше тэйка, выходим сразу на открытии
	if(Open[i]>Position_price+tp)
	SellPrice[i]=Open[i];
	SellPrice[i]=round(SellPrice[i]);
//обнулим позицию в файле 
	poz=0;
//Установили бар следующего открытия позиции
k=i;

//Считаем и пишем все в файл
	takeprofit[i]=True;//для рисования
	rez_tek=(SellPrice[i]-Position_price)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
												
	
	save_log("TPBuy;"+SellPrice[i]+";"+rez_tek+";"+rez);//Считаем и пишем все в файл

}
//-------------------------------------------------- END LONG - take profit


//---------------------------------------------------SHORT - take profit

    if (Exit_Short==True AND poz==-1 AND (Low[i]+0)<=Position_price-tp AND i>k) 
{
	Cover[i]=True;
	CoverPrice[i]=Position_price-tp;
// если открытие ниже тэйка, выходим сразу на открытии
	if (Open[i]<Position_price-tp)
	CoverPrice[i]=Open[i];
	CoverPrice[i]=round(CoverPrice[i]);
//обнулим позицию в файле 
	poz=0;
//Установили бар следующего открытия позиции
k=i;
	takeprofit[i]=True;//для рисования
	rez_tek=(Position_price-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
												
save_log("TPShort;"+CoverPrice[i]+";"+rez_tek+";"+rez);//Считаем и пишем все в файл

}
//---------------------------------------------------END SHORT - take profit

////////////////////////////////////////////////////Скользящий стоп 

//Определяем прибыль на текущем баре
if (poz==-1) profit=Position_price-Low[i];
if (poz==1) profit=High[i]-Position_price;
//Максимальная прибыль за время существования позиции
if (profit>=profit_max) profit_max=profit;

if (poz==-1 AND Position_price-High[i]<profit_max-ts AND profit_max>profit_ogr )
	{
			 	Cover[i]=True;
				poz=0;
				k=i;
				profit_max=0;
				CoverPrice[i]=High[i];
	}


if (poz==1 AND Position_price-Low[i]<profit_max-ts AND profit_max>profit_ogr)
	{
			 	Sell[i]=True;
				poz=0;
				k=i;
				profit_max=0;
				SellPrice[i]=Low[i];
	}

//////////////////////////////////////////////////Конец Скользящий стоп

/////////////////////////////////////////////////ВЫХОД ДОБАВОЧКА СТОПЫ
if(poz_plus!=0)
{
//--------------------------------------------- SHORT+ - stoploss

	if ((poz_plus==-1 AND Cover[i]==True AND ExitAll==True AND stoploss[i]==True) OR 
	(poz_plus==-1 AND High[i]+0>=Position_price_plus+sl_plus AND ExitAll==False)) 
{
	Cover_plus[i]=True;
	if(ExitALL==True) CoverPrice_plus[i]=CoverPrice[i];//одинаковый выход
	if(ExitALL==False) CoverPrice_plus[i]=Position_price_plus+sl_plus;//разный выход
	poz_plus=0;
//если открытие выше стопа, закрываемся по открытию
	if(Open[i]>Position_price_plus+sl_plus AND ExitAll==False) CoverPrice_plus[i]=Open[i]; //разный выход
	CoverPrice_plus[i]=round(CoverPrice_plus[i]);
	
//Установили бар следующего открытия позиции
k_plus=i;
//
//Open_Short=0;
//Считаем и пишем все в файл
	stoploss_plus[i]=True;//для рисования
	rez_tek=(Position_price_plus-CoverPrice_plus[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
	if(rez<=prosadka) prosadka=rez;
								
	
	save_log("SLShort+;"+CoverPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
}
//--------------------------------------------END SHORT+ - stoploss


//--------------------------------------------LONG+ - stoploss
	if ((poz_plus==1 AND Sell[i]==True AND ExitAll==True AND stoploss[i]==True) OR
	(poz_plus==1 AND Low[i]+0<=Position_price_plus-sl_plus AND ExitAll==False)) 
{
	Sell_plus[i]=True;
	if(ExitALL==True) SellPrice_plus[i]=SellPrice[i];//одинаковый выход
	if(ExitALL==False) SellPrice_plus[i]=Position_price_plus-sl_plus;//разный выход
	poz_plus=0;
//если открытие ниже стопа, выходим на открытии бара
	if(Open[i]<Position_price_plus-sl_plus AND ExitAll==False) SellPrice_plus[i]=Open[i]; //разный выход
	SellPrice_plus[i]=round(SellPrice_plus[i]);
//Установили бар следующего открытия позиции
k_plus=i;
//
//Open_Long=0;

//Считаем и пишем все в файл
	stoploss_plus[i]=True;//для рисования
	rez_tek=(SellPrice_plus[i]-Position_price_plus)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
												

	save_log("SLBuy+;"+SellPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
}
//--------------------------------------------------END LONG+ - stoploss	

//--------------------------------------------------LONG+ - take profit
	if ((poz_plus==1 AND Sell[i]==True AND ExitAll==True AND takeprofit[i]==True)  OR
	(poz_plus==1 AND High[i]>=Position_price_plus+tp_plus AND ExitAll==False)) 
{
	Sell_plus[i]=True;
	if(ExitALL==True) SellPrice_plus[i]=SellPrice[i];//одинаковый выход
	if(ExitALL==False) SellPrice_plus[i]=Position_price_plus+tp_plus;//разный выход
// если открытие выше тэйка, выходим сразу на открытии
	if(Open[i]>Position_price_plus+tp_plus AND ExitAll==False) SellPrice_plus[i]=Open[i];//разный выход
	SellPrice_plus[i]=round(SellPrice_plus[i]);
	poz_plus=0;
//Установили бар следующего открытия позиции
k_plus=i;
//Считаем и пишем все в файл
	takeprofit_plus[i]=True;//для рисования
	rez_tek=(SellPrice_plus[i]-Position_price_plus)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
									
	save_log("TPBuy+;"+SellPrice[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
}
//-------------------------------------------------- END LONG+ - take profit


//---------------------------------------------------SHORT+ - take profit
    if ((poz_plus==-1 AND Cover[i]==True AND ExitAll==True AND takeprofit[i]==True) OR
	(poz_plus==-1 AND Low[i]<=Position_price_plus-tp_plus AND ExitAll==False) ) 
{
	Cover_plus[i]=True;
	if (ExitAll==True) CoverPrice_plus[i]=CoverPrice[i];//одинаковый выход
	if (ExitAll==False) CoverPrice_plus[i]=Position_price_plus-tp_plus;//разный выход
// если открытие ниже тэйка, выходим сразу на открытии
	if (Open[i]<Position_price_plus-tp_plus AND ExitAll==False) CoverPrice_plus[i]=Open[i];
	CoverPrice_plus[i]=round(CoverPrice_plus[i]);
//обнулим позицию в файле 
	poz_plus=0;
//Установили бар следующего открытия позиции
k_plus=i;
//Считаем и пишем все в файл
	takeprofit_plus[i]=True;//для рисования
	rez_tek=(Position_price_plus-CoverPrice_plus[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
													
	save_log("TPShort+;"+CoverPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
}
//---------------------------------------------------END SHORT+ - take profit

////////////////////////////////////////////////////Скользящий стоп +
//Определяем прибыль на текущем баре
if (poz_plus==-1) profit_plus=Position_price_plus-Low[i];
if (poz_plus==1) profit_plus=High[i]-Position_price_plus;
//Максимальная прибыль за время существования позиции
if (profit>=profit_max) profit_max=profit;

if (poz==-1 AND Position_price-High[i]<profit_max-ts AND profit_max>profit_ogr )
	{
			 	Cover[i]=True;
				poz=0;
				k=i;
				profit_max=0;
				CoverPrice[i]=High[i];
	}


if (poz==1 AND Position_price-Low[i]<profit_max-ts AND profit_max>profit_ogr)
	{
			 	Sell[i]=True;
				poz=0;
				k=i;
				profit_max=0;
				SellPrice[i]=Low[i];
	}
//////////////////////////////////////////////////Конец Скользящий стоп +
}
////////////////////////////////////////////////////КОНЕЦ ВЫХОД ДОБАВОЧКА СТОПЫ




//Принимаем решение на вход выход по закрытию бара, поэтому
i=n-1;
if(i<0) i=0;

//---------------------------------------------------Выходим по правилам системы
//---------------------------------------------------SELL 
	if (Exit_long==True AND poz==1 AND High [i]+0>Lline[i]+0 AND Low[i]+0<Lline[i]+0 AND
	EMA_l_fast[i]+0<=EMA_l_NOTfast[i]+0 AND i>k AND EMA_l_fast[i]>0 AND EMA_close[i]<=Lline[i]) 
{
//
	Sell[i]=True;
	SellPrice[i]=Close[i];
	SellPrice[i]=round(SellPrice[i]);
	Sell_flag=i+1;
//
	poz=0;
	k=i;
											
//Считаем и пишем все в файл
	rez_tek=(SellPrice[i]-Position_price)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
save_log("Sell;"+SellPrice[i]+";"+rez_tek+";"+rez);//Считаем и пишем все в файл


//--------------------------------------------------END SELL
}
//--------------------------------------------------COVER
	if (Exit_Short==True AND poz==-1 AND Low[i]<Hline[i] AND High[i]>Hline[i] AND
	EMA_h_fast[i]>=EMA_h_NOTfast[i] AND i>k AND EMA_h_fast[i]>0 AND EMA_close[i]>=Hline[i]) 
{
   Cover[i]=True;
	CoverPrice[i]=Close[i];
	Cover_flag=i+1;		
	poz=0;
	k=i;
		
		CoverPrice[i]=round(CoverPrice[i]);
//Установили бар следующего открытия позиции
											
	
//Считаем и пишем все в файл
	rez_tek=(Position_price-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Cover;"+CoverPrice[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
//---------------------------------------------------END COVER


}

/////////////////////////////////////////////////////ВЫХОД ДОБАВОЧКА ПРАВИЛА СИСТЕМЫ
//---------------------------------------------------Выходим по правилам системы

//---------------------------------------------------SELL+
	if ((ExitAll==True AND Exit_long==True AND poz_plus==1 AND Sell[i]==True) OR
		(poz_plus==1 AND High [i]+0>Lline[i]+0 AND Low[i]+0<Lline[i]+0 AND 
	EMA_l_fast[i]+0<=EMA_l_NOTfast[i]+0  AND EMA_l_fast[i]>0 AND EMA_close[i]<=Lline[i] AND ExitAll==False)) 
{
//
	Sell_plus[i]=True;
	SellPrice_plus[i]=Close[i];
	SellPrice_plus[i]=round(SellPrice_plus[i]);
//
	poz_plus=0;
											
	
//Считаем и пишем все в файл
	rez_tek=(SellPrice_plus[i]-Position_price_plus)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Sell+;"+SellPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
//--------------------------------------------------END SELL+

}
//--------------------------------------------------COVER+
	if ((ExitAll==True AND Exit_short==True AND poz_plus==-1 AND Cover[i]==True ) OR
	(poz_plus==-1 AND Low[i]<Hline[i] AND High[i]>Hline[i] AND
	EMA_h_fast[i]>=EMA_h_NOTfast[i]  AND EMA_h_fast[i]>0 AND EMA_close[i]>=Hline[i] AND ExitAll==False)) 
{
    Cover_plus[i]=True;
	CoverPrice_plus[i]=Close[i];
	poz_plus=0;
	CoverPrice_plus[i]=round(CoverPrice_plus[i]);
//Установили бар следующего открытия позиции
												
//Считаем и пишем все в файл
	rez_tek=(Position_price_plus-CoverPrice_plus[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Cover+;"+CoverPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
//---------------------------------------------------END COVER+
}

///////////////////////////////////КОНЕЦ ВЫХОД ДОБАВОЧКА ПРАВИЛА СИСТЕМЫ////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////// Входим
//----------------------------------------------------------------------LONG
	if (poz_plus==0 AND Open_Long==1 AND Low[i]<Hline[i] AND High[i]>Hline[i]  AND
	poz==0 AND EMA_h_fast[i]>=EMA_h_NOTfast[i] AND i>=sell_flag AND i>=k AND EMAO[i]>=Hline[i] AND ATRopti[i]>=ATRopt2 OR
	Low[i]<Hline[i] AND High[i]>Hline[i]  AND poz==0 AND EMA_h_fast[i]>=EMA_h_NOTfast[i] AND
	i>=sell_flag AND i>=k AND	ATRopti[i]<ATRopt2)
{ 
	Buy[i]=True;
	poz=1;
//сохраним номер бара на котором открыли позицию
	k=i;
	BuyPrice[i]=Close[i];
	BuyPrice[i]=round(BuyPrice[i]);
//обнулил счетчик стопов
stop_short=0;//счетчики стопов
switchSystem = 0;
ATRopt2=SwitchSystem;
Open_Short=1;
//разрешили вход добавки
enter_long_plus=0;
//сохраним цену открытия позиции	
Position_price=BuyPrice[i];
//Посчитали стопы
tp=ATR_12[i]*37;
sl=ATR_12[i]*10;
if(sl>150)sl=150;
								

//Считаем и пишем все в файл
	save_log("Buy;"+BuyPrice[i]+" tp="+tp);
//Считаем и пишем все в файл
//----------------------------------------------------------------------END LONG
} 




//----------------------------------------------------------------------SHORT
	if( poz_plus==0 AND Open_Short==1 AND (High[i]>Lline[i] AND Lline[i]>Low[i] AND
	poz==0 AND EMA_l_fast[i]<=EMA_l_NOTfast[i] AND i>=cover_flag AND i>=k AND EMAO[i]<=Lline[i] AND ATRopti[i]>=ATRopt2  ) OR 
	(High[i]>Lline[i] AND Lline[i]>Low[i] AND poz==0 AND EMA_l_fast[i]<=EMA_l_NOTfast[i] AND
	i>=cover_flag AND i>=k AND ATRopti[i]<ATRopt2))
{ 
	Short[i]=True;
	poz=-1;
//сохраним номер бара на котором открыли позицию
	k=i;
	ShortPrice[i]=Close[i];
	ShortPrice[i]=round(ShortPrice[i]);
//обнулил счетчик стопов
stop_long=0;//счетчики стопов
Open_Long=1;
switchSystem = 0;
ATRopt2=SwitchSystem;
//разрешили вход добавки
enter_short_plus=0;
//сохраним цену открытия позиции
	Position_price=ShortPrice[i];
//Посчитали стопы
	tp=ATR_12[i]*37;
	sl=ATR_12[i]*10;
	if(sl>150)sl=150;
								

//Считаем и пишем все в файл
	save_log("Short;"+ShortPrice[i]+" tp="+tp);
//Считаем и пишем все в файл
//----------------------------------------------------------------------END SHORT
}




if(enter_plus==True) //authorized additive or not
{
//----------------------------------------------------------------------Добавляемся
//if (poz==-1) profit=Position_price-Low[i];
//if (poz==1) profit=High[i]-Position_price;

//----------------------------------------------------------------------SHORT+
if(i>=k_plus AND enter_short_plus<the_number_of_possible_additions AND profit>=profit_optimize AND
 poz_plus==0 AND High[i]>Lline[i] AND Lline[i]>Low[i] AND poz==-1 AND EMA_l_fast[i]<=EMA_l_NOTfast[i] AND
 i>=cover_flag AND EMAO243[i]>Hline[i]) 
{
	Short_plus[i]=True;
	poz_plus=-1;
//Save number for the bar which is open position
	k_plus=i;
	ShortPrice_plus[i]=Close[i];
	ShortPrice_plus[i]=round(ShortPrice_plus[i]);
//запретили вход добавки
enter_short_plus=enter_short_plus+1;
//сохраним цену открытия позиции
	Position_price_plus=ShortPrice_plus[i];
//Посчитали стопы
	tp_plus=ATR_12[i]*37; if(tp_plus<=390); tp_plus=tp_plus*ATR_12[i];
	sl_plus=sl;
//Считаем и пишем все в файл
	save_log("Short+;"+ShortPrice_plus[i]+" tp_plus="+tp_plus);
//Считаем и пишем все в файл
//----------------------------------------------------------------------END SHORT+

}
//----------------------------------------------------------------------LONG+	
if(i>=k_plus AND enter_Long_plus<the_number_of_possible_additions AND profit>=profit_optimize AND
 poz_plus==0 AND Low[i]<Hline[i] AND High[i]>Hline[i]  AND poz==1 AND EMA_h_fast[i]>=EMA_h_NOTfast[i] AND
 i>=sell_flag  AND EMAO243[i]<Hline[i])
{ 
	Buy_plus[i]=True;
	poz_plus=1;
//сохраним номер бара на котором открыли позицию
	k_plus=i;
	BuyPrice_plus[i]=Close[i];
	BuyPrice_plus[i]=round(BuyPrice_plus[i]);
//сохраним цену открытия позиции	
Position_price_plus=BuyPrice_plus[i];
//запретили вход добавки
enter_long_plus=enter_long_plus+1;
//Посчитали стопы
	tp_plus=ATR_12[i]*37; if(tp_plus<=390); tp_plus=tp_plus*ATR_12[i];
	sl_plus=sl;


	
	
//Считаем и пишем все в файл
	save_log("Buy+;"+BuyPrice_plus[i]+" tp_plus="+tp_plus);
//Считаем и пишем все в файл
}
//----------------------------------------------------------------------END LONG+

///////////////////////////До этого вставляем в АТС
}
//---END authorized additive or not



														

}

////////////////////////////////////////////ЭТО КОНЕЦ ЦИКЛА//////////////////////////
/////***************************************************************************** СИСТЕМА ...
/////**************************************************************************
/////********************************************************************
/////**************************************************************
/////*******************************************************






i=i+1;//Прибавили то, что отняли

//ЕСЛИ ОСТАЛАСЬ ПОЗИЦИЯ ОТКРЫТА ПОСЧИТАЕМ ТЕКУЩИЙ РЕЗУЛЬТАТ
if (poz==-1)
{
	//Считаем и пишем все в файл
	CoverPrice[i]=Close[i];
	rez_tek=(Position_price-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Cover;"+CoverPrice[i]+";"+rez_tek+";"+rez);
	//Считаем и пишем все в файл

//Добавочка
if(poz_plus!=0)
{
CoverPrice[i]=Close[i];
	rez_tek=(Position_price_plus-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Cover+;"+CoverPrice[i]+";"+rez_tek+";"+rez);
}
//Добавочка


}

if (poz==1)
{
//Считаем и пишем все в файл
	SellPrice[i]=Close[i];
	rez_tek=(SellPrice[i]-Position_price)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Sell;"+SellPrice[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
//Добавочка
if(poz_plus!=0)
{
SellPrice_plus[i]=Close[i];
	rez_tek=(SellPrice_plus[i]-Position_price_plus)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Sell+;"+SellPrice_plus[i]+";"+rez_tek+";"+rez);
}
//Добавочка
}

//ИТОГО
	save_log("*********************TOTAL=;"+rez);
	//-До сюда кидаем на график
	
//Теперь выведим толь результат по символу
rez_simvol= fopen("C:/ami/test/testrez4.txt", "a");
	//fputs(Name()+";"+rez+";"+Oema+";"+bars+";"+fast+";"+NOTfast+";"+nomber+"\n",rez_simvol);
	fputs(Name()+";"+rez+";"+prosadka+";"+ema_exit+";"+profit_no_exit+";"+nomber+"\n",rez_simvol);
	fclose(Lf);
//Дальше концы оптимизационных циклов

}
}
}
//}
//}

////*********************************ОПТИМИЗИРУЕМ СИСТЕМА
////ОПИСАНИЕ: - Входим контртренд добавляемся по тренду плюс профит разный выход
////////////////////////Погнали, это начало оптимизационных циклов
nomber=0; // это номер по порядку для сортировки строк с одинаковыми параметрами
///ЦИКЛЫ
for( i_stop=1; i_stop <16; i_stop =i_stop +1)
{ 
for( ema_exit=150; ema_exit <270; ema_exit=ema_exit+10)
{
for( profit_no_exit=300; profit_no_exit <450; profit_no_exit=profit_no_exit+10)
{
//for( profit_no_exit=300; profit_no_exit <450; profit_no_exit=profit_no_exit+10)
//{
//for( profit_no_exit=300; profit_no_exit <450; profit_no_exit=profit_no_exit+10)
//{
nomber=nomber+1;// это номер позиции по порядку для оптимизации


/////* * * * * * * * * * * * * * * * * * * * *****************************
/////* * * * * * * * * * * * * * * * * * * * 	********************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************	
/////* * * * * * * * * * * * *********************************************************** 
/////* * * * * * * * * * * * * * * * * * * * *********************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*********************************


/////* * * * * * * * * * * * * * * * * * * * *****************************
/////* * * * * * * * * * * * * * * * * * * * 	********************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************	
/////* * * * * * * * * * * * *********************************************************** 
/////* * * * * * * * * * * * * * * * * * * * *********************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*********************************


/////* * * * * * * * * * * * * * * * * * * * *****************************
/////* * * * * * * * * * * * * * * * * * * * 	********************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************	
/////* * * * * * * * * * * * *********************************************************** 
/////* * * * * * * * * * * * * * * * * * * * *********************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*********************************



/////**************                                      СИСТЕМА ...
/////***************************************************************************** 
/////**************************************************************************
/////********************************************************************
/////**************************************************************
/////*******************************************************	
///Дальше идет сама система т.е. то, что реально будем торговать
///////ОПИСАНИЕ:
system_diskription="222-01 ";

///////////////////////////////////////////////////////// ПАРАМЕТРЫ И УСТАНОВКИ СИСТЕМЫ///////////////
/*
Установки для автоматизированной торговли и ручной
автоторговля система сама, в зависимости от состояний рынка будет определять какую систему использовать 
при ручной торговли, что использовать определяется оператором
Выбираем нужное остальное закоментировать
*/
//switchSystem = 31;//АВТОРЕЖИМ(как СУПЕР)
switchSystem = 0;//КОНТРЕНД
///switchSystem = 100000;//ТРЕНД
ExitALL=False; // true=одинаковый выход добавки т.е. пока основная поза открыта поза плюс держиться, false=соответственно разный выход
Enter_plus=True; // МОЖНО ЛИ ДОБАВЛЯТЬСЯ.

///////////////////////////////////////////////////+Инициализация переменных
Seccode = "SRZ2";// Какой контракт

poz=0;//установили позицию в начале расчета
poz_plus=0;//Добавка
k=k_plus=0;//бар на котором открыта позиция
Position_price=0;//цена по которой открылись
Position_price_plus=0;//цена по которой добавились
profit_max=0;//Максимальная прибыль за время существования позиции
Open_Short=1;//Флаг на вход после пересечения скользящих средних Short
Open_Long=1;//Флаг на вход после пересечения скользящих средних Long
stop_short=0;//счетчики стопов
stop_long=0;//счетчики стопов
Exit_Short=True;
Exit_Long=True;
Enter_Short_plus=0;//запретили вход добавочки
Enter_Long_plus=0;//запретили вход добавочки
prosadka=0;//Самый большой зафиксированный минус по системе
cover_flag=0;
sell_flag=0;
id=0;
sl=tp=sl_plus=tp_plus=0;


												
													
													
																	
//This variables do not change												
profit=0;// результат по текущей позиции, предварительная установка
profit_plus=0;
rez=0;// Результат всего по данной системе
rez_tek=0;//Результат по текущей сделки
//profit_no_exit=400;//Прибыль после достижения которой выход до пересения средних запрещен
//ema_exit=243;//Средняя для пересечения на выход
profit_optimize= 10;//Прибыль после достижения которой разрешен второй вход
em=33;//Скользяшая средняя после которой добавляемся
ema_switch_fast_val=55;
ema_switch_slow_val=123;
the_number_of_possible_additions=2; //сколько раз можно входить после выхода добавки только для разных выходов, для одинакового выхода нге имеет смысла
//i_stop=10;
rezult=0; // результат в данной сделке после её закрытия (вспомогательная информация)
main_pozition=1;//amount of the basic position
plus_pozition=1;// amount of the plus position
////////////////////////////////////////////////-Инициализация переменных

///////////////////////////////////////////////////Установки системы
bars=7;// колво баров за которые ищется пик
fast=6;// быстрая скользящая средняя
NOTfast=9;// медленная скользящая средняя
adper=55;//для контренда, период ЕМА(О,adper) ниже(выше) которого можно открывать позицию в контренд
ATRopt=50;//период ATR(ATRopt) для определения тренд или контртренд
ATRopt2=SwitchSystem;//значение ATR(ATRopt) для определения тренд или контртренд
ts=150;//отклонение от максимального максимума по прибыли, для отработки скользящий стоп
profit_ogr=50000;//прибыль по достижению которой начинаем отслеживать скользящий стоп 
//(если не используешь скользящий стоп установить первое значение большое (такой прибыли быть не может)

//////////////////////////////////////////////////Индикаторы, линии, массивы

ema_switch_fast=EMA(O,ema_switch_fast_val);
ema_switch_slow=EMA(O,ema_switch_slow_val);

EMAO243=EMA(O,em);
ema_exit_mass=EMA(O,ema_exit);
///Линия пиков
HLine=Ref(HHV(H,bars),-1);
LLine=Ref(LLV(L,bars),-1);
///Среднии по верхам
MA_h_fast=MA(H,fast);
MA_h_NOTfast=MA(H,NOTfast);
///Среднии по низам
MA_l_fast=MA(L,fast);
MA_l_NOTfast=MA(L,NOTfast);
///Адаптивные среднии по верхам
EMA_h_fast=EMA(H,fast);
EMA_h_NOTfast=EMA(H,NOTfast);
///Адаптивные Среднии по низам
EMA_l_fast=EMA(L,fast);
EMA_l_NOTfast=EMA(L,NOTfast);
EMA_Close=EMA(C,fast);
EMAO=EMA(O,adper);
ATR_12=ATR(12);///определяем стопы;
ATRopti=ATR(ATRopt);///переключение системы
n=EndValue(BarIndex());///номер поcледнего бара
tm=TimeNum();/// масив времени баров
dm=Day(); /// массив дата
///////////////////////////////////////Procedure 

											


////////////////////////////////////////////////////КОНЕЦ ПАРАМЕТРЫ  И УСТАНОВКИ СИСТЕМЫ/////////////////////////

//НАЧАЛО ЦИКЛА ТЕСТИРОВАНИЯ
for( n = 0; n < BarCount; n++ )
{
if(n==0)
{
Lf = fopen(FileNameLog, "w");
	fputs(Name()+"Begin-------------------------------------------------------"+"\n",Lf);
	fclose(Lf);
}


//////////////////////////////////////////////////СТАРТ СИСТЕМЫ///////////////////////////////////////////
i=n;

Buy[i]=False;
Sell[i]=False;
Cover[i]=False;
Short[i]=False;	


//ПЕРЕКЛЮЧАТЕЛИ-ФЛАЖОЧКИ
Exit_short=True;//разрешили выход шорт
Exit_Long=True;//разрешили выход лонг
if (poz==-1) profit=Position_price-O[i];
if (poz_plus==-1) profit_plus=Position_price_plus-O[i];
//profit=profit+profit_plus;
if (poz==-1 AND profit>=profit_no_exit AND O[i] <=ema_exit_mass[i]) Exit_short=False;//Запретили выход если сильный тренд


if (poz==1) profit=O[i]-Position_price;
if (poz_plus==1) profit_plus=O[i]-Position_price_plus;
//profit=profit+profit_plus;
if (poz==1 AND profit>=profit_no_exit AND O[i] >=ema_exit_mass[i]) Exit_Long=False;//Запретили выход если сильный тренд

//переключатель 
if ((i>1 AND ema_switch_fast[i-1]>ema_switch_slow[i-1] AND  ema_switch_fast[i]<ema_switch_slow[i]) OR (i>1 AND ema_switch_fast[i-1]<ema_switch_slow[i-1] AND  ema_switch_fast[i]>ema_switch_slow[i]))
	{
	//open_short=1;
	//open_long=1;
	//stop_short=0;
	//stop_long=-0;
	}


///////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////ПРАВИЛА СИСТЕМЫ/////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////Выходим Основная 
/////////////////////////////////////////////////////STOPs/////////////////////////////////
//switchSystem = 0;
//if(prosadka<=1500) switchSystem = 100000;

//--------------------------------------------- SHORT - stoploss
	if (poz==-1 AND High[i]+0>=Position_price+sl AND i>k) 
{
	Cover[i]=True;
	CoverPrice[i]=Position_price+sl;
	poz=0;
	k=i;
	//если открытие выше стопа, закрываемся по открытию
	if(Open[i]>Position_price+sl)
	CoverPrice[i]=Open[i];
	CoverPrice[i]=round(CoverPrice[i]);
	//Считаем и пишем все в файл
	stoploss[i]=True;//для рисования
	rez_tek=(Position_price-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
														
	save_log("SLShort;"+CoverPrice[i]+";"+rez_tek+";"+rez);
//Переключаем запреты	
	stop_long=0;
	open_long=1;
	stop_short=stop_short+1;
			
			if(stop_short>=i_stop AND poz_plus==0) 
			{
			//switchSystem = 100000;
			ATRopt2=SwitchSystem;
			open_short=0;
				//купим 
				Buy[i]=True;
				poz=1;
				//сохраним номер бара на котором открыли позицию
				k=i;
				BuyPrice[i]=CoverPrice[i];
				Position_price=BuyPrice[i];
										
				//Считаем и пишем все в файл
				save_log("BuySwitch;"+BuyPrice[i]);
				//Считаем и пишем все в файл											
			}	

//--------------------------------------------END SHORT - stoploss
}

//--------------------------------------------LONG - stoploss
	if (poz==1 AND Low[i]+0<=Position_price-sl AND i>k) 
{
	Sell[i]=True;
	SellPrice[i]=Position_price-sl;
	poz=0;
	k=i;
//если открытие ниже стопа, выходим на открытии бара
	if(Open[i]<Position_price-sl)
	SellPrice[i]=Open[i];
	SellPrice[i]=round(SellPrice[i]);
	//Считаем и пишем все в файл
	stoploss[i]=True;//для рисования
	rez_tek=(SellPrice[i]-Position_price)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
	if(rez<=prosadka) prosadka=rez;
	//k=i+1;
														
save_log("SLBuy;"+SellPrice[i]+";"+rez_tek+";"+rez);
//переключаем флажочки
	stop_short=0;
	open_short=1;	
	stop_long=stop_long+1;
		if (stop_long>=i_stop AND poz==0) 
	{
		//switchSystem = 100000;
		ATRopt2=SwitchSystem;
		open_long=0;
		//продадим
		Short[i]=True;
		poz=-1;
		//сохраним номер бара на котором открыли позицию
		k=i;
		ShortPrice[i]=SellPrice[i];
		Position_price=ShortPrice[i];
							
			
		//Считаем и пишем все в файл
		save_log("ShortSwitch;"+ShortPrice[i]);
		//Считаем и пишем все в файл
	}
	

//--------------------------------------------------END LONG - stoploss	


}

//--------------------------------------------------LONG - take profit
	if (Exit_long==True AND poz==1 AND (High[i]+0)>=Position_price+tp AND i>k) 
{
	Sell[i]=True;
	SellPrice[i]=Position_price+tp;
	k=i;
// если открытие выше тэйка, выходим сразу на открытии
	if(Open[i]>Position_price+tp)
	SellPrice[i]=Open[i];
	SellPrice[i]=round(SellPrice[i]);
//обнулим позицию в файле 
	poz=0;
//Установили бар следующего открытия позиции
k=i;

//Считаем и пишем все в файл
	takeprofit[i]=True;//для рисования
	rez_tek=(SellPrice[i]-Position_price)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
												
	
	save_log("TPBuy;"+SellPrice[i]+";"+rez_tek+";"+rez);//Считаем и пишем все в файл

}
//-------------------------------------------------- END LONG - take profit


//---------------------------------------------------SHORT - take profit

    if (Exit_Short==True AND poz==-1 AND (Low[i]+0)<=Position_price-tp AND i>k) 
{
	Cover[i]=True;
	CoverPrice[i]=Position_price-tp;
// если открытие ниже тэйка, выходим сразу на открытии
	if (Open[i]<Position_price-tp)
	CoverPrice[i]=Open[i];
	CoverPrice[i]=round(CoverPrice[i]);
//обнулим позицию в файле 
	poz=0;
//Установили бар следующего открытия позиции
k=i;
	takeprofit[i]=True;//для рисования
	rez_tek=(Position_price-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
												
save_log("TPShort;"+CoverPrice[i]+";"+rez_tek+";"+rez);//Считаем и пишем все в файл

}
//---------------------------------------------------END SHORT - take profit

////////////////////////////////////////////////////Скользящий стоп 

//Определяем прибыль на текущем баре
if (poz==-1) profit=Position_price-Low[i];
if (poz==1) profit=High[i]-Position_price;
//Максимальная прибыль за время существования позиции
if (profit>=profit_max) profit_max=profit;

if (poz==-1 AND Position_price-High[i]<profit_max-ts AND profit_max>profit_ogr )
	{
			 	Cover[i]=True;
				poz=0;
				k=i;
				profit_max=0;
				CoverPrice[i]=High[i];
	}


if (poz==1 AND Position_price-Low[i]<profit_max-ts AND profit_max>profit_ogr)
	{
			 	Sell[i]=True;
				poz=0;
				k=i;
				profit_max=0;
				SellPrice[i]=Low[i];
	}

//////////////////////////////////////////////////Конец Скользящий стоп

/////////////////////////////////////////////////ВЫХОД ДОБАВОЧКА СТОПЫ
if(poz_plus!=0)
{
//--------------------------------------------- SHORT+ - stoploss

	if ((poz_plus==-1 AND Cover[i]==True AND ExitAll==True AND stoploss[i]==True) OR 
	(poz_plus==-1 AND High[i]+0>=Position_price_plus+sl_plus AND ExitAll==False)) 
{
	Cover_plus[i]=True;
	if(ExitALL==True) CoverPrice_plus[i]=CoverPrice[i];//одинаковый выход
	if(ExitALL==False) CoverPrice_plus[i]=Position_price_plus+sl_plus;//разный выход
	poz_plus=0;
//если открытие выше стопа, закрываемся по открытию
	if(Open[i]>Position_price_plus+sl_plus AND ExitAll==False) CoverPrice_plus[i]=Open[i]; //разный выход
	CoverPrice_plus[i]=round(CoverPrice_plus[i]);
	
//Установили бар следующего открытия позиции
k_plus=i;
//
//Open_Short=0;
//Считаем и пишем все в файл
	stoploss_plus[i]=True;//для рисования
	rez_tek=(Position_price_plus-CoverPrice_plus[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
	if(rez<=prosadka) prosadka=rez;
								
	
	save_log("SLShort+;"+CoverPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
}
//--------------------------------------------END SHORT+ - stoploss


//--------------------------------------------LONG+ - stoploss
	if ((poz_plus==1 AND Sell[i]==True AND ExitAll==True AND stoploss[i]==True) OR
	(poz_plus==1 AND Low[i]+0<=Position_price_plus-sl_plus AND ExitAll==False)) 
{
	Sell_plus[i]=True;
	if(ExitALL==True) SellPrice_plus[i]=SellPrice[i];//одинаковый выход
	if(ExitALL==False) SellPrice_plus[i]=Position_price_plus-sl_plus;//разный выход
	poz_plus=0;
//если открытие ниже стопа, выходим на открытии бара
	if(Open[i]<Position_price_plus-sl_plus AND ExitAll==False) SellPrice_plus[i]=Open[i]; //разный выход
	SellPrice_plus[i]=round(SellPrice_plus[i]);
//Установили бар следующего открытия позиции
k_plus=i;
//
//Open_Long=0;

//Считаем и пишем все в файл
	stoploss_plus[i]=True;//для рисования
	rez_tek=(SellPrice_plus[i]-Position_price_plus)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
												

	save_log("SLBuy+;"+SellPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
}
//--------------------------------------------------END LONG+ - stoploss	

//--------------------------------------------------LONG+ - take profit
	if ((poz_plus==1 AND Sell[i]==True AND ExitAll==True AND takeprofit[i]==True)  OR
	(poz_plus==1 AND High[i]>=Position_price_plus+tp_plus AND ExitAll==False)) 
{
	Sell_plus[i]=True;
	if(ExitALL==True) SellPrice_plus[i]=SellPrice[i];//одинаковый выход
	if(ExitALL==False) SellPrice_plus[i]=Position_price_plus+tp_plus;//разный выход
// если открытие выше тэйка, выходим сразу на открытии
	if(Open[i]>Position_price_plus+tp_plus AND ExitAll==False) SellPrice_plus[i]=Open[i];//разный выход
	SellPrice_plus[i]=round(SellPrice_plus[i]);
	poz_plus=0;
//Установили бар следующего открытия позиции
k_plus=i;
//Считаем и пишем все в файл
	takeprofit_plus[i]=True;//для рисования
	rez_tek=(SellPrice_plus[i]-Position_price_plus)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
									
	save_log("TPBuy+;"+SellPrice[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
}
//-------------------------------------------------- END LONG+ - take profit


//---------------------------------------------------SHORT+ - take profit
    if ((poz_plus==-1 AND Cover[i]==True AND ExitAll==True AND takeprofit[i]==True) OR
	(poz_plus==-1 AND Low[i]<=Position_price_plus-tp_plus AND ExitAll==False) ) 
{
	Cover_plus[i]=True;
	if (ExitAll==True) CoverPrice_plus[i]=CoverPrice[i];//одинаковый выход
	if (ExitAll==False) CoverPrice_plus[i]=Position_price_plus-tp_plus;//разный выход
// если открытие ниже тэйка, выходим сразу на открытии
	if (Open[i]<Position_price_plus-tp_plus AND ExitAll==False) CoverPrice_plus[i]=Open[i];
	CoverPrice_plus[i]=round(CoverPrice_plus[i]);
//обнулим позицию в файле 
	poz_plus=0;
//Установили бар следующего открытия позиции
k_plus=i;
//Считаем и пишем все в файл
	takeprofit_plus[i]=True;//для рисования
	rez_tek=(Position_price_plus-CoverPrice_plus[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
													
	save_log("TPShort+;"+CoverPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
}
//---------------------------------------------------END SHORT+ - take profit

////////////////////////////////////////////////////Скользящий стоп +
//Определяем прибыль на текущем баре
if (poz_plus==-1) profit_plus=Position_price_plus-Low[i];
if (poz_plus==1) profit_plus=High[i]-Position_price_plus;
//Максимальная прибыль за время существования позиции
if (profit>=profit_max) profit_max=profit;

if (poz==-1 AND Position_price-High[i]<profit_max-ts AND profit_max>profit_ogr )
	{
			 	Cover[i]=True;
				poz=0;
				k=i;
				profit_max=0;
				CoverPrice[i]=High[i];
	}


if (poz==1 AND Position_price-Low[i]<profit_max-ts AND profit_max>profit_ogr)
	{
			 	Sell[i]=True;
				poz=0;
				k=i;
				profit_max=0;
				SellPrice[i]=Low[i];
	}
//////////////////////////////////////////////////Конец Скользящий стоп +
}
////////////////////////////////////////////////////КОНЕЦ ВЫХОД ДОБАВОЧКА СТОПЫ




//Принимаем решение на вход выход по закрытию бара, поэтому
i=n-1;
if(i<0) i=0;

//---------------------------------------------------Выходим по правилам системы
//---------------------------------------------------SELL 
	if (Exit_long==True AND poz==1 AND High [i]+0>Lline[i]+0 AND Low[i]+0<Lline[i]+0 AND
	EMA_l_fast[i]+0<=EMA_l_NOTfast[i]+0 AND i>k AND EMA_l_fast[i]>0 AND EMA_close[i]<=Lline[i]) 
{
//
	Sell[i]=True;
	SellPrice[i]=Close[i];
	SellPrice[i]=round(SellPrice[i]);
	Sell_flag=i+1;
//
	poz=0;
	k=i;
											
//Считаем и пишем все в файл
	rez_tek=(SellPrice[i]-Position_price)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
save_log("Sell;"+SellPrice[i]+";"+rez_tek+";"+rez);//Считаем и пишем все в файл


//--------------------------------------------------END SELL
}
//--------------------------------------------------COVER
	if (Exit_Short==True AND poz==-1 AND Low[i]<Hline[i] AND High[i]>Hline[i] AND
	EMA_h_fast[i]>=EMA_h_NOTfast[i] AND i>k AND EMA_h_fast[i]>0 AND EMA_close[i]>=Hline[i]) 
{
   Cover[i]=True;
	CoverPrice[i]=Close[i];
	Cover_flag=i+1;		
	poz=0;
	k=i;
		
		CoverPrice[i]=round(CoverPrice[i]);
//Установили бар следующего открытия позиции
											
	
//Считаем и пишем все в файл
	rez_tek=(Position_price-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Cover;"+CoverPrice[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
//---------------------------------------------------END COVER


}

/////////////////////////////////////////////////////ВЫХОД ДОБАВОЧКА ПРАВИЛА СИСТЕМЫ
//---------------------------------------------------Выходим по правилам системы

//---------------------------------------------------SELL+
	if ((ExitAll==True AND Exit_long==True AND poz_plus==1 AND Sell[i]==True) OR
		(poz_plus==1 AND High [i]+0>Lline[i]+0 AND Low[i]+0<Lline[i]+0 AND 
	EMA_l_fast[i]+0<=EMA_l_NOTfast[i]+0  AND EMA_l_fast[i]>0 AND EMA_close[i]<=Lline[i] AND ExitAll==False)) 
{
//
	Sell_plus[i]=True;
	SellPrice_plus[i]=Close[i];
	SellPrice_plus[i]=round(SellPrice_plus[i]);
//
	poz_plus=0;
											
	
//Считаем и пишем все в файл
	rez_tek=(SellPrice_plus[i]-Position_price_plus)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Sell+;"+SellPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
//--------------------------------------------------END SELL+

}
//--------------------------------------------------COVER+
	if ((ExitAll==True AND Exit_short==True AND poz_plus==-1 AND Cover[i]==True ) OR
	(poz_plus==-1 AND Low[i]<Hline[i] AND High[i]>Hline[i] AND
	EMA_h_fast[i]>=EMA_h_NOTfast[i]  AND EMA_h_fast[i]>0 AND EMA_close[i]>=Hline[i] AND ExitAll==False)) 
{
    Cover_plus[i]=True;
	CoverPrice_plus[i]=Close[i];
	poz_plus=0;
	CoverPrice_plus[i]=round(CoverPrice_plus[i]);
//Установили бар следующего открытия позиции
												
//Считаем и пишем все в файл
	rez_tek=(Position_price_plus-CoverPrice_plus[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Cover+;"+CoverPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
//---------------------------------------------------END COVER+
}

///////////////////////////////////КОНЕЦ ВЫХОД ДОБАВОЧКА ПРАВИЛА СИСТЕМЫ////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////// Входим
//----------------------------------------------------------------------LONG
	if (poz_plus==0 AND Open_Long==1 AND Low[i]<Hline[i] AND High[i]>Hline[i]  AND
	poz==0 AND EMA_h_fast[i]>=EMA_h_NOTfast[i] AND i>=sell_flag AND i>=k AND EMAO[i]>=Hline[i] AND ATRopti[i]>=ATRopt2 OR
	Low[i]<Hline[i] AND High[i]>Hline[i]  AND poz==0 AND EMA_h_fast[i]>=EMA_h_NOTfast[i] AND
	i>=sell_flag AND i>=k AND	ATRopti[i]<ATRopt2)
{ 
	Buy[i]=True;
	poz=1;
//сохраним номер бара на котором открыли позицию
	k=i;
	BuyPrice[i]=Close[i];
	BuyPrice[i]=round(BuyPrice[i]);
//обнулил счетчик стопов
stop_short=0;//счетчики стопов
switchSystem = 0;
ATRopt2=SwitchSystem;
Open_Short=1;
//разрешили вход добавки
enter_long_plus=0;
//сохраним цену открытия позиции	
Position_price=BuyPrice[i];
//Посчитали стопы
tp=ATR_12[i]*37;
if (tp<450) tp=tp*ATR_12[i];
sl=ATR_12[i]*10;
if(sl>150)sl=150;
								

//Считаем и пишем все в файл
	save_log("Buy;"+BuyPrice[i]+" tp="+tp);
//Считаем и пишем все в файл
//----------------------------------------------------------------------END LONG
} 




//----------------------------------------------------------------------SHORT
	if( poz_plus==0 AND Open_Short==1 AND (High[i]>Lline[i] AND Lline[i]>Low[i] AND
	poz==0 AND EMA_l_fast[i]<=EMA_l_NOTfast[i] AND i>=cover_flag AND i>=k AND EMAO[i]<=Lline[i] AND ATRopti[i]>=ATRopt2  ) OR 
	(High[i]>Lline[i] AND Lline[i]>Low[i] AND poz==0 AND EMA_l_fast[i]<=EMA_l_NOTfast[i] AND
	i>=cover_flag AND i>=k AND ATRopti[i]<ATRopt2))
{ 
	Short[i]=True;
	poz=-1;
//сохраним номер бара на котором открыли позицию
	k=i;
	ShortPrice[i]=Close[i];
	ShortPrice[i]=round(ShortPrice[i]);
//обнулил счетчик стопов
stop_long=0;//счетчики стопов
Open_Long=1;
switchSystem = 0;
ATRopt2=SwitchSystem;
//разрешили вход добавки
enter_short_plus=0;
//сохраним цену открытия позиции
	Position_price=ShortPrice[i];
//Посчитали стопы
	tp=ATR_12[i]*37;
	if (tp<450) tp=tp*ATR_12[i];
	sl=ATR_12[i]*10;
	if(sl>150)sl=150;
								

//Считаем и пишем все в файл
	save_log("Short;"+ShortPrice[i]+" tp="+tp);
//Считаем и пишем все в файл
//----------------------------------------------------------------------END SHORT
}




if(enter_plus==True) //authorized additive or not
{
//----------------------------------------------------------------------Добавляемся
if (poz==-1) profit=Position_price-Low[i];
if (poz==1) profit=High[i]-Position_price;

//----------------------------------------------------------------------SHORT+
if(i>=k_plus AND enter_short_plus<the_number_of_possible_additions AND profit>=profit_optimize AND
 poz_plus==0 AND High[i]>Lline[i] AND Lline[i]>Low[i] AND poz==-1 AND EMA_l_fast[i]<=EMA_l_NOTfast[i] AND
 i>=cover_flag AND EMAO243[i]>Hline[i]) 
{
	Short_plus[i]=True;
	poz_plus=-1;
//Save number for the bar which is open position
	k_plus=i;
	ShortPrice_plus[i]=Close[i];
	ShortPrice_plus[i]=round(ShortPrice_plus[i]);
//запретили вход добавки
enter_short_plus=enter_short_plus+1;
//сохраним цену открытия позиции
	Position_price_plus=ShortPrice_plus[i];
//Посчитали стопы
	tp_plus=ATR_12[i]*37; if(tp_plus<=390); tp_plus=tp_plus*ATR_12[i];
	sl_plus=sl;
//Считаем и пишем все в файл
	save_log("Short+;"+ShortPrice_plus[i]+" tp_plus="+tp_plus);
//Считаем и пишем все в файл
//----------------------------------------------------------------------END SHORT+

}
//----------------------------------------------------------------------LONG+	
if(i>=k_plus AND enter_Long_plus<the_number_of_possible_additions AND profit>=profit_optimize AND
 poz_plus==0 AND Low[i]<Hline[i] AND High[i]>Hline[i]  AND poz==1 AND EMA_h_fast[i]>=EMA_h_NOTfast[i] AND
 i>=sell_flag  AND EMAO243[i]<Hline[i])
{ 
	Buy_plus[i]=True;
	poz_plus=1;
//сохраним номер бара на котором открыли позицию
	k_plus=i;
	BuyPrice_plus[i]=Close[i];
	BuyPrice_plus[i]=round(BuyPrice_plus[i]);
//сохраним цену открытия позиции	
Position_price_plus=BuyPrice_plus[i];
//запретили вход добавки
enter_long_plus=enter_long_plus+1;
//Посчитали стопы
	tp_plus=ATR_12[i]*37; if(tp_plus<=390); tp_plus=tp_plus*ATR_12[i];
	sl_plus=sl;


	
	
//Считаем и пишем все в файл
	save_log("Buy+;"+BuyPrice_plus[i]+" tp_plus="+tp_plus);
//Считаем и пишем все в файл
}
//----------------------------------------------------------------------END LONG+

///////////////////////////До этого вставляем в АТС
}
//---END authorized additive or not



														

}

////////////////////////////////////////////ЭТО КОНЕЦ ЦИКЛА//////////////////////////
/////***************************************************************************** СИСТЕМА ...
/////**************************************************************************
/////********************************************************************
/////**************************************************************
/////*******************************************************






i=i+1;//Прибавили то, что отняли

//ЕСЛИ ОСТАЛАСЬ ПОЗИЦИЯ ОТКРЫТА ПОСЧИТАЕМ ТЕКУЩИЙ РЕЗУЛЬТАТ
if (poz==-1)
{
	//Считаем и пишем все в файл
	CoverPrice[i]=Close[i];
	rez_tek=(Position_price-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Cover;"+CoverPrice[i]+";"+rez_tek+";"+rez);
	//Считаем и пишем все в файл

//Добавочка
if(poz_plus!=0)
{
CoverPrice[i]=Close[i];
	rez_tek=(Position_price_plus-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Cover+;"+CoverPrice[i]+";"+rez_tek+";"+rez);
}
//Добавочка


}

if (poz==1)
{
//Считаем и пишем все в файл
	SellPrice[i]=Close[i];
	rez_tek=(SellPrice[i]-Position_price)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Sell;"+SellPrice[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
//Добавочка
if(poz_plus!=0)
{
SellPrice_plus[i]=Close[i];
	rez_tek=(SellPrice_plus[i]-Position_price_plus)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Sell+;"+SellPrice_plus[i]+";"+rez_tek+";"+rez);
}
//Добавочка
}

//ИТОГО
	save_log("*********************TOTAL=;"+rez);
	//-До сюда кидаем на график
	
//Теперь выведим толь результат по символу
rez_simvol= fopen("C:/ami/test/testrez41.txt", "a");
	//fputs(Name()+";"+rez+";"+Oema+";"+bars+";"+fast+";"+NOTfast+";"+nomber+"\n",rez_simvol);
	fputs(Name()+";"+rez+";"+prosadka+";"+ema_exit+";"+profit_no_exit+";"+nomber+"\n",rez_simvol);
	fclose(Lf);
//Дальше концы оптимизационных циклов

}
}
}
//}
//}


////*********************************ОПТИМИЗИРУЕМ СИСТЕМА
////ОПИСАНИЕ: - Входим контртренд добавляемся по тренду плюс профит разный выход
////////////////////////Погнали, это начало оптимизационных циклов
nomber=0; // это номер по порядку для сортировки строк с одинаковыми параметрами
///ЦИКЛЫ
for( i_stop=1; i_stop <16; i_stop =i_stop +1)
{ 
for( ema_exit=150; ema_exit <270; ema_exit=ema_exit+10)
{
for( profit_no_exit=300; profit_no_exit <450; profit_no_exit=profit_no_exit+10)
{
//for( profit_no_exit=300; profit_no_exit <450; profit_no_exit=profit_no_exit+10)
//{
//for( profit_no_exit=300; profit_no_exit <450; profit_no_exit=profit_no_exit+10)
//{
nomber=nomber+1;// это номер позиции по порядку для оптимизации


/////* * * * * * * * * * * * * * * * * * * * *****************************
/////* * * * * * * * * * * * * * * * * * * * 	********************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************	
/////* * * * * * * * * * * * *********************************************************** 
/////* * * * * * * * * * * * * * * * * * * * *********************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*********************************


/////* * * * * * * * * * * * * * * * * * * * *****************************
/////* * * * * * * * * * * * * * * * * * * * 	********************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************	
/////* * * * * * * * * * * * *********************************************************** 
/////* * * * * * * * * * * * * * * * * * * * *********************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*********************************


/////* * * * * * * * * * * * * * * * * * * * *****************************
/////* * * * * * * * * * * * * * * * * * * * 	********************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************	
/////* * * * * * * * * * * * *********************************************************** 
/////* * * * * * * * * * * * * * * * * * * * *********************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*********************************



/////**************                                      СИСТЕМА ...
/////***************************************************************************** 
/////**************************************************************************
/////********************************************************************
/////**************************************************************
/////*******************************************************	
///Дальше идет сама система т.е. то, что реально будем торговать
///////ОПИСАНИЕ:
system_diskription="222-01 ";

///////////////////////////////////////////////////////// ПАРАМЕТРЫ И УСТАНОВКИ СИСТЕМЫ///////////////
/*
Установки для автоматизированной торговли и ручной
автоторговля система сама, в зависимости от состояний рынка будет определять какую систему использовать 
при ручной торговли, что использовать определяется оператором
Выбираем нужное остальное закоментировать
*/
//switchSystem = 31;//АВТОРЕЖИМ(как СУПЕР)
switchSystem = 0;//КОНТРЕНД
///switchSystem = 100000;//ТРЕНД
ExitALL=False; // true=одинаковый выход добавки т.е. пока основная поза открыта поза плюс держиться, false=соответственно разный выход
Enter_plus=True; // МОЖНО ЛИ ДОБАВЛЯТЬСЯ.

///////////////////////////////////////////////////+Инициализация переменных
Seccode = "SRZ2";// Какой контракт

poz=0;//установили позицию в начале расчета
poz_plus=0;//Добавка
k=k_plus=0;//бар на котором открыта позиция
Position_price=0;//цена по которой открылись
Position_price_plus=0;//цена по которой добавились
profit_max=0;//Максимальная прибыль за время существования позиции
Open_Short=1;//Флаг на вход после пересечения скользящих средних Short
Open_Long=1;//Флаг на вход после пересечения скользящих средних Long
stop_short=0;//счетчики стопов
stop_long=0;//счетчики стопов
Exit_Short=True;
Exit_Long=True;
Enter_Short_plus=0;//запретили вход добавочки
Enter_Long_plus=0;//запретили вход добавочки
prosadka=0;//Самый большой зафиксированный минус по системе
cover_flag=0;
sell_flag=0;
id=0;
sl=tp=sl_plus=tp_plus=0;


												
													
													
																	
//This variables do not change												
profit=0;// результат по текущей позиции, предварительная установка
profit_plus=0;
rez=0;// Результат всего по данной системе
rez_tek=0;//Результат по текущей сделки
//profit_no_exit=400;//Прибыль после достижения которой выход до пересения средних запрещен
//ema_exit=243;//Средняя для пересечения на выход
profit_optimize= 10;//Прибыль после достижения которой разрешен второй вход
em=33;//Скользяшая средняя после которой добавляемся
ema_switch_fast_val=55;
ema_switch_slow_val=123;
the_number_of_possible_additions=2; //сколько раз можно входить после выхода добавки только для разных выходов, для одинакового выхода нге имеет смысла
//i_stop=10;
rezult=0; // результат в данной сделке после её закрытия (вспомогательная информация)
main_pozition=1;//amount of the basic position
plus_pozition=1;// amount of the plus position
////////////////////////////////////////////////-Инициализация переменных

///////////////////////////////////////////////////Установки системы
bars=7;// колво баров за которые ищется пик
fast=6;// быстрая скользящая средняя
NOTfast=9;// медленная скользящая средняя
adper=55;//для контренда, период ЕМА(О,adper) ниже(выше) которого можно открывать позицию в контренд
ATRopt=50;//период ATR(ATRopt) для определения тренд или контртренд
ATRopt2=SwitchSystem;//значение ATR(ATRopt) для определения тренд или контртренд
ts=150;//отклонение от максимального максимума по прибыли, для отработки скользящий стоп
profit_ogr=50000;//прибыль по достижению которой начинаем отслеживать скользящий стоп 
//(если не используешь скользящий стоп установить первое значение большое (такой прибыли быть не может)

//////////////////////////////////////////////////Индикаторы, линии, массивы

ema_switch_fast=EMA(O,ema_switch_fast_val);
ema_switch_slow=EMA(O,ema_switch_slow_val);

EMAO243=EMA(O,em);
ema_exit_mass=EMA(O,ema_exit);
///Линия пиков
HLine=Ref(HHV(H,bars),-1);
LLine=Ref(LLV(L,bars),-1);
///Среднии по верхам
MA_h_fast=MA(H,fast);
MA_h_NOTfast=MA(H,NOTfast);
///Среднии по низам
MA_l_fast=MA(L,fast);
MA_l_NOTfast=MA(L,NOTfast);
///Адаптивные среднии по верхам
EMA_h_fast=EMA(H,fast);
EMA_h_NOTfast=EMA(H,NOTfast);
///Адаптивные Среднии по низам
EMA_l_fast=EMA(L,fast);
EMA_l_NOTfast=EMA(L,NOTfast);
EMA_Close=EMA(C,fast);
EMAO=EMA(O,adper);
ATR_12=ATR(12);///определяем стопы;
ATRopti=ATR(ATRopt);///переключение системы
n=EndValue(BarIndex());///номер поcледнего бара
tm=TimeNum();/// масив времени баров
dm=Day(); /// массив дата
///////////////////////////////////////Procedure 

											


////////////////////////////////////////////////////КОНЕЦ ПАРАМЕТРЫ  И УСТАНОВКИ СИСТЕМЫ/////////////////////////

//НАЧАЛО ЦИКЛА ТЕСТИРОВАНИЯ
for( n = 0; n < BarCount; n++ )
{
if(n==0)
{
Lf = fopen(FileNameLog, "w");
	fputs(Name()+"Begin-------------------------------------------------------"+"\n",Lf);
	fclose(Lf);
}


//////////////////////////////////////////////////СТАРТ СИСТЕМЫ///////////////////////////////////////////
i=n;

Buy[i]=False;
Sell[i]=False;
Cover[i]=False;
Short[i]=False;	


//ПЕРЕКЛЮЧАТЕЛИ-ФЛАЖОЧКИ
Exit_short=True;//разрешили выход шорт
Exit_Long=True;//разрешили выход лонг
if (poz==-1) profit=Position_price-O[i];
if (poz_plus==-1) profit_plus=Position_price_plus-O[i];
//profit=profit+profit_plus;
if (poz==-1 AND profit>=profit_no_exit AND O[i] <=ema_exit_mass[i]) Exit_short=False;//Запретили выход если сильный тренд


if (poz==1) profit=O[i]-Position_price;
if (poz_plus==1) profit_plus=O[i]-Position_price_plus;
//profit=profit+profit_plus;
if (poz==1 AND profit>=profit_no_exit AND O[i] >=ema_exit_mass[i]) Exit_Long=False;//Запретили выход если сильный тренд

//переключатель 
if ((i>1 AND ema_switch_fast[i-1]>ema_switch_slow[i-1] AND  ema_switch_fast[i]<ema_switch_slow[i]) OR (i>1 AND ema_switch_fast[i-1]<ema_switch_slow[i-1] AND  ema_switch_fast[i]>ema_switch_slow[i]))
	{
	//open_short=1;
	//open_long=1;
	//stop_short=0;
	//stop_long=-0;
	}


///////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////ПРАВИЛА СИСТЕМЫ/////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////Выходим Основная 
/////////////////////////////////////////////////////STOPs/////////////////////////////////
//switchSystem = 0;
//if(prosadka<=1500) switchSystem = 100000;

//--------------------------------------------- SHORT - stoploss
	if (poz==-1 AND High[i]+0>=Position_price+sl AND i>k) 
{
	Cover[i]=True;
	CoverPrice[i]=Position_price+sl;
	poz=0;
	k=i;
	//если открытие выше стопа, закрываемся по открытию
	if(Open[i]>Position_price+sl)
	CoverPrice[i]=Open[i];
	CoverPrice[i]=round(CoverPrice[i]);
	//Считаем и пишем все в файл
	stoploss[i]=True;//для рисования
	rez_tek=(Position_price-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
														
	save_log("SLShort;"+CoverPrice[i]+";"+rez_tek+";"+rez);
//Переключаем запреты	
	stop_long=0;
	open_long=1;
	stop_short=stop_short+1;
			
			if(stop_short>=i_stop AND poz_plus==0) 
			{
			//switchSystem = 100000;
			ATRopt2=SwitchSystem;
			open_short=0;
				//купим 
				Buy[i]=True;
				poz=1;
				//сохраним номер бара на котором открыли позицию
				k=i;
				BuyPrice[i]=CoverPrice[i];
				Position_price=BuyPrice[i];
										
				//Считаем и пишем все в файл
				save_log("BuySwitch;"+BuyPrice[i]);
				//Считаем и пишем все в файл											
			}	

//--------------------------------------------END SHORT - stoploss
}

//--------------------------------------------LONG - stoploss
	if (poz==1 AND Low[i]+0<=Position_price-sl AND i>k) 
{
	Sell[i]=True;
	SellPrice[i]=Position_price-sl;
	poz=0;
	k=i;
//если открытие ниже стопа, выходим на открытии бара
	if(Open[i]<Position_price-sl)
	SellPrice[i]=Open[i];
	SellPrice[i]=round(SellPrice[i]);
	//Считаем и пишем все в файл
	stoploss[i]=True;//для рисования
	rez_tek=(SellPrice[i]-Position_price)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
	if(rez<=prosadka) prosadka=rez;
	//k=i+1;
														
save_log("SLBuy;"+SellPrice[i]+";"+rez_tek+";"+rez);
//переключаем флажочки
	stop_short=0;
	open_short=1;	
	stop_long=stop_long+1;
		if (stop_long>=i_stop AND poz==0) 
	{
		//switchSystem = 100000;
		ATRopt2=SwitchSystem;
		open_long=0;
		//продадим
		Short[i]=True;
		poz=-1;
		//сохраним номер бара на котором открыли позицию
		k=i;
		ShortPrice[i]=SellPrice[i];
		Position_price=ShortPrice[i];
							
			
		//Считаем и пишем все в файл
		save_log("ShortSwitch;"+ShortPrice[i]);
		//Считаем и пишем все в файл
	}
	

//--------------------------------------------------END LONG - stoploss	


}

//--------------------------------------------------LONG - take profit
	if (Exit_long==True AND poz==1 AND (High[i]+0)>=Position_price+tp AND i>k) 
{
	Sell[i]=True;
	SellPrice[i]=Position_price+tp;
	k=i;
// если открытие выше тэйка, выходим сразу на открытии
	if(Open[i]>Position_price+tp)
	SellPrice[i]=Open[i];
	SellPrice[i]=round(SellPrice[i]);
//обнулим позицию в файле 
	poz=0;
//Установили бар следующего открытия позиции
k=i;

//Считаем и пишем все в файл
	takeprofit[i]=True;//для рисования
	rez_tek=(SellPrice[i]-Position_price)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
												
	
	save_log("TPBuy;"+SellPrice[i]+";"+rez_tek+";"+rez);//Считаем и пишем все в файл

}
//-------------------------------------------------- END LONG - take profit


//---------------------------------------------------SHORT - take profit

    if (Exit_Short==True AND poz==-1 AND (Low[i]+0)<=Position_price-tp AND i>k) 
{
	Cover[i]=True;
	CoverPrice[i]=Position_price-tp;
// если открытие ниже тэйка, выходим сразу на открытии
	if (Open[i]<Position_price-tp)
	CoverPrice[i]=Open[i];
	CoverPrice[i]=round(CoverPrice[i]);
//обнулим позицию в файле 
	poz=0;
//Установили бар следующего открытия позиции
k=i;
	takeprofit[i]=True;//для рисования
	rez_tek=(Position_price-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
												
save_log("TPShort;"+CoverPrice[i]+";"+rez_tek+";"+rez);//Считаем и пишем все в файл

}
//---------------------------------------------------END SHORT - take profit

////////////////////////////////////////////////////Скользящий стоп 

//Определяем прибыль на текущем баре
if (poz==-1) profit=Position_price-Low[i];
if (poz==1) profit=High[i]-Position_price;
//Максимальная прибыль за время существования позиции
if (profit>=profit_max) profit_max=profit;

if (poz==-1 AND Position_price-High[i]<profit_max-ts AND profit_max>profit_ogr )
	{
			 	Cover[i]=True;
				poz=0;
				k=i;
				profit_max=0;
				CoverPrice[i]=High[i];
	}


if (poz==1 AND Position_price-Low[i]<profit_max-ts AND profit_max>profit_ogr)
	{
			 	Sell[i]=True;
				poz=0;
				k=i;
				profit_max=0;
				SellPrice[i]=Low[i];
	}

//////////////////////////////////////////////////Конец Скользящий стоп

/////////////////////////////////////////////////ВЫХОД ДОБАВОЧКА СТОПЫ
if(poz_plus!=0)
{
//--------------------------------------------- SHORT+ - stoploss

	if ((poz_plus==-1 AND Cover[i]==True AND ExitAll==True AND stoploss[i]==True) OR 
	(poz_plus==-1 AND High[i]+0>=Position_price_plus+sl_plus AND ExitAll==False)) 
{
	Cover_plus[i]=True;
	if(ExitALL==True) CoverPrice_plus[i]=CoverPrice[i];//одинаковый выход
	if(ExitALL==False) CoverPrice_plus[i]=Position_price_plus+sl_plus;//разный выход
	poz_plus=0;
//если открытие выше стопа, закрываемся по открытию
	if(Open[i]>Position_price_plus+sl_plus AND ExitAll==False) CoverPrice_plus[i]=Open[i]; //разный выход
	CoverPrice_plus[i]=round(CoverPrice_plus[i]);
	
//Установили бар следующего открытия позиции
k_plus=i;
//
//Open_Short=0;
//Считаем и пишем все в файл
	stoploss_plus[i]=True;//для рисования
	rez_tek=(Position_price_plus-CoverPrice_plus[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
	if(rez<=prosadka) prosadka=rez;
								
	
	save_log("SLShort+;"+CoverPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
}
//--------------------------------------------END SHORT+ - stoploss


//--------------------------------------------LONG+ - stoploss
	if ((poz_plus==1 AND Sell[i]==True AND ExitAll==True AND stoploss[i]==True) OR
	(poz_plus==1 AND Low[i]+0<=Position_price_plus-sl_plus AND ExitAll==False)) 
{
	Sell_plus[i]=True;
	if(ExitALL==True) SellPrice_plus[i]=SellPrice[i];//одинаковый выход
	if(ExitALL==False) SellPrice_plus[i]=Position_price_plus-sl_plus;//разный выход
	poz_plus=0;
//если открытие ниже стопа, выходим на открытии бара
	if(Open[i]<Position_price_plus-sl_plus AND ExitAll==False) SellPrice_plus[i]=Open[i]; //разный выход
	SellPrice_plus[i]=round(SellPrice_plus[i]);
//Установили бар следующего открытия позиции
k_plus=i;
//
//Open_Long=0;

//Считаем и пишем все в файл
	stoploss_plus[i]=True;//для рисования
	rez_tek=(SellPrice_plus[i]-Position_price_plus)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
												

	save_log("SLBuy+;"+SellPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
}
//--------------------------------------------------END LONG+ - stoploss	

//--------------------------------------------------LONG+ - take profit
	if ((poz_plus==1 AND Sell[i]==True AND ExitAll==True AND takeprofit[i]==True)  OR
	(poz_plus==1 AND High[i]>=Position_price_plus+tp_plus AND ExitAll==False)) 
{
	Sell_plus[i]=True;
	if(ExitALL==True) SellPrice_plus[i]=SellPrice[i];//одинаковый выход
	if(ExitALL==False) SellPrice_plus[i]=Position_price_plus+tp_plus;//разный выход
// если открытие выше тэйка, выходим сразу на открытии
	if(Open[i]>Position_price_plus+tp_plus AND ExitAll==False) SellPrice_plus[i]=Open[i];//разный выход
	SellPrice_plus[i]=round(SellPrice_plus[i]);
	poz_plus=0;
//Установили бар следующего открытия позиции
k_plus=i;
//Считаем и пишем все в файл
	takeprofit_plus[i]=True;//для рисования
	rez_tek=(SellPrice_plus[i]-Position_price_plus)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
									
	save_log("TPBuy+;"+SellPrice[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
}
//-------------------------------------------------- END LONG+ - take profit


//---------------------------------------------------SHORT+ - take profit
    if ((poz_plus==-1 AND Cover[i]==True AND ExitAll==True AND takeprofit[i]==True) OR
	(poz_plus==-1 AND Low[i]<=Position_price_plus-tp_plus AND ExitAll==False) ) 
{
	Cover_plus[i]=True;
	if (ExitAll==True) CoverPrice_plus[i]=CoverPrice[i];//одинаковый выход
	if (ExitAll==False) CoverPrice_plus[i]=Position_price_plus-tp_plus;//разный выход
// если открытие ниже тэйка, выходим сразу на открытии
	if (Open[i]<Position_price_plus-tp_plus AND ExitAll==False) CoverPrice_plus[i]=Open[i];
	CoverPrice_plus[i]=round(CoverPrice_plus[i]);
//обнулим позицию в файле 
	poz_plus=0;
//Установили бар следующего открытия позиции
k_plus=i;
//Считаем и пишем все в файл
	takeprofit_plus[i]=True;//для рисования
	rez_tek=(Position_price_plus-CoverPrice_plus[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
													
	save_log("TPShort+;"+CoverPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
}
//---------------------------------------------------END SHORT+ - take profit

////////////////////////////////////////////////////Скользящий стоп +
//Определяем прибыль на текущем баре
if (poz_plus==-1) profit_plus=Position_price_plus-Low[i];
if (poz_plus==1) profit_plus=High[i]-Position_price_plus;
//Максимальная прибыль за время существования позиции
if (profit>=profit_max) profit_max=profit;

if (poz==-1 AND Position_price-High[i]<profit_max-ts AND profit_max>profit_ogr )
	{
			 	Cover[i]=True;
				poz=0;
				k=i;
				profit_max=0;
				CoverPrice[i]=High[i];
	}


if (poz==1 AND Position_price-Low[i]<profit_max-ts AND profit_max>profit_ogr)
	{
			 	Sell[i]=True;
				poz=0;
				k=i;
				profit_max=0;
				SellPrice[i]=Low[i];
	}
//////////////////////////////////////////////////Конец Скользящий стоп +
}
////////////////////////////////////////////////////КОНЕЦ ВЫХОД ДОБАВОЧКА СТОПЫ




//Принимаем решение на вход выход по закрытию бара, поэтому
i=n-1;
if(i<0) i=0;

//---------------------------------------------------Выходим по правилам системы
//---------------------------------------------------SELL 
	if (Exit_long==True AND poz==1 AND High [i]+0>Lline[i]+0 AND Low[i]+0<Lline[i]+0 AND
	EMA_l_fast[i]+0<=EMA_l_NOTfast[i]+0 AND i>k AND EMA_l_fast[i]>0 AND EMA_close[i]<=Lline[i]) 
{
//
	Sell[i]=True;
	SellPrice[i]=Close[i];
	SellPrice[i]=round(SellPrice[i]);
	Sell_flag=i+1;
//
	poz=0;
	k=i;
											
//Считаем и пишем все в файл
	rez_tek=(SellPrice[i]-Position_price)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
save_log("Sell;"+SellPrice[i]+";"+rez_tek+";"+rez);//Считаем и пишем все в файл


//--------------------------------------------------END SELL
}
//--------------------------------------------------COVER
	if (Exit_Short==True AND poz==-1 AND Low[i]<Hline[i] AND High[i]>Hline[i] AND
	EMA_h_fast[i]>=EMA_h_NOTfast[i] AND i>k AND EMA_h_fast[i]>0 AND EMA_close[i]>=Hline[i]) 
{
   Cover[i]=True;
	CoverPrice[i]=Close[i];
	Cover_flag=i+1;		
	poz=0;
	k=i;
		
		CoverPrice[i]=round(CoverPrice[i]);
//Установили бар следующего открытия позиции
											
	
//Считаем и пишем все в файл
	rez_tek=(Position_price-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Cover;"+CoverPrice[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
//---------------------------------------------------END COVER


}

/////////////////////////////////////////////////////ВЫХОД ДОБАВОЧКА ПРАВИЛА СИСТЕМЫ
//---------------------------------------------------Выходим по правилам системы

//---------------------------------------------------SELL+
	if ((ExitAll==True AND Exit_long==True AND poz_plus==1 AND Sell[i]==True) OR
		(poz_plus==1 AND High [i]+0>Lline[i]+0 AND Low[i]+0<Lline[i]+0 AND 
	EMA_l_fast[i]+0<=EMA_l_NOTfast[i]+0  AND EMA_l_fast[i]>0 AND EMA_close[i]<=Lline[i] AND ExitAll==False)) 
{
//
	Sell_plus[i]=True;
	SellPrice_plus[i]=Close[i];
	SellPrice_plus[i]=round(SellPrice_plus[i]);
//
	poz_plus=0;
											
	
//Считаем и пишем все в файл
	rez_tek=(SellPrice_plus[i]-Position_price_plus)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Sell+;"+SellPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
//--------------------------------------------------END SELL+

}
//--------------------------------------------------COVER+
	if ((ExitAll==True AND Exit_short==True AND poz_plus==-1 AND Cover[i]==True ) OR
	(poz_plus==-1 AND Low[i]<Hline[i] AND High[i]>Hline[i] AND
	EMA_h_fast[i]>=EMA_h_NOTfast[i]  AND EMA_h_fast[i]>0 AND EMA_close[i]>=Hline[i] AND ExitAll==False)) 
{
    Cover_plus[i]=True;
	CoverPrice_plus[i]=Close[i];
	poz_plus=0;
	CoverPrice_plus[i]=round(CoverPrice_plus[i]);
//Установили бар следующего открытия позиции
												
//Считаем и пишем все в файл
	rez_tek=(Position_price_plus-CoverPrice_plus[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Cover+;"+CoverPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
//---------------------------------------------------END COVER+
}

///////////////////////////////////КОНЕЦ ВЫХОД ДОБАВОЧКА ПРАВИЛА СИСТЕМЫ////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////// Входим
//----------------------------------------------------------------------LONG
	if (poz_plus==0 AND Open_Long==1 AND Low[i]<Hline[i] AND High[i]>Hline[i]  AND
	poz==0 AND EMA_h_fast[i]>=EMA_h_NOTfast[i] AND i>=sell_flag AND i>=k AND EMAO[i]>=Hline[i] AND ATRopti[i]>=ATRopt2 OR
	Low[i]<Hline[i] AND High[i]>Hline[i]  AND poz==0 AND EMA_h_fast[i]>=EMA_h_NOTfast[i] AND
	i>=sell_flag AND i>=k AND	ATRopti[i]<ATRopt2)
{ 
	Buy[i]=True;
	poz=1;
//сохраним номер бара на котором открыли позицию
	k=i;
	BuyPrice[i]=Close[i];
	BuyPrice[i]=round(BuyPrice[i]);
//обнулил счетчик стопов
stop_short=0;//счетчики стопов
switchSystem = 0;
ATRopt2=SwitchSystem;
Open_Short=1;
//разрешили вход добавки
enter_long_plus=0;
//сохраним цену открытия позиции	
Position_price=BuyPrice[i];
//Посчитали стопы
tp=ATR_12[i]*37;
if (tp<450) tp=tp*ATR_12[i];
sl=ATR_12[i]*10;
if(sl>150)sl=150;
								

//Считаем и пишем все в файл
	save_log("Buy;"+BuyPrice[i]+" tp="+tp);
//Считаем и пишем все в файл
//----------------------------------------------------------------------END LONG
} 




//----------------------------------------------------------------------SHORT
	if( poz_plus==0 AND Open_Short==1 AND (High[i]>Lline[i] AND Lline[i]>Low[i] AND
	poz==0 AND EMA_l_fast[i]<=EMA_l_NOTfast[i] AND i>=cover_flag AND i>=k AND EMAO[i]<=Lline[i] AND ATRopti[i]>=ATRopt2  ) OR 
	(High[i]>Lline[i] AND Lline[i]>Low[i] AND poz==0 AND EMA_l_fast[i]<=EMA_l_NOTfast[i] AND
	i>=cover_flag AND i>=k AND ATRopti[i]<ATRopt2))
{ 
	Short[i]=True;
	poz=-1;
//сохраним номер бара на котором открыли позицию
	k=i;
	ShortPrice[i]=Close[i];
	ShortPrice[i]=round(ShortPrice[i]);
//обнулил счетчик стопов
stop_long=0;//счетчики стопов
Open_Long=1;
switchSystem = 0;
ATRopt2=SwitchSystem;
//разрешили вход добавки
enter_short_plus=0;
//сохраним цену открытия позиции
	Position_price=ShortPrice[i];
//Посчитали стопы
	tp=ATR_12[i]*37;
	if (tp<450) tp=tp*ATR_12[i];
	sl=ATR_12[i]*10;
	if(sl>150)sl=150;
								

//Считаем и пишем все в файл
	save_log("Short;"+ShortPrice[i]+" tp="+tp);
//Считаем и пишем все в файл
//----------------------------------------------------------------------END SHORT
}




if(enter_plus==True) //authorized additive or not
{
//----------------------------------------------------------------------Добавляемся
//if (poz==-1) profit=Position_price-Low[i];
//if (poz==1) profit=High[i]-Position_price;

//----------------------------------------------------------------------SHORT+
if(i>=k_plus AND enter_short_plus<the_number_of_possible_additions AND profit>=profit_optimize AND
 poz_plus==0 AND High[i]>Lline[i] AND Lline[i]>Low[i] AND poz==-1 AND EMA_l_fast[i]<=EMA_l_NOTfast[i] AND
 i>=cover_flag AND EMAO243[i]>Hline[i]) 
{
	Short_plus[i]=True;
	poz_plus=-1;
//Save number for the bar which is open position
	k_plus=i;
	ShortPrice_plus[i]=Close[i];
	ShortPrice_plus[i]=round(ShortPrice_plus[i]);
//запретили вход добавки
enter_short_plus=enter_short_plus+1;
//сохраним цену открытия позиции
	Position_price_plus=ShortPrice_plus[i];
//Посчитали стопы
	tp_plus=ATR_12[i]*37; if(tp_plus<=390); tp_plus=tp_plus*ATR_12[i];
	sl_plus=sl;
//Считаем и пишем все в файл
	save_log("Short+;"+ShortPrice_plus[i]+" tp_plus="+tp_plus);
//Считаем и пишем все в файл
//----------------------------------------------------------------------END SHORT+

}
//----------------------------------------------------------------------LONG+	
if(i>=k_plus AND enter_Long_plus<the_number_of_possible_additions AND profit>=profit_optimize AND
 poz_plus==0 AND Low[i]<Hline[i] AND High[i]>Hline[i]  AND poz==1 AND EMA_h_fast[i]>=EMA_h_NOTfast[i] AND
 i>=sell_flag  AND EMAO243[i]<Hline[i])
{ 
	Buy_plus[i]=True;
	poz_plus=1;
//сохраним номер бара на котором открыли позицию
	k_plus=i;
	BuyPrice_plus[i]=Close[i];
	BuyPrice_plus[i]=round(BuyPrice_plus[i]);
//сохраним цену открытия позиции	
Position_price_plus=BuyPrice_plus[i];
//запретили вход добавки
enter_long_plus=enter_long_plus+1;
//Посчитали стопы
	tp_plus=ATR_12[i]*37; if(tp_plus<=390); tp_plus=tp_plus*ATR_12[i];
	sl_plus=sl;


	
	
//Считаем и пишем все в файл
	save_log("Buy+;"+BuyPrice_plus[i]+" tp_plus="+tp_plus);
//Считаем и пишем все в файл
}
//----------------------------------------------------------------------END LONG+

///////////////////////////До этого вставляем в АТС
}
//---END authorized additive or not



														

}

////////////////////////////////////////////ЭТО КОНЕЦ ЦИКЛА//////////////////////////
/////***************************************************************************** СИСТЕМА ...
/////**************************************************************************
/////********************************************************************
/////**************************************************************
/////*******************************************************






i=i+1;//Прибавили то, что отняли

//ЕСЛИ ОСТАЛАСЬ ПОЗИЦИЯ ОТКРЫТА ПОСЧИТАЕМ ТЕКУЩИЙ РЕЗУЛЬТАТ
if (poz==-1)
{
	//Считаем и пишем все в файл
	CoverPrice[i]=Close[i];
	rez_tek=(Position_price-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Cover;"+CoverPrice[i]+";"+rez_tek+";"+rez);
	//Считаем и пишем все в файл

//Добавочка
if(poz_plus!=0)
{
CoverPrice[i]=Close[i];
	rez_tek=(Position_price_plus-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Cover+;"+CoverPrice[i]+";"+rez_tek+";"+rez);
}
//Добавочка


}

if (poz==1)
{
//Считаем и пишем все в файл
	SellPrice[i]=Close[i];
	rez_tek=(SellPrice[i]-Position_price)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Sell;"+SellPrice[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
//Добавочка
if(poz_plus!=0)
{
SellPrice_plus[i]=Close[i];
	rez_tek=(SellPrice_plus[i]-Position_price_plus)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Sell+;"+SellPrice_plus[i]+";"+rez_tek+";"+rez);
}
//Добавочка
}

//ИТОГО
	save_log("*********************TOTAL=;"+rez);
	//-До сюда кидаем на график
	
//Теперь выведим толь результат по символу
rez_simvol= fopen("C:/ami/test/testrez42.txt", "a");
	//fputs(Name()+";"+rez+";"+Oema+";"+bars+";"+fast+";"+NOTfast+";"+nomber+"\n",rez_simvol);
	fputs(Name()+";"+rez+";"+prosadka+";"+ema_exit+";"+profit_no_exit+";"+nomber+"\n",rez_simvol);
	fclose(Lf);
//Дальше концы оптимизационных циклов

}
}
}
//}
//}


////*********************************ОПТИМИЗИРУЕМ СИСТЕМА
////ОПИСАНИЕ: - Входим контртренд добавляемся по тренду плюс профит разный выход
////////////////////////Погнали, это начало оптимизационных циклов
nomber=0; // это номер по порядку для сортировки строк с одинаковыми параметрами
///ЦИКЛЫ
for( i_stop=1; i_stop <16; i_stop =i_stop +1)
{ 
for( ema_exit=150; ema_exit <270; ema_exit=ema_exit+10)
{
for( profit_no_exit=300; profit_no_exit <450; profit_no_exit=profit_no_exit+10)
{
//for( profit_no_exit=300; profit_no_exit <450; profit_no_exit=profit_no_exit+10)
//{
//for( profit_no_exit=300; profit_no_exit <450; profit_no_exit=profit_no_exit+10)
//{
nomber=nomber+1;// это номер позиции по порядку для оптимизации


/////* * * * * * * * * * * * * * * * * * * * *****************************
/////* * * * * * * * * * * * * * * * * * * * 	********************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************	
/////* * * * * * * * * * * * *********************************************************** 
/////* * * * * * * * * * * * * * * * * * * * *********************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*********************************


/////* * * * * * * * * * * * * * * * * * * * *****************************
/////* * * * * * * * * * * * * * * * * * * * 	********************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************	
/////* * * * * * * * * * * * *********************************************************** 
/////* * * * * * * * * * * * * * * * * * * * *********************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*********************************


/////* * * * * * * * * * * * * * * * * * * * *****************************
/////* * * * * * * * * * * * * * * * * * * * 	********************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************	
/////* * * * * * * * * * * * *********************************************************** 
/////* * * * * * * * * * * * * * * * * * * * *********************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*********************************



/////**************                                      СИСТЕМА ...
/////***************************************************************************** 
/////**************************************************************************
/////********************************************************************
/////**************************************************************
/////*******************************************************	
///Дальше идет сама система т.е. то, что реально будем торговать
///////ОПИСАНИЕ:
system_diskription="222-01 ";

///////////////////////////////////////////////////////// ПАРАМЕТРЫ И УСТАНОВКИ СИСТЕМЫ///////////////
/*
Установки для автоматизированной торговли и ручной
автоторговля система сама, в зависимости от состояний рынка будет определять какую систему использовать 
при ручной торговли, что использовать определяется оператором
Выбираем нужное остальное закоментировать
*/
//switchSystem = 31;//АВТОРЕЖИМ(как СУПЕР)
switchSystem = 0;//КОНТРЕНД
///switchSystem = 100000;//ТРЕНД
ExitALL=True; // true=одинаковый выход добавки т.е. пока основная поза открыта поза плюс держиться, false=соответственно разный выход
Enter_plus=True; // МОЖНО ЛИ ДОБАВЛЯТЬСЯ.

///////////////////////////////////////////////////+Инициализация переменных
Seccode = "SRZ2";// Какой контракт

poz=0;//установили позицию в начале расчета
poz_plus=0;//Добавка
k=k_plus=0;//бар на котором открыта позиция
Position_price=0;//цена по которой открылись
Position_price_plus=0;//цена по которой добавились
profit_max=0;//Максимальная прибыль за время существования позиции
Open_Short=1;//Флаг на вход после пересечения скользящих средних Short
Open_Long=1;//Флаг на вход после пересечения скользящих средних Long
stop_short=0;//счетчики стопов
stop_long=0;//счетчики стопов
Exit_Short=True;
Exit_Long=True;
Enter_Short_plus=0;//запретили вход добавочки
Enter_Long_plus=0;//запретили вход добавочки
prosadka=0;//Самый большой зафиксированный минус по системе
cover_flag=0;
sell_flag=0;
id=0;
sl=tp=sl_plus=tp_plus=0;


												
													
													
																	
//This variables do not change												
profit=0;// результат по текущей позиции, предварительная установка
profit_plus=0;
rez=0;// Результат всего по данной системе
rez_tek=0;//Результат по текущей сделки
//profit_no_exit=400;//Прибыль после достижения которой выход до пересения средних запрещен
//ema_exit=243;//Средняя для пересечения на выход
profit_optimize= 10;//Прибыль после достижения которой разрешен второй вход
em=33;//Скользяшая средняя после которой добавляемся
ema_switch_fast_val=55;
ema_switch_slow_val=123;
the_number_of_possible_additions=2; //сколько раз можно входить после выхода добавки только для разных выходов, для одинакового выхода нге имеет смысла
//i_stop=10;
rezult=0; // результат в данной сделке после её закрытия (вспомогательная информация)
main_pozition=1;//amount of the basic position
plus_pozition=1;// amount of the plus position
////////////////////////////////////////////////-Инициализация переменных

///////////////////////////////////////////////////Установки системы
bars=7;// колво баров за которые ищется пик
fast=6;// быстрая скользящая средняя
NOTfast=9;// медленная скользящая средняя
adper=55;//для контренда, период ЕМА(О,adper) ниже(выше) которого можно открывать позицию в контренд
ATRopt=50;//период ATR(ATRopt) для определения тренд или контртренд
ATRopt2=SwitchSystem;//значение ATR(ATRopt) для определения тренд или контртренд
ts=150;//отклонение от максимального максимума по прибыли, для отработки скользящий стоп
profit_ogr=50000;//прибыль по достижению которой начинаем отслеживать скользящий стоп 
//(если не используешь скользящий стоп установить первое значение большое (такой прибыли быть не может)

//////////////////////////////////////////////////Индикаторы, линии, массивы

ema_switch_fast=EMA(O,ema_switch_fast_val);
ema_switch_slow=EMA(O,ema_switch_slow_val);

EMAO243=EMA(O,em);
ema_exit_mass=EMA(O,ema_exit);
///Линия пиков
HLine=Ref(HHV(H,bars),-1);
LLine=Ref(LLV(L,bars),-1);
///Среднии по верхам
MA_h_fast=MA(H,fast);
MA_h_NOTfast=MA(H,NOTfast);
///Среднии по низам
MA_l_fast=MA(L,fast);
MA_l_NOTfast=MA(L,NOTfast);
///Адаптивные среднии по верхам
EMA_h_fast=EMA(H,fast);
EMA_h_NOTfast=EMA(H,NOTfast);
///Адаптивные Среднии по низам
EMA_l_fast=EMA(L,fast);
EMA_l_NOTfast=EMA(L,NOTfast);
EMA_Close=EMA(C,fast);
EMAO=EMA(O,adper);
ATR_12=ATR(12);///определяем стопы;
ATRopti=ATR(ATRopt);///переключение системы
n=EndValue(BarIndex());///номер поcледнего бара
tm=TimeNum();/// масив времени баров
dm=Day(); /// массив дата
///////////////////////////////////////Procedure 

											


////////////////////////////////////////////////////КОНЕЦ ПАРАМЕТРЫ  И УСТАНОВКИ СИСТЕМЫ/////////////////////////

//НАЧАЛО ЦИКЛА ТЕСТИРОВАНИЯ
for( n = 0; n < BarCount; n++ )
{
if(n==0)
{
Lf = fopen(FileNameLog, "w");
	fputs(Name()+"Begin-------------------------------------------------------"+"\n",Lf);
	fclose(Lf);
}


//////////////////////////////////////////////////СТАРТ СИСТЕМЫ///////////////////////////////////////////
i=n;

Buy[i]=False;
Sell[i]=False;
Cover[i]=False;
Short[i]=False;	


//ПЕРЕКЛЮЧАТЕЛИ-ФЛАЖОЧКИ
Exit_short=True;//разрешили выход шорт
Exit_Long=True;//разрешили выход лонг
if (poz==-1) profit=Position_price-O[i];
if (poz_plus==-1) profit_plus=Position_price_plus-O[i];
//profit=profit+profit_plus;
if (poz==-1 AND profit>=profit_no_exit AND O[i] <=ema_exit_mass[i]) Exit_short=False;//Запретили выход если сильный тренд


if (poz==1) profit=O[i]-Position_price;
if (poz_plus==1) profit_plus=O[i]-Position_price_plus;
//profit=profit+profit_plus;
if (poz==1 AND profit>=profit_no_exit AND O[i] >=ema_exit_mass[i]) Exit_Long=False;//Запретили выход если сильный тренд

//переключатель 
if ((i>1 AND ema_switch_fast[i-1]>ema_switch_slow[i-1] AND  ema_switch_fast[i]<ema_switch_slow[i]) OR (i>1 AND ema_switch_fast[i-1]<ema_switch_slow[i-1] AND  ema_switch_fast[i]>ema_switch_slow[i]))
	{
	//open_short=1;
	//open_long=1;
	//stop_short=0;
	//stop_long=-0;
	}


///////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////ПРАВИЛА СИСТЕМЫ/////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////Выходим Основная 
/////////////////////////////////////////////////////STOPs/////////////////////////////////
//switchSystem = 0;
//if(prosadka<=1500) switchSystem = 100000;

//--------------------------------------------- SHORT - stoploss
	if (poz==-1 AND High[i]+0>=Position_price+sl AND i>k) 
{
	Cover[i]=True;
	CoverPrice[i]=Position_price+sl;
	poz=0;
	k=i;
	//если открытие выше стопа, закрываемся по открытию
	if(Open[i]>Position_price+sl)
	CoverPrice[i]=Open[i];
	CoverPrice[i]=round(CoverPrice[i]);
	//Считаем и пишем все в файл
	stoploss[i]=True;//для рисования
	rez_tek=(Position_price-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
														
	save_log("SLShort;"+CoverPrice[i]+";"+rez_tek+";"+rez);
//Переключаем запреты	
	stop_long=0;
	open_long=1;
	stop_short=stop_short+1;
			
			if(stop_short>=i_stop AND poz_plus==0) 
			{
			//switchSystem = 100000;
			ATRopt2=SwitchSystem;
			open_short=0;
				//купим 
				Buy[i]=True;
				poz=1;
				//сохраним номер бара на котором открыли позицию
				k=i;
				BuyPrice[i]=CoverPrice[i];
				Position_price=BuyPrice[i];
										
				//Считаем и пишем все в файл
				save_log("BuySwitch;"+BuyPrice[i]);
				//Считаем и пишем все в файл											
			}	

//--------------------------------------------END SHORT - stoploss
}

//--------------------------------------------LONG - stoploss
	if (poz==1 AND Low[i]+0<=Position_price-sl AND i>k) 
{
	Sell[i]=True;
	SellPrice[i]=Position_price-sl;
	poz=0;
	k=i;
//если открытие ниже стопа, выходим на открытии бара
	if(Open[i]<Position_price-sl)
	SellPrice[i]=Open[i];
	SellPrice[i]=round(SellPrice[i]);
	//Считаем и пишем все в файл
	stoploss[i]=True;//для рисования
	rez_tek=(SellPrice[i]-Position_price)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
	if(rez<=prosadka) prosadka=rez;
	//k=i+1;
														
save_log("SLBuy;"+SellPrice[i]+";"+rez_tek+";"+rez);
//переключаем флажочки
	stop_short=0;
	open_short=1;	
	stop_long=stop_long+1;
		if (stop_long>=i_stop AND poz==0) 
	{
		//switchSystem = 100000;
		ATRopt2=SwitchSystem;
		open_long=0;
		//продадим
		Short[i]=True;
		poz=-1;
		//сохраним номер бара на котором открыли позицию
		k=i;
		ShortPrice[i]=SellPrice[i];
		Position_price=ShortPrice[i];
							
			
		//Считаем и пишем все в файл
		save_log("ShortSwitch;"+ShortPrice[i]);
		//Считаем и пишем все в файл
	}
	

//--------------------------------------------------END LONG - stoploss	


}

//--------------------------------------------------LONG - take profit
	if (Exit_long==True AND poz==1 AND (High[i]+0)>=Position_price+tp AND i>k) 
{
	Sell[i]=True;
	SellPrice[i]=Position_price+tp;
	k=i;
// если открытие выше тэйка, выходим сразу на открытии
	if(Open[i]>Position_price+tp)
	SellPrice[i]=Open[i];
	SellPrice[i]=round(SellPrice[i]);
//обнулим позицию в файле 
	poz=0;
//Установили бар следующего открытия позиции
k=i;

//Считаем и пишем все в файл
	takeprofit[i]=True;//для рисования
	rez_tek=(SellPrice[i]-Position_price)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
												
	
	save_log("TPBuy;"+SellPrice[i]+";"+rez_tek+";"+rez);//Считаем и пишем все в файл

}
//-------------------------------------------------- END LONG - take profit


//---------------------------------------------------SHORT - take profit

    if (Exit_Short==True AND poz==-1 AND (Low[i]+0)<=Position_price-tp AND i>k) 
{
	Cover[i]=True;
	CoverPrice[i]=Position_price-tp;
// если открытие ниже тэйка, выходим сразу на открытии
	if (Open[i]<Position_price-tp)
	CoverPrice[i]=Open[i];
	CoverPrice[i]=round(CoverPrice[i]);
//обнулим позицию в файле 
	poz=0;
//Установили бар следующего открытия позиции
k=i;
	takeprofit[i]=True;//для рисования
	rez_tek=(Position_price-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
												
save_log("TPShort;"+CoverPrice[i]+";"+rez_tek+";"+rez);//Считаем и пишем все в файл

}
//---------------------------------------------------END SHORT - take profit

////////////////////////////////////////////////////Скользящий стоп 

//Определяем прибыль на текущем баре
if (poz==-1) profit=Position_price-Low[i];
if (poz==1) profit=High[i]-Position_price;
//Максимальная прибыль за время существования позиции
if (profit>=profit_max) profit_max=profit;

if (poz==-1 AND Position_price-High[i]<profit_max-ts AND profit_max>profit_ogr )
	{
			 	Cover[i]=True;
				poz=0;
				k=i;
				profit_max=0;
				CoverPrice[i]=High[i];
	}


if (poz==1 AND Position_price-Low[i]<profit_max-ts AND profit_max>profit_ogr)
	{
			 	Sell[i]=True;
				poz=0;
				k=i;
				profit_max=0;
				SellPrice[i]=Low[i];
	}

//////////////////////////////////////////////////Конец Скользящий стоп

/////////////////////////////////////////////////ВЫХОД ДОБАВОЧКА СТОПЫ
if(poz_plus!=0)
{
//--------------------------------------------- SHORT+ - stoploss

	if ((poz_plus==-1 AND Cover[i]==True AND ExitAll==True AND stoploss[i]==True) OR 
	(poz_plus==-1 AND High[i]+0>=Position_price_plus+sl_plus AND ExitAll==False)) 
{
	Cover_plus[i]=True;
	if(ExitALL==True) CoverPrice_plus[i]=CoverPrice[i];//одинаковый выход
	if(ExitALL==False) CoverPrice_plus[i]=Position_price_plus+sl_plus;//разный выход
	poz_plus=0;
//если открытие выше стопа, закрываемся по открытию
	if(Open[i]>Position_price_plus+sl_plus AND ExitAll==False) CoverPrice_plus[i]=Open[i]; //разный выход
	CoverPrice_plus[i]=round(CoverPrice_plus[i]);
	
//Установили бар следующего открытия позиции
k_plus=i;
//
//Open_Short=0;
//Считаем и пишем все в файл
	stoploss_plus[i]=True;//для рисования
	rez_tek=(Position_price_plus-CoverPrice_plus[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
	if(rez<=prosadka) prosadka=rez;
								
	
	save_log("SLShort+;"+CoverPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
}
//--------------------------------------------END SHORT+ - stoploss


//--------------------------------------------LONG+ - stoploss
	if ((poz_plus==1 AND Sell[i]==True AND ExitAll==True AND stoploss[i]==True) OR
	(poz_plus==1 AND Low[i]+0<=Position_price_plus-sl_plus AND ExitAll==False)) 
{
	Sell_plus[i]=True;
	if(ExitALL==True) SellPrice_plus[i]=SellPrice[i];//одинаковый выход
	if(ExitALL==False) SellPrice_plus[i]=Position_price_plus-sl_plus;//разный выход
	poz_plus=0;
//если открытие ниже стопа, выходим на открытии бара
	if(Open[i]<Position_price_plus-sl_plus AND ExitAll==False) SellPrice_plus[i]=Open[i]; //разный выход
	SellPrice_plus[i]=round(SellPrice_plus[i]);
//Установили бар следующего открытия позиции
k_plus=i;
//
//Open_Long=0;

//Считаем и пишем все в файл
	stoploss_plus[i]=True;//для рисования
	rez_tek=(SellPrice_plus[i]-Position_price_plus)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
												

	save_log("SLBuy+;"+SellPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
}
//--------------------------------------------------END LONG+ - stoploss	

//--------------------------------------------------LONG+ - take profit
	if ((poz_plus==1 AND Sell[i]==True AND ExitAll==True AND takeprofit[i]==True)  OR
	(poz_plus==1 AND High[i]>=Position_price_plus+tp_plus AND ExitAll==False)) 
{
	Sell_plus[i]=True;
	if(ExitALL==True) SellPrice_plus[i]=SellPrice[i];//одинаковый выход
	if(ExitALL==False) SellPrice_plus[i]=Position_price_plus+tp_plus;//разный выход
// если открытие выше тэйка, выходим сразу на открытии
	if(Open[i]>Position_price_plus+tp_plus AND ExitAll==False) SellPrice_plus[i]=Open[i];//разный выход
	SellPrice_plus[i]=round(SellPrice_plus[i]);
	poz_plus=0;
//Установили бар следующего открытия позиции
k_plus=i;
//Считаем и пишем все в файл
	takeprofit_plus[i]=True;//для рисования
	rez_tek=(SellPrice_plus[i]-Position_price_plus)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
									
	save_log("TPBuy+;"+SellPrice[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
}
//-------------------------------------------------- END LONG+ - take profit


//---------------------------------------------------SHORT+ - take profit
    if ((poz_plus==-1 AND Cover[i]==True AND ExitAll==True AND takeprofit[i]==True) OR
	(poz_plus==-1 AND Low[i]<=Position_price_plus-tp_plus AND ExitAll==False) ) 
{
	Cover_plus[i]=True;
	if (ExitAll==True) CoverPrice_plus[i]=CoverPrice[i];//одинаковый выход
	if (ExitAll==False) CoverPrice_plus[i]=Position_price_plus-tp_plus;//разный выход
// если открытие ниже тэйка, выходим сразу на открытии
	if (Open[i]<Position_price_plus-tp_plus AND ExitAll==False) CoverPrice_plus[i]=Open[i];
	CoverPrice_plus[i]=round(CoverPrice_plus[i]);
//обнулим позицию в файле 
	poz_plus=0;
//Установили бар следующего открытия позиции
k_plus=i;
//Считаем и пишем все в файл
	takeprofit_plus[i]=True;//для рисования
	rez_tek=(Position_price_plus-CoverPrice_plus[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
													
	save_log("TPShort+;"+CoverPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
}
//---------------------------------------------------END SHORT+ - take profit

////////////////////////////////////////////////////Скользящий стоп +
//Определяем прибыль на текущем баре
if (poz_plus==-1) profit_plus=Position_price_plus-Low[i];
if (poz_plus==1) profit_plus=High[i]-Position_price_plus;
//Максимальная прибыль за время существования позиции
if (profit>=profit_max) profit_max=profit;

if (poz==-1 AND Position_price-High[i]<profit_max-ts AND profit_max>profit_ogr )
	{
			 	Cover[i]=True;
				poz=0;
				k=i;
				profit_max=0;
				CoverPrice[i]=High[i];
	}


if (poz==1 AND Position_price-Low[i]<profit_max-ts AND profit_max>profit_ogr)
	{
			 	Sell[i]=True;
				poz=0;
				k=i;
				profit_max=0;
				SellPrice[i]=Low[i];
	}
//////////////////////////////////////////////////Конец Скользящий стоп +
}
////////////////////////////////////////////////////КОНЕЦ ВЫХОД ДОБАВОЧКА СТОПЫ




//Принимаем решение на вход выход по закрытию бара, поэтому
i=n-1;
if(i<0) i=0;

//---------------------------------------------------Выходим по правилам системы
//---------------------------------------------------SELL 
	if (Exit_long==True AND poz==1 AND High [i]+0>Lline[i]+0 AND Low[i]+0<Lline[i]+0 AND
	EMA_l_fast[i]+0<=EMA_l_NOTfast[i]+0 AND i>k AND EMA_l_fast[i]>0 AND EMA_close[i]<=Lline[i]) 
{
//
	Sell[i]=True;
	SellPrice[i]=Close[i];
	SellPrice[i]=round(SellPrice[i]);
	Sell_flag=i+1;
//
	poz=0;
	k=i;
											
//Считаем и пишем все в файл
	rez_tek=(SellPrice[i]-Position_price)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
save_log("Sell;"+SellPrice[i]+";"+rez_tek+";"+rez);//Считаем и пишем все в файл


//--------------------------------------------------END SELL
}
//--------------------------------------------------COVER
	if (Exit_Short==True AND poz==-1 AND Low[i]<Hline[i] AND High[i]>Hline[i] AND
	EMA_h_fast[i]>=EMA_h_NOTfast[i] AND i>k AND EMA_h_fast[i]>0 AND EMA_close[i]>=Hline[i]) 
{
   Cover[i]=True;
	CoverPrice[i]=Close[i];
	Cover_flag=i+1;		
	poz=0;
	k=i;
		
		CoverPrice[i]=round(CoverPrice[i]);
//Установили бар следующего открытия позиции
											
	
//Считаем и пишем все в файл
	rez_tek=(Position_price-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Cover;"+CoverPrice[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
//---------------------------------------------------END COVER


}

/////////////////////////////////////////////////////ВЫХОД ДОБАВОЧКА ПРАВИЛА СИСТЕМЫ
//---------------------------------------------------Выходим по правилам системы

//---------------------------------------------------SELL+
	if ((ExitAll==True AND Exit_long==True AND poz_plus==1 AND Sell[i]==True) OR
		(poz_plus==1 AND High [i]+0>Lline[i]+0 AND Low[i]+0<Lline[i]+0 AND 
	EMA_l_fast[i]+0<=EMA_l_NOTfast[i]+0  AND EMA_l_fast[i]>0 AND EMA_close[i]<=Lline[i] AND ExitAll==False)) 
{
//
	Sell_plus[i]=True;
	SellPrice_plus[i]=Close[i];
	SellPrice_plus[i]=round(SellPrice_plus[i]);
//
	poz_plus=0;
											
	
//Считаем и пишем все в файл
	rez_tek=(SellPrice_plus[i]-Position_price_plus)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Sell+;"+SellPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
//--------------------------------------------------END SELL+

}
//--------------------------------------------------COVER+
	if ((ExitAll==True AND Exit_short==True AND poz_plus==-1 AND Cover[i]==True ) OR
	(poz_plus==-1 AND Low[i]<Hline[i] AND High[i]>Hline[i] AND
	EMA_h_fast[i]>=EMA_h_NOTfast[i]  AND EMA_h_fast[i]>0 AND EMA_close[i]>=Hline[i] AND ExitAll==False)) 
{
    Cover_plus[i]=True;
	CoverPrice_plus[i]=Close[i];
	poz_plus=0;
	CoverPrice_plus[i]=round(CoverPrice_plus[i]);
//Установили бар следующего открытия позиции
												
//Считаем и пишем все в файл
	rez_tek=(Position_price_plus-CoverPrice_plus[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Cover+;"+CoverPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
//---------------------------------------------------END COVER+
}

///////////////////////////////////КОНЕЦ ВЫХОД ДОБАВОЧКА ПРАВИЛА СИСТЕМЫ////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////// Входим
//----------------------------------------------------------------------LONG
	if (poz_plus==0 AND Open_Long==1 AND Low[i]<Hline[i] AND High[i]>Hline[i]  AND
	poz==0 AND EMA_h_fast[i]>=EMA_h_NOTfast[i] AND i>=sell_flag AND i>=k AND EMAO[i]>=Hline[i] AND ATRopti[i]>=ATRopt2 OR
	Low[i]<Hline[i] AND High[i]>Hline[i]  AND poz==0 AND EMA_h_fast[i]>=EMA_h_NOTfast[i] AND
	i>=sell_flag AND i>=k AND	ATRopti[i]<ATRopt2)
{ 
	Buy[i]=True;
	poz=1;
//сохраним номер бара на котором открыли позицию
	k=i;
	BuyPrice[i]=Close[i];
	BuyPrice[i]=round(BuyPrice[i]);
//обнулил счетчик стопов
stop_short=0;//счетчики стопов
switchSystem = 0;
ATRopt2=SwitchSystem;
Open_Short=1;
//разрешили вход добавки
enter_long_plus=0;
//сохраним цену открытия позиции	
Position_price=BuyPrice[i];
//Посчитали стопы
tp=ATR_12[i]*37;
if (tp<450) tp=tp*ATR_12[i];
sl=ATR_12[i]*10;
if(sl>150)sl=150;
								

//Считаем и пишем все в файл
	save_log("Buy;"+BuyPrice[i]+" tp="+tp);
//Считаем и пишем все в файл
//----------------------------------------------------------------------END LONG
} 




//----------------------------------------------------------------------SHORT
	if( poz_plus==0 AND Open_Short==1 AND (High[i]>Lline[i] AND Lline[i]>Low[i] AND
	poz==0 AND EMA_l_fast[i]<=EMA_l_NOTfast[i] AND i>=cover_flag AND i>=k AND EMAO[i]<=Lline[i] AND ATRopti[i]>=ATRopt2  ) OR 
	(High[i]>Lline[i] AND Lline[i]>Low[i] AND poz==0 AND EMA_l_fast[i]<=EMA_l_NOTfast[i] AND
	i>=cover_flag AND i>=k AND ATRopti[i]<ATRopt2))
{ 
	Short[i]=True;
	poz=-1;
//сохраним номер бара на котором открыли позицию
	k=i;
	ShortPrice[i]=Close[i];
	ShortPrice[i]=round(ShortPrice[i]);
//обнулил счетчик стопов
stop_long=0;//счетчики стопов
Open_Long=1;
switchSystem = 0;
ATRopt2=SwitchSystem;
//разрешили вход добавки
enter_short_plus=0;
//сохраним цену открытия позиции
	Position_price=ShortPrice[i];
//Посчитали стопы
	tp=ATR_12[i]*37;
	if (tp<450) tp=tp*ATR_12[i];
	sl=ATR_12[i]*10;
	if(sl>150)sl=150;
								

//Считаем и пишем все в файл
	save_log("Short;"+ShortPrice[i]+" tp="+tp);
//Считаем и пишем все в файл
//----------------------------------------------------------------------END SHORT
}




if(enter_plus==True) //authorized additive or not
{
//----------------------------------------------------------------------Добавляемся
if (poz==-1) profit=Position_price-Low[i];
if (poz==1) profit=High[i]-Position_price;

//----------------------------------------------------------------------SHORT+
if(i>=k_plus AND enter_short_plus<the_number_of_possible_additions AND profit>=profit_optimize AND
 poz_plus==0 AND High[i]>Lline[i] AND Lline[i]>Low[i] AND poz==-1 AND EMA_l_fast[i]<=EMA_l_NOTfast[i] AND
 i>=cover_flag AND EMAO243[i]>Hline[i]) 
{
	Short_plus[i]=True;
	poz_plus=-1;
//Save number for the bar which is open position
	k_plus=i;
	ShortPrice_plus[i]=Close[i];
	ShortPrice_plus[i]=round(ShortPrice_plus[i]);
//запретили вход добавки
enter_short_plus=enter_short_plus+1;
//сохраним цену открытия позиции
	Position_price_plus=ShortPrice_plus[i];
//Посчитали стопы
	tp_plus=ATR_12[i]*37; if(tp_plus<=390); tp_plus=tp_plus*ATR_12[i];
	sl_plus=sl;
//Считаем и пишем все в файл
	save_log("Short+;"+ShortPrice_plus[i]+" tp_plus="+tp_plus);
//Считаем и пишем все в файл
//----------------------------------------------------------------------END SHORT+

}
//----------------------------------------------------------------------LONG+	
if(i>=k_plus AND enter_Long_plus<the_number_of_possible_additions AND profit>=profit_optimize AND
 poz_plus==0 AND Low[i]<Hline[i] AND High[i]>Hline[i]  AND poz==1 AND EMA_h_fast[i]>=EMA_h_NOTfast[i] AND
 i>=sell_flag  AND EMAO243[i]<Hline[i])
{ 
	Buy_plus[i]=True;
	poz_plus=1;
//сохраним номер бара на котором открыли позицию
	k_plus=i;
	BuyPrice_plus[i]=Close[i];
	BuyPrice_plus[i]=round(BuyPrice_plus[i]);
//сохраним цену открытия позиции	
Position_price_plus=BuyPrice_plus[i];
//запретили вход добавки
enter_long_plus=enter_long_plus+1;
//Посчитали стопы
	tp_plus=ATR_12[i]*37; if(tp_plus<=390); tp_plus=tp_plus*ATR_12[i];
	sl_plus=sl;


	
	
//Считаем и пишем все в файл
	save_log("Buy+;"+BuyPrice_plus[i]+" tp_plus="+tp_plus);
//Считаем и пишем все в файл
}
//----------------------------------------------------------------------END LONG+

///////////////////////////До этого вставляем в АТС
}
//---END authorized additive or not



														

}

////////////////////////////////////////////ЭТО КОНЕЦ ЦИКЛА//////////////////////////
/////***************************************************************************** СИСТЕМА ...
/////**************************************************************************
/////********************************************************************
/////**************************************************************
/////*******************************************************






i=i+1;//Прибавили то, что отняли

//ЕСЛИ ОСТАЛАСЬ ПОЗИЦИЯ ОТКРЫТА ПОСЧИТАЕМ ТЕКУЩИЙ РЕЗУЛЬТАТ
if (poz==-1)
{
	//Считаем и пишем все в файл
	CoverPrice[i]=Close[i];
	rez_tek=(Position_price-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Cover;"+CoverPrice[i]+";"+rez_tek+";"+rez);
	//Считаем и пишем все в файл

//Добавочка
if(poz_plus!=0)
{
CoverPrice[i]=Close[i];
	rez_tek=(Position_price_plus-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Cover+;"+CoverPrice[i]+";"+rez_tek+";"+rez);
}
//Добавочка


}

if (poz==1)
{
//Считаем и пишем все в файл
	SellPrice[i]=Close[i];
	rez_tek=(SellPrice[i]-Position_price)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Sell;"+SellPrice[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
//Добавочка
if(poz_plus!=0)
{
SellPrice_plus[i]=Close[i];
	rez_tek=(SellPrice_plus[i]-Position_price_plus)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Sell+;"+SellPrice_plus[i]+";"+rez_tek+";"+rez);
}
//Добавочка
}

//ИТОГО
	save_log("*********************TOTAL=;"+rez);
	//-До сюда кидаем на график
	
//Теперь выведим толь результат по символу
rez_simvol= fopen("C:/ami/test/testrez43.txt", "a");
	//fputs(Name()+";"+rez+";"+Oema+";"+bars+";"+fast+";"+NOTfast+";"+nomber+"\n",rez_simvol);
	fputs(Name()+";"+rez+";"+prosadka+";"+ema_exit+";"+profit_no_exit+";"+nomber+"\n",rez_simvol);
	fclose(Lf);
//Дальше концы оптимизационных циклов

}
}
}
//}
//}


////*********************************ОПТИМИЗИРУЕМ СИСТЕМА
////ОПИСАНИЕ: - Входим контртренд добавляемся по тренду плюс профит разный выход
////////////////////////Погнали, это начало оптимизационных циклов
nomber=0; // это номер по порядку для сортировки строк с одинаковыми параметрами
///ЦИКЛЫ
for( i_stop=1; i_stop <16; i_stop =i_stop +1)
{ 
for( ema_exit=150; ema_exit <270; ema_exit=ema_exit+10)
{
for( profit_no_exit=300; profit_no_exit <450; profit_no_exit=profit_no_exit+10)
{
//for( profit_no_exit=300; profit_no_exit <450; profit_no_exit=profit_no_exit+10)
//{
//for( profit_no_exit=300; profit_no_exit <450; profit_no_exit=profit_no_exit+10)
//{
nomber=nomber+1;// это номер позиции по порядку для оптимизации


/////* * * * * * * * * * * * * * * * * * * * *****************************
/////* * * * * * * * * * * * * * * * * * * * 	********************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************	
/////* * * * * * * * * * * * *********************************************************** 
/////* * * * * * * * * * * * * * * * * * * * *********************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*********************************


/////* * * * * * * * * * * * * * * * * * * * *****************************
/////* * * * * * * * * * * * * * * * * * * * 	********************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************	
/////* * * * * * * * * * * * *********************************************************** 
/////* * * * * * * * * * * * * * * * * * * * *********************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*********************************


/////* * * * * * * * * * * * * * * * * * * * *****************************
/////* * * * * * * * * * * * * * * * * * * * 	********************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************	
/////* * * * * * * * * * * * *********************************************************** 
/////* * * * * * * * * * * * * * * * * * * * *********************************************
/////* * * * * * * * * * * * * * * * * * * * 	*****************************************
/////* * * * * * * * * * * * * * * * * * * * 	************************************
/////* * * * * * * * * * * * * * * * * * * * 	*********************************



/////**************                                      СИСТЕМА ...
/////***************************************************************************** 
/////**************************************************************************
/////********************************************************************
/////**************************************************************
/////*******************************************************	
///Дальше идет сама система т.е. то, что реально будем торговать
///////ОПИСАНИЕ:
system_diskription="222-01 ";

///////////////////////////////////////////////////////// ПАРАМЕТРЫ И УСТАНОВКИ СИСТЕМЫ///////////////
/*
Установки для автоматизированной торговли и ручной
автоторговля система сама, в зависимости от состояний рынка будет определять какую систему использовать 
при ручной торговли, что использовать определяется оператором
Выбираем нужное остальное закоментировать
*/
//switchSystem = 31;//АВТОРЕЖИМ(как СУПЕР)
switchSystem = 0;//КОНТРЕНД
///switchSystem = 100000;//ТРЕНД
ExitALL=True; // true=одинаковый выход добавки т.е. пока основная поза открыта поза плюс держиться, false=соответственно разный выход
Enter_plus=True; // МОЖНО ЛИ ДОБАВЛЯТЬСЯ.

///////////////////////////////////////////////////+Инициализация переменных
Seccode = "SRZ2";// Какой контракт

poz=0;//установили позицию в начале расчета
poz_plus=0;//Добавка
k=k_plus=0;//бар на котором открыта позиция
Position_price=0;//цена по которой открылись
Position_price_plus=0;//цена по которой добавились
profit_max=0;//Максимальная прибыль за время существования позиции
Open_Short=1;//Флаг на вход после пересечения скользящих средних Short
Open_Long=1;//Флаг на вход после пересечения скользящих средних Long
stop_short=0;//счетчики стопов
stop_long=0;//счетчики стопов
Exit_Short=True;
Exit_Long=True;
Enter_Short_plus=0;//запретили вход добавочки
Enter_Long_plus=0;//запретили вход добавочки
prosadka=0;//Самый большой зафиксированный минус по системе
cover_flag=0;
sell_flag=0;
id=0;
sl=tp=sl_plus=tp_plus=0;


												
														
													
																	
//This variables do not change												
profit=0;// результат по текущей позиции, предварительная установка
profit_plus=0;
rez=0;// Результат всего по данной системе
rez_tek=0;//Результат по текущей сделки
//profit_no_exit=400;//Прибыль после достижения которой выход до пересения средних запрещен
//ema_exit=243;//Средняя для пересечения на выход
profit_optimize= 10;//Прибыль после достижения которой разрешен второй вход
em=33;//Скользяшая средняя после которой добавляемся
ema_switch_fast_val=55;
ema_switch_slow_val=123;
the_number_of_possible_additions=2; //сколько раз можно входить после выхода добавки только для разных выходов, для одинакового выхода нге имеет смысла
//i_stop=10;
rezult=0; // результат в данной сделке после её закрытия (вспомогательная информация)
main_pozition=1;//amount of the basic position
plus_pozition=1;// amount of the plus position
////////////////////////////////////////////////-Инициализация переменных

///////////////////////////////////////////////////Установки системы
bars=7;// колво баров за которые ищется пик
fast=6;// быстрая скользящая средняя
NOTfast=9;// медленная скользящая средняя
adper=55;//для контренда, период ЕМА(О,adper) ниже(выше) которого можно открывать позицию в контренд
ATRopt=50;//период ATR(ATRopt) для определения тренд или контртренд
ATRopt2=SwitchSystem;//значение ATR(ATRopt) для определения тренд или контртренд
ts=150;//отклонение от максимального максимума по прибыли, для отработки скользящий стоп
profit_ogr=50000;//прибыль по достижению которой начинаем отслеживать скользящий стоп 
//(если не используешь скользящий стоп установить первое значение большое (такой прибыли быть не может)

//////////////////////////////////////////////////Индикаторы, линии, массивы

ema_switch_fast=EMA(O,ema_switch_fast_val);
ema_switch_slow=EMA(O,ema_switch_slow_val);

EMAO243=EMA(O,em);
ema_exit_mass=EMA(O,ema_exit);
///Линия пиков
HLine=Ref(HHV(H,bars),-1);
LLine=Ref(LLV(L,bars),-1);
///Среднии по верхам
MA_h_fast=MA(H,fast);
MA_h_NOTfast=MA(H,NOTfast);
///Среднии по низам
MA_l_fast=MA(L,fast);
MA_l_NOTfast=MA(L,NOTfast);
///Адаптивные среднии по верхам
EMA_h_fast=EMA(H,fast);
EMA_h_NOTfast=EMA(H,NOTfast);
///Адаптивные Среднии по низам
EMA_l_fast=EMA(L,fast);
EMA_l_NOTfast=EMA(L,NOTfast);
EMA_Close=EMA(C,fast);
EMAO=EMA(O,adper);
ATR_12=ATR(12);///определяем стопы;
ATRopti=ATR(ATRopt);///переключение системы
n=EndValue(BarIndex());///номер поcледнего бара
tm=TimeNum();/// масив времени баров
dm=Day(); /// массив дата
///////////////////////////////////////Procedure 

											


////////////////////////////////////////////////////КОНЕЦ ПАРАМЕТРЫ  И УСТАНОВКИ СИСТЕМЫ/////////////////////////

//НАЧАЛО ЦИКЛА ТЕСТИРОВАНИЯ
for( n = 0; n < BarCount; n++ )
{
if(n==0)
{
Lf = fopen(FileNameLog, "w");
	fputs(Name()+"Begin-------------------------------------------------------"+"\n",Lf);
	fclose(Lf);
}


//////////////////////////////////////////////////СТАРТ СИСТЕМЫ///////////////////////////////////////////
i=n;

Buy[i]=False;
Sell[i]=False;
Cover[i]=False;
Short[i]=False;	


//ПЕРЕКЛЮЧАТЕЛИ-ФЛАЖОЧКИ
Exit_short=True;//разрешили выход шорт
Exit_Long=True;//разрешили выход лонг
if (poz==-1) profit=Position_price-O[i];
if (poz_plus==-1) profit_plus=Position_price_plus-O[i];
//profit=profit+profit_plus;
if (poz==-1 AND profit>=profit_no_exit AND O[i] <=ema_exit_mass[i]) Exit_short=False;//Запретили выход если сильный тренд


if (poz==1) profit=O[i]-Position_price;
if (poz_plus==1) profit_plus=O[i]-Position_price_plus;
//profit=profit+profit_plus;
if (poz==1 AND profit>=profit_no_exit AND O[i] >=ema_exit_mass[i]) Exit_Long=False;//Запретили выход если сильный тренд

//переключатель 
if ((i>1 AND ema_switch_fast[i-1]>ema_switch_slow[i-1] AND  ema_switch_fast[i]<ema_switch_slow[i]) OR (i>1 AND ema_switch_fast[i-1]<ema_switch_slow[i-1] AND  ema_switch_fast[i]>ema_switch_slow[i]))
	{
	//open_short=1;
	//open_long=1;
	//stop_short=0;
	//stop_long=-0;
	}


///////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////ПРАВИЛА СИСТЕМЫ/////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////Выходим Основная 
/////////////////////////////////////////////////////STOPs/////////////////////////////////
//switchSystem = 0;
//if(prosadka<=1500) switchSystem = 100000;

//--------------------------------------------- SHORT - stoploss
	if (poz==-1 AND High[i]+0>=Position_price+sl AND i>k) 
{
	Cover[i]=True;
	CoverPrice[i]=Position_price+sl;
	poz=0;
	k=i;
	//если открытие выше стопа, закрываемся по открытию
	if(Open[i]>Position_price+sl)
	CoverPrice[i]=Open[i];
	CoverPrice[i]=round(CoverPrice[i]);
	//Считаем и пишем все в файл
	stoploss[i]=True;//для рисования
	rez_tek=(Position_price-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
														
	save_log("SLShort;"+CoverPrice[i]+";"+rez_tek+";"+rez);
//Переключаем запреты	
	stop_long=0;
	open_long=1;
	stop_short=stop_short+1;
			
			if(stop_short>=i_stop AND poz_plus==0) 
			{
			//switchSystem = 100000;
			ATRopt2=SwitchSystem;
			open_short=0;
				//купим 
				Buy[i]=True;
				poz=1;
				//сохраним номер бара на котором открыли позицию
				k=i;
				BuyPrice[i]=CoverPrice[i];
				Position_price=BuyPrice[i];
										
				//Считаем и пишем все в файл
				save_log("BuySwitch;"+BuyPrice[i]);
				//Считаем и пишем все в файл											
			}	

//--------------------------------------------END SHORT - stoploss
}

//--------------------------------------------LONG - stoploss
	if (poz==1 AND Low[i]+0<=Position_price-sl AND i>k) 
{
	Sell[i]=True;
	SellPrice[i]=Position_price-sl;
	poz=0;
	k=i;
//если открытие ниже стопа, выходим на открытии бара
	if(Open[i]<Position_price-sl)
	SellPrice[i]=Open[i];
	SellPrice[i]=round(SellPrice[i]);
	//Считаем и пишем все в файл
	stoploss[i]=True;//для рисования
	rez_tek=(SellPrice[i]-Position_price)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
	if(rez<=prosadka) prosadka=rez;
	//k=i+1;
														
save_log("SLBuy;"+SellPrice[i]+";"+rez_tek+";"+rez);
//переключаем флажочки
	stop_short=0;
	open_short=1;	
	stop_long=stop_long+1;
		if (stop_long>=i_stop AND poz==0) 
	{
		//switchSystem = 100000;
		ATRopt2=SwitchSystem;
		open_long=0;
		//продадим
		Short[i]=True;
		poz=-1;
		//сохраним номер бара на котором открыли позицию
		k=i;
		ShortPrice[i]=SellPrice[i];
		Position_price=ShortPrice[i];
							
			
		//Считаем и пишем все в файл
		save_log("ShortSwitch;"+ShortPrice[i]);
		//Считаем и пишем все в файл
	}
	

//--------------------------------------------------END LONG - stoploss	


}

//--------------------------------------------------LONG - take profit
	if (Exit_long==True AND poz==1 AND (High[i]+0)>=Position_price+tp AND i>k) 
{
	Sell[i]=True;
	SellPrice[i]=Position_price+tp;
	k=i;
// если открытие выше тэйка, выходим сразу на открытии
	if(Open[i]>Position_price+tp)
	SellPrice[i]=Open[i];
	SellPrice[i]=round(SellPrice[i]);
//обнулим позицию в файле 
	poz=0;
//Установили бар следующего открытия позиции
k=i;

//Считаем и пишем все в файл
	takeprofit[i]=True;//для рисования
	rez_tek=(SellPrice[i]-Position_price)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
												
	
	save_log("TPBuy;"+SellPrice[i]+";"+rez_tek+";"+rez);//Считаем и пишем все в файл

}
//-------------------------------------------------- END LONG - take profit


//---------------------------------------------------SHORT - take profit

    if (Exit_Short==True AND poz==-1 AND (Low[i]+0)<=Position_price-tp AND i>k) 
{
	Cover[i]=True;
	CoverPrice[i]=Position_price-tp;
// если открытие ниже тэйка, выходим сразу на открытии
	if (Open[i]<Position_price-tp)
	CoverPrice[i]=Open[i];
	CoverPrice[i]=round(CoverPrice[i]);
//обнулим позицию в файле 
	poz=0;
//Установили бар следующего открытия позиции
k=i;
	takeprofit[i]=True;//для рисования
	rez_tek=(Position_price-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
												
save_log("TPShort;"+CoverPrice[i]+";"+rez_tek+";"+rez);//Считаем и пишем все в файл

}
//---------------------------------------------------END SHORT - take profit

////////////////////////////////////////////////////Скользящий стоп 

//Определяем прибыль на текущем баре
if (poz==-1) profit=Position_price-Low[i];
if (poz==1) profit=High[i]-Position_price;
//Максимальная прибыль за время существования позиции
if (profit>=profit_max) profit_max=profit;

if (poz==-1 AND Position_price-High[i]<profit_max-ts AND profit_max>profit_ogr )
	{
			 	Cover[i]=True;
				poz=0;
				k=i;
				profit_max=0;
				CoverPrice[i]=High[i];
	}


if (poz==1 AND Position_price-Low[i]<profit_max-ts AND profit_max>profit_ogr)
	{
			 	Sell[i]=True;
				poz=0;
				k=i;
				profit_max=0;
				SellPrice[i]=Low[i];
	}

//////////////////////////////////////////////////Конец Скользящий стоп

/////////////////////////////////////////////////ВЫХОД ДОБАВОЧКА СТОПЫ
if(poz_plus!=0)
{
//--------------------------------------------- SHORT+ - stoploss

	if ((poz_plus==-1 AND Cover[i]==True AND ExitAll==True AND stoploss[i]==True) OR 
	(poz_plus==-1 AND High[i]+0>=Position_price_plus+sl_plus AND ExitAll==False)) 
{
	Cover_plus[i]=True;
	if(ExitALL==True) CoverPrice_plus[i]=CoverPrice[i];//одинаковый выход
	if(ExitALL==False) CoverPrice_plus[i]=Position_price_plus+sl_plus;//разный выход
	poz_plus=0;
//если открытие выше стопа, закрываемся по открытию
	if(Open[i]>Position_price_plus+sl_plus AND ExitAll==False) CoverPrice_plus[i]=Open[i]; //разный выход
	CoverPrice_plus[i]=round(CoverPrice_plus[i]);
	
//Установили бар следующего открытия позиции
k_plus=i;
//
//Open_Short=0;
//Считаем и пишем все в файл
	stoploss_plus[i]=True;//для рисования
	rez_tek=(Position_price_plus-CoverPrice_plus[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
	if(rez<=prosadka) prosadka=rez;
								
	
	save_log("SLShort+;"+CoverPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
}
//--------------------------------------------END SHORT+ - stoploss


//--------------------------------------------LONG+ - stoploss
	if ((poz_plus==1 AND Sell[i]==True AND ExitAll==True AND stoploss[i]==True) OR
	(poz_plus==1 AND Low[i]+0<=Position_price_plus-sl_plus AND ExitAll==False)) 
{
	Sell_plus[i]=True;
	if(ExitALL==True) SellPrice_plus[i]=SellPrice[i];//одинаковый выход
	if(ExitALL==False) SellPrice_plus[i]=Position_price_plus-sl_plus;//разный выход
	poz_plus=0;
//если открытие ниже стопа, выходим на открытии бара
	if(Open[i]<Position_price_plus-sl_plus AND ExitAll==False) SellPrice_plus[i]=Open[i]; //разный выход
	SellPrice_plus[i]=round(SellPrice_plus[i]);
//Установили бар следующего открытия позиции
k_plus=i;
//
//Open_Long=0;

//Считаем и пишем все в файл
	stoploss_plus[i]=True;//для рисования
	rez_tek=(SellPrice_plus[i]-Position_price_plus)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
												

	save_log("SLBuy+;"+SellPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
}
//--------------------------------------------------END LONG+ - stoploss	

//--------------------------------------------------LONG+ - take profit
	if ((poz_plus==1 AND Sell[i]==True AND ExitAll==True AND takeprofit[i]==True)  OR
	(poz_plus==1 AND High[i]>=Position_price_plus+tp_plus AND ExitAll==False)) 
{
	Sell_plus[i]=True;
	if(ExitALL==True) SellPrice_plus[i]=SellPrice[i];//одинаковый выход
	if(ExitALL==False) SellPrice_plus[i]=Position_price_plus+tp_plus;//разный выход
// если открытие выше тэйка, выходим сразу на открытии
	if(Open[i]>Position_price_plus+tp_plus AND ExitAll==False) SellPrice_plus[i]=Open[i];//разный выход
	SellPrice_plus[i]=round(SellPrice_plus[i]);
	poz_plus=0;
//Установили бар следующего открытия позиции
k_plus=i;
//Считаем и пишем все в файл
	takeprofit_plus[i]=True;//для рисования
	rez_tek=(SellPrice_plus[i]-Position_price_plus)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
									
	save_log("TPBuy+;"+SellPrice[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
}
//-------------------------------------------------- END LONG+ - take profit


//---------------------------------------------------SHORT+ - take profit
    if ((poz_plus==-1 AND Cover[i]==True AND ExitAll==True AND takeprofit[i]==True) OR
	(poz_plus==-1 AND Low[i]<=Position_price_plus-tp_plus AND ExitAll==False) ) 
{
	Cover_plus[i]=True;
	if (ExitAll==True) CoverPrice_plus[i]=CoverPrice[i];//одинаковый выход
	if (ExitAll==False) CoverPrice_plus[i]=Position_price_plus-tp_plus;//разный выход
// если открытие ниже тэйка, выходим сразу на открытии
	if (Open[i]<Position_price_plus-tp_plus AND ExitAll==False) CoverPrice_plus[i]=Open[i];
	CoverPrice_plus[i]=round(CoverPrice_plus[i]);
//обнулим позицию в файле 
	poz_plus=0;
//Установили бар следующего открытия позиции
k_plus=i;
//Считаем и пишем все в файл
	takeprofit_plus[i]=True;//для рисования
	rez_tek=(Position_price_plus-CoverPrice_plus[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
													
	save_log("TPShort+;"+CoverPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
}
//---------------------------------------------------END SHORT+ - take profit

////////////////////////////////////////////////////Скользящий стоп +
//Определяем прибыль на текущем баре
if (poz_plus==-1) profit_plus=Position_price_plus-Low[i];
if (poz_plus==1) profit_plus=High[i]-Position_price_plus;
//Максимальная прибыль за время существования позиции
if (profit>=profit_max) profit_max=profit;

if (poz==-1 AND Position_price-High[i]<profit_max-ts AND profit_max>profit_ogr )
	{
			 	Cover[i]=True;
				poz=0;
				k=i;
				profit_max=0;
				CoverPrice[i]=High[i];
	}


if (poz==1 AND Position_price-Low[i]<profit_max-ts AND profit_max>profit_ogr)
	{
			 	Sell[i]=True;
				poz=0;
				k=i;
				profit_max=0;
				SellPrice[i]=Low[i];
	}
//////////////////////////////////////////////////Конец Скользящий стоп +
}
////////////////////////////////////////////////////КОНЕЦ ВЫХОД ДОБАВОЧКА СТОПЫ




//Принимаем решение на вход выход по закрытию бара, поэтому
i=n-1;
if(i<0) i=0;

//---------------------------------------------------Выходим по правилам системы
//---------------------------------------------------SELL 
	if (Exit_long==True AND poz==1 AND High [i]+0>Lline[i]+0 AND Low[i]+0<Lline[i]+0 AND
	EMA_l_fast[i]+0<=EMA_l_NOTfast[i]+0 AND i>k AND EMA_l_fast[i]>0 AND EMA_close[i]<=Lline[i]) 
{
//
	Sell[i]=True;
	SellPrice[i]=Close[i];
	SellPrice[i]=round(SellPrice[i]);
	Sell_flag=i+1;
//
	poz=0;
	k=i;
											
//Считаем и пишем все в файл
	rez_tek=(SellPrice[i]-Position_price)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
save_log("Sell;"+SellPrice[i]+";"+rez_tek+";"+rez);//Считаем и пишем все в файл


//--------------------------------------------------END SELL
}
//--------------------------------------------------COVER
	if (Exit_Short==True AND poz==-1 AND Low[i]<Hline[i] AND High[i]>Hline[i] AND
	EMA_h_fast[i]>=EMA_h_NOTfast[i] AND i>k AND EMA_h_fast[i]>0 AND EMA_close[i]>=Hline[i]) 
{
   Cover[i]=True;
	CoverPrice[i]=Close[i];
	Cover_flag=i+1;		
	poz=0;
	k=i;
		
		CoverPrice[i]=round(CoverPrice[i]);
//Установили бар следующего открытия позиции
											
	
//Считаем и пишем все в файл
	rez_tek=(Position_price-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Cover;"+CoverPrice[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
//---------------------------------------------------END COVER


}

/////////////////////////////////////////////////////ВЫХОД ДОБАВОЧКА ПРАВИЛА СИСТЕМЫ
//---------------------------------------------------Выходим по правилам системы

//---------------------------------------------------SELL+
	if ((ExitAll==True AND Exit_long==True AND poz_plus==1 AND Sell[i]==True) OR
		(poz_plus==1 AND High [i]+0>Lline[i]+0 AND Low[i]+0<Lline[i]+0 AND 
	EMA_l_fast[i]+0<=EMA_l_NOTfast[i]+0  AND EMA_l_fast[i]>0 AND EMA_close[i]<=Lline[i] AND ExitAll==False)) 
{
//
	Sell_plus[i]=True;
	SellPrice_plus[i]=Close[i];
	SellPrice_plus[i]=round(SellPrice_plus[i]);
//
	poz_plus=0;
											
	
//Считаем и пишем все в файл
	rez_tek=(SellPrice_plus[i]-Position_price_plus)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Sell+;"+SellPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
//--------------------------------------------------END SELL+

}
//--------------------------------------------------COVER+
	if ((ExitAll==True AND Exit_short==True AND poz_plus==-1 AND Cover[i]==True ) OR
	(poz_plus==-1 AND Low[i]<Hline[i] AND High[i]>Hline[i] AND
	EMA_h_fast[i]>=EMA_h_NOTfast[i]  AND EMA_h_fast[i]>0 AND EMA_close[i]>=Hline[i] AND ExitAll==False)) 
{
    Cover_plus[i]=True;
	CoverPrice_plus[i]=Close[i];
	poz_plus=0;
	CoverPrice_plus[i]=round(CoverPrice_plus[i]);
//Установили бар следующего открытия позиции
												
//Считаем и пишем все в файл
	rez_tek=(Position_price_plus-CoverPrice_plus[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Cover+;"+CoverPrice_plus[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
//---------------------------------------------------END COVER+
}

///////////////////////////////////КОНЕЦ ВЫХОД ДОБАВОЧКА ПРАВИЛА СИСТЕМЫ////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////// Входим
//----------------------------------------------------------------------LONG
	if (poz_plus==0 AND Open_Long==1 AND Low[i]<Hline[i] AND High[i]>Hline[i]  AND
	poz==0 AND EMA_h_fast[i]>=EMA_h_NOTfast[i] AND i>=sell_flag AND i>=k AND EMAO[i]>=Hline[i] AND ATRopti[i]>=ATRopt2 OR
	Low[i]<Hline[i] AND High[i]>Hline[i]  AND poz==0 AND EMA_h_fast[i]>=EMA_h_NOTfast[i] AND
	i>=sell_flag AND i>=k AND	ATRopti[i]<ATRopt2)
{ 
	Buy[i]=True;
	poz=1;
//сохраним номер бара на котором открыли позицию
	k=i;
	BuyPrice[i]=Close[i];
	BuyPrice[i]=round(BuyPrice[i]);
//обнулил счетчик стопов
stop_short=0;//счетчики стопов
switchSystem = 0;
ATRopt2=SwitchSystem;
Open_Short=1;
//разрешили вход добавки
enter_long_plus=0;
//сохраним цену открытия позиции	
Position_price=BuyPrice[i];
//Посчитали стопы
tp=ATR_12[i]*37;
if (tp<450) tp=tp*ATR_12[i];
sl=ATR_12[i]*10;
if(sl>150)sl=150;
								

//Считаем и пишем все в файл
	save_log("Buy;"+BuyPrice[i]+" tp="+tp);
//Считаем и пишем все в файл
//----------------------------------------------------------------------END LONG
} 




//----------------------------------------------------------------------SHORT
	if( poz_plus==0 AND Open_Short==1 AND (High[i]>Lline[i] AND Lline[i]>Low[i] AND
	poz==0 AND EMA_l_fast[i]<=EMA_l_NOTfast[i] AND i>=cover_flag AND i>=k AND EMAO[i]<=Lline[i] AND ATRopti[i]>=ATRopt2  ) OR 
	(High[i]>Lline[i] AND Lline[i]>Low[i] AND poz==0 AND EMA_l_fast[i]<=EMA_l_NOTfast[i] AND
	i>=cover_flag AND i>=k AND ATRopti[i]<ATRopt2))
{ 
	Short[i]=True;
	poz=-1;
//сохраним номер бара на котором открыли позицию
	k=i;
	ShortPrice[i]=Close[i];
	ShortPrice[i]=round(ShortPrice[i]);
//обнулил счетчик стопов
stop_long=0;//счетчики стопов
Open_Long=1;
switchSystem = 0;
ATRopt2=SwitchSystem;
//разрешили вход добавки
enter_short_plus=0;
//сохраним цену открытия позиции
	Position_price=ShortPrice[i];
//Посчитали стопы
	tp=ATR_12[i]*37;
	if (tp<450) tp=tp*ATR_12[i];
	sl=ATR_12[i]*10;
	if(sl>150)sl=150;
								

//Считаем и пишем все в файл
	save_log("Short;"+ShortPrice[i]+" tp="+tp);
//Считаем и пишем все в файл
//----------------------------------------------------------------------END SHORT
}




if(enter_plus==True) //authorized additive or not
{
//----------------------------------------------------------------------Добавляемся
//if (poz==-1) profit=Position_price-Low[i];
//if (poz==1) profit=High[i]-Position_price;

//----------------------------------------------------------------------SHORT+
if(i>=k_plus AND enter_short_plus<the_number_of_possible_additions AND profit>=profit_optimize AND
 poz_plus==0 AND High[i]>Lline[i] AND Lline[i]>Low[i] AND poz==-1 AND EMA_l_fast[i]<=EMA_l_NOTfast[i] AND
 i>=cover_flag AND EMAO243[i]>Hline[i]) 
{
	Short_plus[i]=True;
	poz_plus=-1;
//Save number for the bar which is open position
	k_plus=i;
	ShortPrice_plus[i]=Close[i];
	ShortPrice_plus[i]=round(ShortPrice_plus[i]);
//запретили вход добавки
enter_short_plus=enter_short_plus+1;
//сохраним цену открытия позиции
	Position_price_plus=ShortPrice_plus[i];
//Посчитали стопы
	tp_plus=ATR_12[i]*37; if(tp_plus<=390); tp_plus=tp_plus*ATR_12[i];
	sl_plus=sl;
//Считаем и пишем все в файл
	save_log("Short+;"+ShortPrice_plus[i]+" tp_plus="+tp_plus);
//Считаем и пишем все в файл
//----------------------------------------------------------------------END SHORT+

}
//----------------------------------------------------------------------LONG+	
if(i>=k_plus AND enter_Long_plus<the_number_of_possible_additions AND profit>=profit_optimize AND
 poz_plus==0 AND Low[i]<Hline[i] AND High[i]>Hline[i]  AND poz==1 AND EMA_h_fast[i]>=EMA_h_NOTfast[i] AND
 i>=sell_flag  AND EMAO243[i]<Hline[i])
{ 
	Buy_plus[i]=True;
	poz_plus=1;
//сохраним номер бара на котором открыли позицию
	k_plus=i;
	BuyPrice_plus[i]=Close[i];
	BuyPrice_plus[i]=round(BuyPrice_plus[i]);
//сохраним цену открытия позиции	
Position_price_plus=BuyPrice_plus[i];
//запретили вход добавки
enter_long_plus=enter_long_plus+1;
//Посчитали стопы
	tp_plus=ATR_12[i]*37; if(tp_plus<=390); tp_plus=tp_plus*ATR_12[i];
	sl_plus=sl;


	
	
//Считаем и пишем все в файл
	save_log("Buy+;"+BuyPrice_plus[i]+" tp_plus="+tp_plus);
//Считаем и пишем все в файл
}
//----------------------------------------------------------------------END LONG+

///////////////////////////До этого вставляем в АТС
}
//---END authorized additive or not



														

}

////////////////////////////////////////////ЭТО КОНЕЦ ЦИКЛА//////////////////////////
/////***************************************************************************** СИСТЕМА ...
/////**************************************************************************
/////********************************************************************
/////**************************************************************
/////*******************************************************






i=i+1;//Прибавили то, что отняли

//ЕСЛИ ОСТАЛАСЬ ПОЗИЦИЯ ОТКРЫТА ПОСЧИТАЕМ ТЕКУЩИЙ РЕЗУЛЬТАТ
if (poz==-1)
{
	//Считаем и пишем все в файл
	CoverPrice[i]=Close[i];
	rez_tek=(Position_price-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Cover;"+CoverPrice[i]+";"+rez_tek+";"+rez);
	//Считаем и пишем все в файл

//Добавочка
if(poz_plus!=0)
{
CoverPrice[i]=Close[i];
	rez_tek=(Position_price_plus-CoverPrice[i])-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Cover+;"+CoverPrice[i]+";"+rez_tek+";"+rez);
}
//Добавочка


}

if (poz==1)
{
//Считаем и пишем все в файл
	SellPrice[i]=Close[i];
	rez_tek=(SellPrice[i]-Position_price)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Sell;"+SellPrice[i]+";"+rez_tek+";"+rez);
//Считаем и пишем все в файл
//Добавочка
if(poz_plus!=0)
{
SellPrice_plus[i]=Close[i];
	rez_tek=(SellPrice_plus[i]-Position_price_plus)-20;//результат в текущей сделки
	rez=rez+rez_tek;//результат всего
if(rez<=prosadka) prosadka=rez;
	save_log("Sell+;"+SellPrice_plus[i]+";"+rez_tek+";"+rez);
}
//Добавочка
}

//ИТОГО
	save_log("*********************TOTAL=;"+rez);
	//-До сюда кидаем на график
	
//Теперь выведим толь результат по символу
rez_simvol= fopen("C:/ami/test/testrez44.txt", "a");
	//fputs(Name()+";"+rez+";"+Oema+";"+bars+";"+fast+";"+NOTfast+";"+nomber+"\n",rez_simvol);
	fputs(Name()+";"+rez+";"+prosadka+";"+ema_exit+";"+profit_no_exit+";"+nomber+"\n",rez_simvol);
	fclose(Lf);
//Дальше концы оптимизационных циклов

}
}
}
//}
//}
